<!DOCTYPE html>
<html lang="pt-BR">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17483604386"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17483604386');
</script>

  <meta charset="UTF-8">
  <title>Ze.EFE Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style-admin.css">

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; background:#F5F0E9; font-family:'Inter',system-ui,sans-serif; color:#1D413A; }

    /* LOGIN */
    #login{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#F5F0E9 0%,#EDE7DF 100%);z-index:9999}
    .login-card{background:#FFF;border-radius:18px;padding:48px 56px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:400px;width:90%;text-align:center}
    .login-card img{width:140px;margin-bottom:28px}
    .login-card h2{font-weight:600;color:#1D413A;margin-bottom:28px;font-size:1.25rem}
    .login-card input{width:100%;padding:10px 12px;margin:6px 0 16px;border:1px solid #CCC;border-radius:8px;font-size:14px;background:#F9F9F8;color:#1D413A}
    .login-card button{width:100%;padding:12px 0;background:#1D413A;color:#F5F0E9;font-weight:600;border:none;border-radius:8px;cursor:pointer}
    .error-message{color:#B00;font-size:14px;margin-top:10px;display:none}
    .remember-line{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#1D413A;margin:-8px 0 16px}
    .remember input[type="checkbox"]{accent-color:#1D413A;width:16px;height:16px;cursor:pointer}
    .remember span{margin-left:6px;cursor:pointer}

    /* APP */
    #app{display:none;height:100vh;width:100vw;overflow:hidden}
    .sidebar{width:240px;background:#1D413A;color:#F5F0E9;display:flex;flex-direction:column;padding:24px 0;overflow-y:auto}
    .sidebar img{width:130px;margin:0 auto 20px}
    .sidebar ul{list-style:none;padding:0;margin:0;flex-grow:1}
    .sidebar ul li{padding:10px 28px;cursor:pointer;font-size:15px}
    .sidebar ul li:hover,.sidebar ul li.active{background:#16332E}
    .sidebar ul li.menu-group{
      cursor:default;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      opacity:.8;
      padding-top:18px;
      padding-bottom:4px;
      border-top:1px solid rgba(245,240,233,.12);
    }
    .sidebar ul li.menu-group:first-of-type{
      border-top:none;
      padding-top:4px;
    }
    .cockpit-columns{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:22px;
      padding:16px 20px 18px;
      width:100%;
      align-items:start;
    }
    .cockpit-group{
      background:#FFF;
      border:1px solid #E0DAD1;
      border-radius:12px;
      padding:10px 10px 8px;
      box-shadow:0 8px 18px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cockpit-group-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#6B5D50;
      margin:0 0 4px;
      font-weight:700;
    }
    .cockpit-links{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cockpit-link{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      border:1px solid #E0DAD1;
      border-radius:10px;
      padding:6px 8px;
      background:#FDFCF9;
    }
    .cockpit-link h4{
      margin:0;
      font-size:12px;
      color:#1D413A;
    }
    .cockpit-link .btn{
      padding:3px 8px;
      font-size:11px;
      min-width: 58px;
    }
    @media (min-width: 1200px){
      .cockpit-columns{ grid-template-columns: repeat(4, minmax(220px, 1fr)); }
    }
    @media (min-width: 900px) and (max-width: 1199px){
      .cockpit-columns{ grid-template-columns: repeat(3, minmax(220px, 1fr)); }
    }
    @media (max-width: 899px){
      .cockpit-columns{ grid-template-columns: repeat(2, minmax(200px, 1fr)); }
    }
    @media (max-width: 640px){
      .cockpit-columns{ grid-template-columns: 1fr; }
    }
    .logout-link{padding:12px 28px;border-top:1px solid rgba(255,255,255,.1);cursor:pointer}

    main.content{flex:1;display:flex;flex-direction:column;background:#F5F0E9;overflow-y:auto}
    .section-header{background:#FFF;padding:16px 24px;border-bottom:1px solid #E0DAD1;display:flex;align-items:center;justify-content:space-between}
    .section-header h2{margin:0;font-size:20px;font-weight:600}
    .search-filters{background:#FFF;padding:12px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #E0DAD1}
    .search-filters input{flex:1;border:1px solid #CCC;border-radius:8px;padding:8px 10px;font-size:14px}
    .column-selector{border:1px solid #CCC;border-radius:8px;padding:6px 10px;background:#F9F9F8}
    .column-selector summary{cursor:pointer;font-size:13px;font-weight:600;color:#1D413A}
    .column-selector-body{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px 12px;max-width:560px}
    .column-option{display:flex;align-items:center;gap:6px;font-size:12px;color:#1D413A}
    .column-selector-actions{display:flex;gap:8px;margin-top:8px}
    .survey-builder-list{display:flex;flex-direction:column;gap:12px;width:100%}
    .survey-branch-preview{background:#FFF;border:1px solid #E0DAD1;border-radius:10px;padding:12px;max-height:70vh;overflow:auto}
    .survey-branch-preview h4{margin:0 0 8px;font-size:14px}
    .survey-branch-preview .empty{font-size:12px;color:#6B5D50}
    .survey-flow-diagram{border:1px solid #EEE4D8;border-radius:8px;padding:10px;background:#FAF8F5;margin-bottom:10px}
    .survey-flow-badge{width:34px;height:34px;border-radius:999px;background:#1D413A;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center}
    .survey-flow-end{width:auto;padding:0 10px;border-radius:999px;background:#EDE7DF;color:#1D413A;font-size:12px;font-weight:700;height:30px;display:flex;align-items:center;justify-content:center}
    .survey-flow-canvas{position:relative;width:100%;height:460px;border:1px solid #E7DCCD;border-radius:10px;background:#FFFDF9;overflow:hidden}
    .survey-flow-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .survey-flow-node{position:absolute;transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;cursor:grab;user-select:none}
    .survey-flow-node:active{cursor:grabbing}
    #surveyFlowModal .modal-content{width:96vw;max-width:1400px;max-height:94vh}
    #surveyFlowModal .modal-body{padding:16px 20px;overflow:hidden;display:flex}
    #surveyFlowPreview{width:100%;height:100%;max-height:none;overflow:hidden;display:flex;flex-direction:column}
    #surveyFlowPreview .survey-flow-diagram{flex:1 1 auto;display:flex;min-height:0}
    #surveyFlowPreview .survey-flow-canvas{flex:1 1 auto;height:calc(100vh - 290px);min-height:520px}
    .survey-flow-branches{display:flex;flex-wrap:wrap;gap:6px}
    .survey-flow-branch-line{border:1px dashed #D7CCBE;border-radius:999px;padding:5px 10px;font-size:13px;font-weight:600;color:#2A4D45;background:#FFFEFC}
    .survey-question-card{overflow:hidden;width:100%}
    @media (max-width: 1024px){
      .survey-branch-preview{max-height:none}
    }
    .survey-question-card{border:1px solid #E0DAD1;border-radius:10px;padding:12px;background:#FFF}
    .survey-question-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap}
    .survey-question-actions{display:flex;gap:8px}
    .survey-question-row{display:flex;gap:10px;flex-wrap:wrap}
    .survey-question-row .field{flex:1;min-width:180px}
    /* Final overrides for survey builder layout/fields */
    .survey-question-card .survey-question-row .field{flex:1 1 calc(50% - 10px) !important;min-width:0 !important}
    .survey-question-card .survey-question-row .survey-question-main-field{flex:1 1 100% !important}
    .survey-question-card .survey-question-row .survey-question-type-field{flex:1 1 100% !important}
    .survey-question-card .survey-question-row .survey-options-fields,
    .survey-question-card .survey-question-row .survey-branch-fields{flex-basis:100% !important}
    .survey-question-row input[type="text"], .survey-question-row input[type="number"], .survey-question-row select, .survey-question-row textarea{width:100%;border:1px solid #CCC;border-radius:8px;padding:8px 10px;font-size:13px}
    .survey-options-area{width:100%;min-height:90px}
    .survey-inline-note{font-size:12px;color:#6B5D50}
    .survey-branch-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .survey-branch-row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .survey-branch-row select{max-width:240px}
.btn{background:#1D413A;color:#F5F0E9;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:14px}
.btn-warning{background:#B54A3A;color:#F5F0E9;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:14px}
.btn-warning:hover{background:#9c3f32}
.btn-secondary{background:#F5F0E9;color:#1D413A;border:1px solid #1D413A;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:14px}
.btn-secondary:hover{background:#E6DED4}
    .table-container{padding:24px}
    table{width:100%;border-collapse:collapse;background:#FFF;border-radius:8px;overflow:hidden}
    thead{background:#EDE7DF;color:#1D413A;font-weight:600}
    th,td{padding:15px 17px;text-align:left;border-bottom:1px solid #EEE}
    .box-message{text-align:center;padding:48px;color:#1D413A}

    /* MODAL */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);justify-content:center;align-items:center;z-index:10000}
    .modal.show{display:flex}
    .modal-content{background:#FFF;border-radius:14px;width:96%;max-width:1180px;max-height:93vh;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.15);display:flex;flex-direction:column}
    .modal-header{position:sticky;top:0;z-index:10;background:#FFF;display:flex;justify-content:space-between;align-items:center;padding:16px 28px;border-bottom:1px solid #eee}
    .modal-header h3{margin:0;font-size:18px;color:#1D413A}
    .modal-close{border:none;background:none;font-size:26px;color:#666;cursor:pointer}
    .modal-body{flex:1;overflow-y:auto;background:#FAF8F5;padding:28px 36px;border-radius:10px}

/* GRID FORM — espaçamento reduzido real */
/* GRID FORM — versão forçada compacta */
.form-grid {
  display: grid !important;
  grid-template-columns: repeat(4, 1fr) !important;
  row-gap: 4px !important;       /* distância vertical mínima */
  column-gap: 10px !important;   /* distância horizontal menor */
  align-items: start !important;
}

.input-readonly {
  background: #EFECE5 !important;
  color: #6d6d6d !important;
}

.form-group {
  display: flex !important;
  flex-direction: column !important;
  margin: 0 !important;
  padding: 0 !important;
}

label {
  font-size: 13px !important;
  font-weight: 500 !important;
  color: #1D413A !important;
  margin-bottom: 2px !important;
}

input, select {
  width: 100% !important;
  padding: 10px 12px !important;   /* altura maior */
  border-radius: 6px !important;
  border: 1px solid #d3d3d3 !important;
  font-size: 15px !important;      /* texto ligeiramente maior */
  background: #fff !important;
  box-sizing: border-box !important;
  line-height: 1.4 !important;
}

/* Pequenos continuam menores */
.sm input, .sm select {
  max-width: 130px !important;
  padding: 8px 10px !important;
  font-size: 14px !important;
}

/* campos pequenos */
.sm input, .sm select {
  max-width: 120px !important;
}

/* Editor rich-text (matérias / workshops) */
.rich-editor {
  min-height: 150px;
  border-radius: 6px;
  border: 1px solid #d3d3d3;
  background: #fff;
  padding: 8px 10px;
  font-size: 14px;
  line-height: 1.4;
  box-sizing: border-box;
}
.rich-editor:focus {
  outline: none;
  border-color: #ABA198;
  box-shadow: 0 0 0 2px #ABA19833, inset 0 1px 2px rgba(0,0,0,0.08);
}
.rich-editor p,
.rich-editor div {
  margin: 0 0 0.75rem;
}
.rich-editor p:last-child,
.rich-editor div:last-child {
  margin-bottom: 0;
}

/* ajusta área interna do modal */
.modal-body {
  flex: 1 !important;
  overflow-y: auto !important;
  background: #FAF8F5 !important;
  padding: 16px 26px !important;
}
/* Quebra/seção entre blocos do formulário do modal */
.form-break {
  grid-column: 1 / -1 !important;
  margin: 8px 0 4px !important;
}

/* campos pequenos */
.sm input,.sm select{max-width:140px}

  /* Corrige largura dos campos de span 4 — linha inteira */
.col-4 {
  grid-column: 1 / -1 !important; /* força ocupar 100% da largura */
}

.col-3 {
  grid-column: span 3 !important;
}

.col-2 {
  grid-column: span 2 !important;
}

.col-1 {
  grid-column: span 1 !important;
}
 
.photo-grid { display:flex; flex-direction:column; gap:8px; }
.photo-preview { display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:8px; }
.photo-preview img { width:100%; height:90px; object-fit:cover; border-radius:6px; border:1px solid #ccc; }
.photo-thumb { position:relative; border-radius:6px; overflow:hidden; }
.photo-thumb button { position:absolute; top:4px; right:4px; border:none; background:rgba(12,12,12,0.6); color:#fff; width:24px; height:24px; border-radius:50%; cursor:pointer; font-size:16px; line-height:20px; padding:0; display:flex; align-items:center; justify-content:center; }
.photo-thumb button:hover { background:rgba(12,12,12,0.85); }
.photo-empty { font-size:13px; color:#666; padding:12px; border:1px dashed #c4c4c4; border-radius:6px; text-align:center; }
.existing-photos { margin-bottom:6px; }
.new-photos { margin-top:6px; }
.field-hidden { display:none !important; }
.email-options-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 10px;
  margin-top: 12px;
}

.modal-reservas .modal-content { max-width: 720px; }
.reservation-list { display:flex; flex-direction:column; gap:10px; }
.reservation-item { padding:12px; border:1px solid #e0d8cd; border-radius:8px; background:#F9F6F1; }
.reservation-item strong { color:#1D413A; }
.reservation-actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.reservation-actions button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; }
.btn-res { background:#1D413A; color:#F5F0E9; }
.btn-res.secondary { background:#b84a3a; }
.btn-res.warning { background:#d97a1c; }
.reservations-empty { padding:12px; color:#666; font-size:14px; border:1px dashed #d0c7bc; border-radius:8px; text-align:center; }

.btn-ghost {
  background: #fff;
  border: 1px solid #1D413A;
  color: #1D413A;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: background 0.2s;
}
.btn-ghost:hover { background: #E6DED4; }

.btn-micro {
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
  color: #fff;
}
.btn-micro.confirm { background: #2F6F55; }
.btn-micro.deny { background: #B54A3A; }
.btn-micro.cancel { background: #D97A1C; }
.reservation-inline {
  display: inline-flex;
  gap: 6px;
  margin-left: 10px;
  vertical-align: middle;
}

.amenities-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:8px; margin-top:4px; }
.checkbox-item { display:flex; align-items:center; font-size:13px; color:#1D413A; }
.checkbox-item input { margin-right:6px; }
.permissions-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:8px; }
.permissions-card { border:1px solid #E0D7CC; border-radius:12px; padding:12px; background:#FAF7F2; }
.permissions-card h5 { margin:0 0 8px 0; color:#1D413A; font-size:14px; }
.permissions-row { display:flex; gap:10px; flex-wrap:wrap; }
.permissions-row label { display:flex; align-items:center; gap:6px; font-size:12px; color:#344B45; }
.permissions-row input { margin:0; }
.field-note { font-size:12px; color:#7A6C5D; margin-top:6px; }

  
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="login">
    <div class="login-card">
      <img src="img/logo.jpg" alt="Ze.EFE Logo">
      <h2>Painel Administrativo<br><span>Ze.EFE</span></h2>
      <form id="loginForm">
        <input type="text" name="username" placeholder="Usuário ou E-mail" required autocomplete="username">
        <input type="password" name="password" placeholder="Senha" required autocomplete="current-password">
        <div class="remember-line">
          <label class="remember">
            <input type="checkbox" name="remember"><span>Lembrar login neste computador</span>
          </label>
        </div>
        <button type="submit">Entrar</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </div>

  
  <!-- APP -->
  <div id="app">
    <div style="display:flex;height:100%">
      <nav class="sidebar">
        <img src="img/logo.jpg" alt="Ze.EFE">
        <ul id="menu">
          <li class="menu-group">Início</li>
          <li data-section="cockpit" class="active">Cockpit</li>
          <li class="menu-group">Portal de Salas</li>
          <li data-section="companies">Empresas</li>
          <li data-section="clients">Clientes</li>
          <li data-section="reservations">Reservas</li>
          <li data-section="visitors">Visitantes</li>
          <li class="menu-group">Anunciantes & Ofertas</li>
          <li data-section="rooms">Salas</li>
          <li data-section="inventory_items">Inventário</li>
          <li data-section="advertisers">Anunciantes</li>
          <li data-section="workshops">Workshops</li>
          <li class="menu-group">Participantes de Workshops</li>
          <li data-section="workshop_participants">Participantes</li>
          <li data-section="workshop_enrollments">Inscrições</li>
          <li class="menu-group">Conteúdo</li>
          <li data-section="posts">Matérias</li>
          <li class="menu-group">Configurações</li>
          <li data-section="amenities">Comodidades</li>
          <li data-section="campaigns">Campanhas</li>
          <li data-section="vouchers">Vouchers</li>
          <li data-section="messages">Mensagens</li>
          <li class="menu-group">Administração</li>
          <li data-section="surveys">Questionários</li>
          <li data-section="admin_profiles">Perfis</li>
          <li data-section="admins">Usuários Admin</li>
        </ul>
        <div class="logout-link" id="logoutBtn">Sair</div>
      </nav>

      <main class="content">
        <div class="section-header"><h2 id="content-title">Cockpit</h2></div>
        <div class="search-filters" id="search-filters"></div>
        <section id="content-body"></section>
      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <form id="modalForm" onsubmit="salvarItem(event)">
        <div class="modal-body">
          <div id="modalBody" class="form-grid"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-warning" id="resetSenhaBtn" style="display:none">Resetar senha</button>
          <button type="button" class="btn-secondary" id="geocodeBtn" style="display:none">Geocodificar</button>
          <button type="button" class="btn-secondary" onclick="fecharModal()">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal modal-reservas" id="reservasModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="reservasModalTitle">Reservas da sala</h3>
        <button class="modal-close" onclick="fecharReservasModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="reservasLista" class="reservation-list">
          <div class="reservations-empty">Selecione uma sala para visualizar as reservas.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharReservasModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="companyClientsModal">
    <div class="modal-content" style="max-width:720px">
      <div class="modal-header">
        <h3 id="companyClientsTitle">Clientes da empresa</h3>
        <button class="modal-close" onclick="fecharCompanyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="companyClientsList" class="reservation-list">
          <div class="reservations-empty">Carregando...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharCompanyModal()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Mensagens (Admin) -->
  <div class="modal" id="adminMessagesModal">
    <div class="modal-content" style="max-width:1180px">
      <div class="modal-header">
        <h3>Mensagens</h3>
        <button class="modal-close" onclick="fecharAdminMessagesModal()">&times;</button>
      </div>
      <div class="modal-body" style="display:flex; gap:16px;">
        <aside style="width:260px; border-right:1px solid #DDD; padding-right:12px; display:flex; flex-direction:column; gap:12px;">
          <div>
            <h4 style="margin:0 0 4px;">Clientes</h4>
            <div id="adminClientThreads" style="max-height:60vh; overflow:auto;"></div>
          </div>
          <div>
            <h4 style="margin:12px 0 4px;">Anunciantes</h4>
            <div id="adminAdvertiserThreads" style="max-height:60vh; overflow:auto;"></div>
          </div>
        </aside>
        <section style="flex:1; display:flex; flex-direction:column; gap:8px;">
          <div id="adminMessagesHeader" class="box-message" style="padding:8px 12px; text-align:left;">Selecione uma conversa à esquerda.</div>
          <div id="adminMessagesList" class="chat-messages" style="flex:1; min-height:280px;"></div>
          <form id="adminMessagesForm" class="chat-form" style="margin-top:8px; display:none;">
            <input type="text" id="adminMessageInput" placeholder="Digite uma mensagem como admin" />
            <button type="submit" class="btn">Enviar</button>
          </form>
        </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharAdminMessagesModal()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Disparo de e-mails de reservas -->
  <div class="modal" id="reservationEmailsModal">
    <div class="modal-content" style="max-width:540px">
      <div class="modal-header">
        <h3 id="reservationEmailsTitle">Disparar e-mails</h3>
        <button class="modal-close" onclick="fecharEmailsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-top:0;font-size:15px;color:#6b5c4f;">
          Selecione o e-mail que deseja reenviar para o cliente ou anunciante.
        </p>
        <div class="email-options-grid">
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('request_client')">Solicitação - Cliente</button>
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('request_advertiser')">Solicitação - Anunciante</button>
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('confirm_client')">Confirmação da reserva</button>
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('payment_confirmed')">Pagamento confirmado</button>
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('payment_failed_client')">Pagamento negado - Cliente</button>
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('payment_failed_advertiser')">Pagamento negado - Anunciante</button>
          <button type="button" class="btn btn-secondary" onclick="dispararEmailReserva('details_after_payment')">Detalhes pós pagamento</button>
        </div>
        <div id="emailModalStatus" class="rooms-message" style="margin-top:16px;display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharEmailsModal()">Fechar</button>
      </div>
    </div>
  </div>
  <!-- Modal: Anunciante da Sala -->
  <div class="modal" id="advertiserModal">
    <div class="modal-content" style="max-width:720px">
      <div class="modal-header">
        <h3 id="advertiserModalTitle">Anunciante da sala</h3>
        <button class="modal-close" onclick="fecharAdvertiserModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="advertiserModalBody" class="form-grid"></div>
        <div id="advertiserModalMsg" class="box-message" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharAdvertiserModal()">Cancelar</button>
        <button type="button" class="btn" onclick="salvarAdvertiserSala()">Salvar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="surveyBuilderModal">
    <div class="modal-content" style="max-width:1200px">
      <div class="modal-header">
        <h3 id="surveyBuilderTitle">Perguntas do questionário</h3>
        <button class="modal-close" onclick="fecharSurveyBuilder()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="survey-builder-main">
          <div class="survey-builder-list" id="surveyBuilderList"></div>
          <div class="box-message" id="surveyBuilderEmpty" style="display:none">Nenhuma pergunta cadastrada.</div>
          <div style="margin-top:12px">
            <button type="button" class="btn-secondary" onclick="adicionarSurveyPergunta()">+ Nova pergunta</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span class="survey-inline-note">Tipos: texto curto, número, múltipla escolha, checkbox e escala.</span>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button type="button" class="btn-secondary" onclick="fecharSurveyBuilder()">Cancelar</button>
          <button type="button" class="btn-secondary" onclick="abrirSurveyFlowModal()">Fluxograma</button>
          <button type="button" class="btn-secondary" onclick="salvarSurveyBuilderLocal()">Salvar</button>
          <button type="button" class="btn-secondary" onclick="atualizarSurveyBuilder()">Atualizar</button>
          <button type="button" class="btn-secondary" onclick="salvarSurveyBuilderBanco()">Salvar no banco</button>
          <button type="button" class="btn" onclick="salvarSurveyBuilderFechar()">Salvar e Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="surveyFlowModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Fluxograma do questionário</h3>
        <button class="modal-close" onclick="fecharSurveyFlowModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="survey-branch-preview" id="surveyFlowPreview">
          <h4>Fluxo (números)</h4>
          <div class="empty">Sem perguntas para exibir.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharSurveyFlowModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="surveyResultsModal">
    <div class="modal-content" style="max-width:1100px">
      <div class="modal-header">
        <h3 id="surveyResultsTitle">Resultados do questionário</h3>
        <button class="modal-close" onclick="fecharSurveyResults()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="surveyResultsBody"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharSurveyResults()">Fechar</button>
        <button type="button" class="btn" onclick="exportarSurveyCSV()">Exportar CSV</button>
      </div>
    </div>
  </div>

  <div class="modal" id="surveyLeadsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="surveyLeadsTitle">Leads do questionário</h3>
        <button type="button" class="close" onclick="fecharSurveyLeads()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="surveyLeadsBody"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" onclick="exportarSurveyLeadsCSV()">Exportar CSV</button>
        <button type="button" class="btn-secondary" onclick="fecharSurveyLeads()">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '../api';
    function showToast(msg) {
      alert(msg);
    }
    let sec = 'companies';
    let dadosJSON = [];
    let itemEdit = null;
    let filtro = '';
    const resetSenhaBtn = document.getElementById('resetSenhaBtn');
    const companyClientsModal = document.getElementById('companyClientsModal');
    const companyClientsTitle = document.getElementById('companyClientsTitle');
    const companyClientsList = document.getElementById('companyClientsList');
    let companyClientsCompanyId = null;

    const statusLabels = {
      ativo: 'Ativo',
      inativo: 'Inativo',
      manutencao: 'Manutenção',
      'manutenção': 'Manutenção',
      desativada: 'Desativada',
      bloqueado: 'Bloqueado',
      pendente: 'Pendente',
      confirmada: 'Confirmada',
      cancelada: 'Cancelada',
      concluida: 'Concluída'
    };

    const modalEntities = {
      companies: 'Empresa',
      clients: 'Cliente',
      advertisers: 'Anunciante',
      rooms: 'Sala',
      reservations: 'Reserva',
      visitors: 'Visitante',
      amenities: 'Comodidade',
      vouchers: 'Voucher',
      campaigns: 'Campanha',
      inventory_items: 'Item de Inventário',
      surveys: 'Questionário',
      workshops: 'Workshop',
      workshop_participants: 'Participante de Workshop',
      workshop_enrollments: 'Inscrição de Workshop',
      admin_profiles: 'Perfil',
      admins: 'Usuário Admin'
    };

    const permissionCatalog = [
      { key: 'companies', label: 'Empresas' },
      { key: 'clients', label: 'Clientes' },
      { key: 'reservations', label: 'Reservas' },
      { key: 'visitors', label: 'Visitantes' },
      { key: 'rooms', label: 'Salas' },
      { key: 'inventory_items', label: 'Inventário' },
      { key: 'advertisers', label: 'Anunciantes' },
      { key: 'workshops', label: 'Workshops' },
      { key: 'workshop_participants', label: 'Participantes' },
      { key: 'workshop_enrollments', label: 'Inscrições' },
      { key: 'posts', label: 'Matérias' },
      { key: 'amenities', label: 'Comodidades' },
      { key: 'campaigns', label: 'Campanhas' },
      { key: 'vouchers', label: 'Vouchers' },
      { key: 'messages', label: 'Mensagens' },
      { key: 'surveys', label: 'Questionários' },
      { key: 'admin_profiles', label: 'Perfis Admin' },
      { key: 'admins', label: 'Usuários Admin' }
    ];

    const ADMIN_REMEMBER_STORAGE = 'zeefeAdminRememberToken';
    const COLUMN_STORAGE_PREFIX = 'zeefeAdminColumns:';
    const inventoryCategoryOptions = [
      'Móveis de escritório',
      'Mesas e estações de trabalho',
      'Cadeiras e assentos',
      'Armários e arquivos',
      'Gaveteiros e estantes',
      'Informática',
      'Computadores e notebooks',
      'Monitores',
      'Periféricos (mouse, teclado, webcam)',
      'Impressão e digitalização',
      'Equipamentos audiovisuais',
      'Projetores e telas',
      'Câmeras',
      'Controles remotos e acessórios',
      'Caixas de som e microfones',
      'Equipamentos de videoconferência',
      'Telefonia e comunicação',
      'Equipamentos de rede',
      'Cabos e adaptadores',
      'Eletroeletrônicos',
      'Equipamentos de climatização',
      'Equipamentos de segurança',
      'Decoração e apoio'
    ];
    const inventoryStatusOptions = ['Em Uso', 'Estoque', 'Manutenção'];
    const inventoryConditionOptions = ['Novo', 'Bom', 'Regular', 'Ruim'];

    function normalizePermissions(raw) {
      if (!raw || typeof raw !== 'object') return {};
      const normalized = {};
      Object.keys(raw).forEach(section => {
        const perm = raw[section] || {};
        normalized[section] = {
          read: !!perm.read,
          create: !!perm.create,
          update: !!perm.update,
          delete: !!perm.delete
        };
      });
      return normalized;
    }

    function can(section, action) {
      if (currentAdminIsMaster) return true;
      const perms = currentAdminPermissions[section];
      if (!perms) return false;
      if (!action) return !!perms.read;
      return !!perms[action];
    }

    function setAdminContext(admin) {
      currentAdmin = admin || null;
      currentAdminIsMaster = !!(admin && admin.is_master);
      let raw = admin?.permissions_json;
      if (typeof raw === 'string') {
        try { raw = JSON.parse(raw); } catch (e) { raw = null; }
      }
      currentAdminPermissions = normalizePermissions(raw);
      applyMenuPermissions();
    }

    function applyMenuPermissions() {
      const menuItems = Array.from(document.querySelectorAll('#menu li[data-section]'));
      menuItems.forEach(li => {
        const section = li.dataset.section;
        if (!section) return;
        li.style.display = can(section, 'read') ? '' : 'none';
      });
    }

    const reservationFilters = {
      room_id: '',
      client_id: '',
      date_range: '',
      date_from: '',
      date_to: ''
    };

    const voucherFilters = {
      status: ''
    };
    const inventoryFilters = {
      categoria: '',
      status: '',
      condicao: ''
    };

    let cachedRooms = null;
    let cachedClients = null;
    let cachedBanks = null;
    let currentAdmin = null;
    let currentAdminPermissions = {};
    let currentAdminIsMaster = false;
    let adminThreadsCache = [];
    let adminActiveThreadId = null;
    const adminMessagesModal = document.getElementById('adminMessagesModal');
    const adminClientThreads = document.getElementById('adminClientThreads');
    const adminAdvertiserThreads = document.getElementById('adminAdvertiserThreads');
    const adminMessagesHeader = document.getElementById('adminMessagesHeader');
    const adminMessagesList = document.getElementById('adminMessagesList');
    const adminMessagesForm = document.getElementById('adminMessagesForm');
    const reservationEmailsModal = document.getElementById('reservationEmailsModal');
    const reservationEmailsTitle = document.getElementById('reservationEmailsTitle');
    const emailModalStatus = document.getElementById('emailModalStatus');
    let reservationEmailTarget = null;
    const adminMessageInput = document.getElementById('adminMessageInput');
    const surveyBuilderModal = document.getElementById('surveyBuilderModal');
    const surveyBuilderList = document.getElementById('surveyBuilderList');
    const surveyBuilderEmpty = document.getElementById('surveyBuilderEmpty');
    const surveyFlowModal = document.getElementById('surveyFlowModal');
    const surveyFlowPreview = document.getElementById('surveyFlowPreview');
    const surveyResultsModal = document.getElementById('surveyResultsModal');
    const surveyResultsBody = document.getElementById('surveyResultsBody');
    const surveyLeadsModal = document.getElementById('surveyLeadsModal');
    const surveyLeadsBody = document.getElementById('surveyLeadsBody');
    let surveyBuilderSurveyId = null;
    let surveyBuilderIsHydrating = false;
    let surveyResultsCache = null;
    let surveyLeadsCache = null;
    const surveyFlowPositions = {};
    const surveyBuilderDraftBySurvey = {};

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function stripHtmlToText(value) {
      const div = document.createElement('div');
      div.innerHTML = String(value ?? '');
      return (div.textContent || div.innerText || '').replace(/\s+/g, ' ').trim();
    }

    function sanitizeSurveyQuestionHtml(value) {
      const template = document.createElement('template');
      template.innerHTML = String(value ?? '');
      const allowedTags = new Set(['B', 'STRONG', 'I', 'EM', 'U', 'BR', 'P', 'DIV', 'UL', 'OL', 'LI', 'A', 'IMG', 'SPAN']);
      const allowedAttrs = {
        A: new Set(['href', 'target', 'rel']),
        IMG: new Set(['src', 'alt', 'title']),
        SPAN: new Set([]),
        P: new Set([]),
        DIV: new Set([]),
        B: new Set([]),
        STRONG: new Set([]),
        I: new Set([]),
        EM: new Set([]),
        U: new Set([]),
        BR: new Set([]),
        UL: new Set([]),
        OL: new Set([]),
        LI: new Set([])
      };
      const cleanUrl = (url, allowDataImage = false) => {
        const raw = String(url || '').trim();
        if (!raw) return '';
        if (/^https?:\/\//i.test(raw)) return raw;
        if (/^mailto:/i.test(raw)) return raw;
        if (/^tel:/i.test(raw)) return raw;
        if (allowDataImage && /^data:image\//i.test(raw)) return raw;
        return '';
      };
      const walk = (node) => {
        Array.from(node.childNodes).forEach((child) => {
          if (child.nodeType === Node.ELEMENT_NODE) {
            const tag = child.tagName.toUpperCase();
            if (!allowedTags.has(tag)) {
              child.replaceWith(...Array.from(child.childNodes));
              return;
            }
            Array.from(child.attributes).forEach((attr) => {
              const attrName = attr.name.toLowerCase();
              const allowed = allowedAttrs[tag] || new Set();
              if (!allowed.has(attr.name)) {
                child.removeAttribute(attr.name);
                return;
              }
              if (attrName.startsWith('on') || attrName === 'style') {
                child.removeAttribute(attr.name);
                return;
              }
              if (tag === 'A' && attrName === 'href') {
                const clean = cleanUrl(attr.value, false);
                if (!clean) child.removeAttribute('href');
                else child.setAttribute('href', clean);
              }
              if (tag === 'A' && attrName === 'target') {
                if (child.getAttribute('target') !== '_blank') child.removeAttribute('target');
              }
              if (tag === 'A' && attrName === 'rel') {
                child.setAttribute('rel', 'noopener noreferrer');
              }
              if (tag === 'IMG' && attrName === 'src') {
                const clean = cleanUrl(attr.value, true);
                if (!clean) child.removeAttribute('src');
                else child.setAttribute('src', clean);
              }
            });
            if (tag === 'A' && child.getAttribute('target') === '_blank') {
              child.setAttribute('rel', 'noopener noreferrer');
            }
            walk(child);
          } else if (child.nodeType === Node.COMMENT_NODE) {
            child.remove();
          }
        });
      };
      walk(template.content);
      return template.innerHTML.trim();
    }

    function surveyQuestionHasContent(value) {
      const html = sanitizeSurveyQuestionHtml(value);
      if (stripHtmlToText(html)) return true;
      return /<img\b/i.test(html);
    }

    async function loadBanksCSV() {
      if (cachedBanks) return cachedBanks;
      try {
        const res = await fetch('/data/banks_bacen.json', { cache: 'no-store' });
        const data = await res.json();
        if (Array.isArray(data) && data.length) {
          cachedBanks = data;
          return cachedBanks;
        }
      } catch (_) {}
      try {
        const res = await fetch('img/Bancos.csv', { cache: 'no-store' });
        const text = await res.text();
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        if (!lines.length) { cachedBanks = []; return cachedBanks; }
        const delim = (lines[0].includes(';') ? ';' : ',');
        const rows = lines.map(l => l.split(delim).map(s => s.trim()));
        let start = 0;
        if (/cod|c(ó|o)digo|code/i.test(rows[0][0])) start = 1;
        cachedBanks = rows.slice(start).map(cols => ({ code: (cols[0]||'').replace(/\D/g,''), name: cols[1]||'' }))
          .filter(b => b.code && b.name);
      } catch (_) { cachedBanks = []; }
      return cachedBanks;
    }

    async function abrirAdminMessages() {
      const modal = adminMessagesModal;
      if (!modal) return;
      adminMessagesHeader.textContent = 'Selecione uma conversa à esquerda.';
      adminMessagesList.innerHTML = '';
      adminMessagesForm.style.display = 'none';
      adminActiveThreadId = null;
      await carregarAdminThreads();
      modal.classList.add('show');
    }

    function fecharAdminMessagesModal() {
      if (!adminMessagesModal) return;
      adminMessagesModal.classList.remove('show');
    }

    async function carregarAdminThreads() {
      try {
        const res = await fetch(API_BASE + '/messages_list_threads.php');
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao carregar conversas.');
        adminThreadsCache = json.data || [];
      } catch (e) {
        adminThreadsCache = [];
      }
      renderAdminThreads();
    }

    function renderAdminThreads() {
      if (!adminClientThreads || !adminAdvertiserThreads) return;
      adminClientThreads.innerHTML = '';
      adminAdvertiserThreads.innerHTML = '';
      const clients = adminThreadsCache.filter(t => t.client_id && !t.advertiser_id);
      const advs = adminThreadsCache.filter(t => t.advertiser_id);

      function criarItem(thread) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chat-thread-item';
        btn.textContent = `Thread #${thread.id} ${thread.reservation_id ? '· Reserva ' + thread.reservation_id : ''}`;
        btn.onclick = () => abrirConversaAdmin(thread.id);
        return btn;
      }
      clients.forEach(t => adminClientThreads.appendChild(criarItem(t)));
      advs.forEach(t => adminAdvertiserThreads.appendChild(criarItem(t)));
    }

    async function abrirConversaAdmin(id) {
      adminActiveThreadId = id;
      adminMessagesHeader.textContent = 'Carregando mensagens...';
      adminMessagesForm.style.display = 'none';
      adminMessagesList.innerHTML = '';
      try {
        const res = await fetch(API_BASE + '/messages_list_messages.php?thread_id=' + encodeURIComponent(id));
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao carregar mensagens.');
        const list = json.data || [];
        if (!list.length) {
          adminMessagesList.innerHTML = '<div class=\"box-message\">Nenhuma mensagem nesta conversa.</div>';
        } else {
          adminMessagesList.innerHTML = list.map(m => {
            const me = (m.sender_type || '') === 'admin';
            return '<div class=\"chat-bubble '+(me?'me':'them')+'\"><div class=\"chat-text\">'+escapeHtml(m.body)+'</div><div class=\"chat-time\">'+escapeHtml((m.created_at||'').toString().slice(0,16).replace('T',' '))+'</div></div>';
          }).join('');
        }
        adminMessagesHeader.textContent = 'Conversa #' + id;
        adminMessagesForm.style.display = 'flex';
      } catch (e) {
        adminMessagesHeader.textContent = e.message || 'Erro ao carregar conversa.';
      }
    }

    async function enviarMensagemAdmin(e) {
      e.preventDefault();
      const txt = (adminMessageInput.value || '').trim();
      if (!txt || !adminActiveThreadId) return;
      try {
        const res = await fetch(API_BASE + '/messages_send.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread_id: adminActiveThreadId, sender_type: 'admin', body: txt })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao enviar.');
        adminMessageInput.value = '';
        await abrirConversaAdmin(adminActiveThreadId);
      } catch (e) {
        alert(e.message || 'Erro ao enviar mensagem.');
      }
    }

    function formatDate(value) {
      if (!value || !/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
      const [y, m, d] = value.split('-');
      return `${d}/${m}/${y}`;
    }

    function formatTime(value) {
      if (!value) return value;
      return value.toString().slice(0, 5);
    }

    function somenteDigitos(value) {
      return (value || '').toString().replace(/\D/g, '');
    }

    function maskCPF(value) {
      const digits = somenteDigitos(value).slice(0, 11);
      if (!digits) return '';
      let masked = digits;
      if (digits.length > 3) masked = `${digits.slice(0, 3)}.${digits.slice(3)}`;
      if (digits.length > 6) masked = `${masked.slice(0, 7)}.${masked.slice(7)}`;
      if (digits.length > 9) masked = `${masked.slice(0, 11)}-${masked.slice(11)}`;
      return masked;
    }

    function formatCPF(value) {
      const digits = somenteDigitos(value);
      if (digits.length !== 11) return value ? maskCPF(value) : '-';
      return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6, 9)}-${digits.slice(9)}`;
    }

    function maskPhone(value) {
      const digits = somenteDigitos(value).slice(0, 11);
      if (!digits) return '';
      const ddd = digits.slice(0, 2);
      const corpo = digits.length > 10 ? digits.slice(2, 7) : digits.slice(2, 6);
      const sufixo = digits.length > 10 ? digits.slice(7) : digits.slice(6);
      return digits.length <= 2
        ? `(${digits}`
        : `(${ddd}) ${corpo}${sufixo ? '-' + sufixo : ''}`;
    }

    function formatPhone(value) {
      const digits = somenteDigitos(value);
      if (!digits) return '-';
      if (digits.length < 10) return maskPhone(value);
      const ddd = digits.slice(0, 2);
      if (digits.length === 10) {
        return `(${ddd}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
      }
      return `(${ddd}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
    }

    function aplicarMascarasPadrao(container) {
      if (!container) return;
      container.querySelectorAll('input[name*="cpf"]').forEach(input => {
        if (input.dataset.maskCpfAttached) return;
        const handler = () => {
          input.value = maskCPF(input.value);
        };
        handler();
        input.addEventListener('input', handler);
        input.dataset.maskCpfAttached = '1';
      });
      container.querySelectorAll('input[name*="phone"], input[name*="telefone"], input[name*="whatsapp"]').forEach(input => {
        if (input.dataset.maskPhoneAttached) return;
        const handler = () => {
          input.value = maskPhone(input.value);
        };
        handler();
        input.addEventListener('input', handler);
        input.dataset.maskPhoneAttached = '1';
      });
    }

    async function resetSenhaAnunciante(email) {
      if (!email) { alert('E-mail do anunciante não encontrado.'); return; }
      if (!confirm(`Gerar e enviar nova senha temporária para ${email}?`)) return;
      try {
        const res = await fetch(`${API_BASE}/advertiser_reset_password.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao resetar.');
        alert(json.message || 'Senha temporária enviada por e-mail.');
      } catch (e) { alert(e.message || 'Erro ao resetar senha.'); }
    }

    let clientesDetalhadosCache = null;

    async function obterClientesDetalhados() {
      if (clientesDetalhadosCache) return clientesDetalhadosCache;
      try {
        const res = await fetch(`${API_BASE}/apiget.php?table=clients`, { credentials: 'include' });
        const json = await res.json();
        clientesDetalhadosCache = json.success ? (json.data || []) : [];
      } catch (err) {
        console.error(err);
        clientesDetalhadosCache = [];
      }
      return clientesDetalhadosCache;
    }

    async function configurarVisitanteEmpresa(container) {
      const clientSelect = container.querySelector('select[name="client_id"]');
      const companySelect = container.querySelector('select[name="company_id"]');
      if (!clientSelect || !companySelect) return;
      companySelect.title = 'Empresa vinculada ao cliente selecionado (definição automática).';

      const clientes = await obterClientesDetalhados();

      const aplicar = () => {
        const selecionado = clientes.find(c => String(c.id) === clientSelect.value);
        if (selecionado && selecionado.company_id) {
          companySelect.value = selecionado.company_id;
          companySelect.disabled = true;
        } else {
          companySelect.value = '';
          companySelect.disabled = true;
        }
      };

      aplicar();
      clientSelect.addEventListener('change', aplicar);
    }

    function recordToSearchString(record) {
      if (!record || typeof record !== 'object') return String(record ?? '');
      return Object.values(record).map(v => {
        if (Array.isArray(v)) return v.join(' ');
        if (v && typeof v === 'object') return recordToSearchString(v);
        return v ?? '';
      }).join(' ');
    }

    function statusFormatter(value) {
      if (!value && value !== 0) return '-';
      return escapeHtml(statusLabels[value] || value);
    }

    function dateFormatter(value) {
      if (!value) return '-';
      return escapeHtml(formatDate(value));
    }

    function timeFormatter(value) {
      if (!value) return '-';
      return escapeHtml(formatTime(value));
    }

    function defaultFormatter(value, key) {
      if (value === null || value === undefined || value === '') return '-';
      if (Array.isArray(value)) return escapeHtml(value.join(', '));
      if (typeof value === 'object') return escapeHtml(recordToSearchString(value));
      if ((key === 'status' || key.endsWith('_status')) && statusLabels[value]) {
        return escapeHtml(statusLabels[value]);
      }
      if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value) && key.toLowerCase().includes('date')) {
        return escapeHtml(formatDate(value));
      }
      if (typeof value === 'string' && key.toLowerCase().includes('time')) {
        return escapeHtml(formatTime(value));
      }
      if (/cpf/i.test(key)) {
        return escapeHtml(formatCPF(value));
      }
      if (/(phone|telefone|whatsapp)/i.test(key)) {
        return escapeHtml(formatPhone(value));
      }
      if (key === 'facilitated_access') {
        return escapeHtml(Number(value) ? 'Sim' : 'Não');
      }
      return escapeHtml(value);
    }

    function friendlyLabel(key) {
      if (!key) return '';
      return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function dateTimeFormatter(value) {
      if (!value) return '';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return escapeHtml(String(value));
      return d.toLocaleString('pt-BR');
    }

    function getStoredColumns(section) {
      try {
        const raw = localStorage.getItem(COLUMN_STORAGE_PREFIX + section);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : null;
      } catch (e) {
        return null;
      }
    }

    function setStoredColumns(section, keys) {
      localStorage.setItem(COLUMN_STORAGE_PREFIX + section, JSON.stringify(keys));
    }

    function buildColumnList(section, rows) {
      const configCols = sectionConfigs[section]?.columns || [];
      const map = {};
      configCols.forEach(col => { map[col.key] = col; });
      const keySet = new Set();
      (rows || []).forEach(row => {
        Object.keys(row || {}).forEach(key => keySet.add(key));
      });
      const ordered = [];
      configCols.forEach(col => {
        if (keySet.has(col.key)) {
          ordered.push(col.key);
          keySet.delete(col.key);
        }
      });
      Array.from(keySet).sort().forEach(key => ordered.push(key));
      return ordered.map(key => map[key] ? map[key] : { key, label: friendlyLabel(key) });
    }

    function resetColumnSelection(section, mode) {
      const rows = Array.isArray(dadosJSON) ? dadosJSON : [];
      const allColumns = buildColumnList(section, rows);
      let keys = [];
      if (mode === 'all') {
        keys = allColumns.map(col => col.key);
      } else {
        const defaults = sectionConfigs[section]?.columns;
        keys = (defaults && defaults.length)
          ? defaults.map(col => col.key)
          : allColumns.map(col => col.key);
      }
      setStoredColumns(section, keys);
      renderFilters(section);
      renderTable();
    }

    function toggleColumnSelection(section, key, checked) {
      const rows = Array.isArray(dadosJSON) ? dadosJSON : [];
      const allColumns = buildColumnList(section, rows);
      const fallback = (sectionConfigs[section]?.columns || allColumns).map(col => col.key);
      let keys = getStoredColumns(section) || fallback.slice();
      if (checked) {
        if (!keys.includes(key)) keys.push(key);
      } else {
        keys = keys.filter(k => k !== key);
      }
      setStoredColumns(section, keys);
      renderTable();
    }

    const sectionConfigs = {
      companies: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'razao_social', label: 'Razão Social' },
          { key: 'nome_fantasia', label: 'Nome Fantasia' },
          { key: 'cnpj', label: 'CNPJ' },
          { key: 'discount_pct', label: 'Desconto (%)' },
          { key: 'account_manager_id', label: 'Gerente (ID)' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      clients: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Nome' },
          { key: 'email', label: 'E-mail' },
          { key: 'cpf', label: 'CPF' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      advertisers: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'display_name', label: 'Nome Público' },
          { key: 'owner_type', label: 'Tipo' },
          { key: 'owner_id', label: 'Dono (ID)' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      rooms: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Sala' },
          { key: 'location', label: 'Localização' },
          { key: 'responsavel_nome', label: 'Responsável' },
          { key: 'capacity', label: 'Capacidade' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      inventory_items: {
        columns: [
          { key: 'id_patrimonio', label: 'ID Patrimônio' },
          { key: 'descricao', label: 'Descrição' },
          { key: 'valor_aquisicao', label: 'Valor aquisição' },
          { key: 'responsavel', label: 'Responsável' }
        ]
      },
      surveys: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'responses_count', label: 'Respostas' },
          { key: 'public_link', label: 'Link público' }
        ]
      },
      reservations: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'room_name', label: 'Sala' },
          { key: 'client_name', label: 'Cliente' },
          { key: 'date', label: 'Data', formatter: dateFormatter },
          { key: 'time_start', label: 'Hora Início', formatter: timeFormatter },
          { key: 'time_end', label: 'Hora Fim', formatter: timeFormatter },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      visitors: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Visitante' },
          { key: 'client_name', label: 'Cliente' },
          { key: 'company_name', label: 'Empresa' },
          { key: 'cpf', label: 'CPF' },
          { key: 'phone', label: 'Telefone' },
          { key: 'whatsapp', label: 'WhatsApp' },
          { key: 'email', label: 'E-mail' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      amenities: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Comodidade' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      campaigns: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Campanha' },
          { key: 'type', label: 'Tipo' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      vouchers: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'code', label: 'Código' },
          { key: 'type', label: 'Tipo' },
          { key: 'value', label: 'Valor' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'used_count', label: 'Usos' },
          { key: 'starts_at', label: 'Início', formatter: dateFormatter },
          { key: 'ends_at', label: 'Fim', formatter: dateFormatter }
        ]
      },
      workshops: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'advertiser_id', label: 'Anunciante (ID)' },
          { key: 'room_id', label: 'Sala (ID)' },
          { key: 'date', label: 'Data inicial', formatter: dateFormatter },
          { key: 'end_date', label: 'Data final', formatter: dateFormatter },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      workshop_participants: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Nome' },
          { key: 'email', label: 'E-mail' },
          { key: 'cpf', label: 'CPF' },
          { key: 'phone', label: 'Telefone' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'created_at', label: 'Criado em', formatter: dateFormatter }
        ]
      },
      workshop_enrollments: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'workshop_id', label: 'Workshop (ID)' },
          { key: 'participant_id', label: 'Participante (ID)' },
          { key: 'payment_status', label: 'Pagamento', formatter: statusFormatter },
          { key: 'checkin_status', label: 'Check-in', formatter: statusFormatter },
          { key: 'public_code', label: 'Código público' },
          { key: 'created_at', label: 'Criado em', formatter: dateFormatter }
        ]
      },
      posts: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'summary', label: 'Resumo' },
          { key: 'category_name', label: 'Categoria' },
          { key: 'views_count', label: 'Visualizações' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'published_at', label: 'Publicado em', formatter: dateTimeFormatter }
        ]
      },
      admin_profiles: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Perfil' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      admins: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Nome' },
          { key: 'username', label: 'Usuário' },
          { key: 'email', label: 'E-mail' },
          { key: 'profile_name', label: 'Perfil' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'is_master', label: 'Master', formatter: value => Number(value) ? 'Sim' : 'Não' }
        ]
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
      const loginDiv = document.getElementById('login');
      const appDiv = document.getElementById('app');
      const errorDiv = document.getElementById('loginError');
      const getRememberToken = () => {
        try {
          const raw = localStorage.getItem(ADMIN_REMEMBER_STORAGE);
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (parsed && parsed.token) return parsed;
        } catch (e) {
          localStorage.removeItem(ADMIN_REMEMBER_STORAGE);
        }
        return null;
      };

      const saveRememberToken = (token, username) => {
        if (!token) return;
        localStorage.setItem(ADMIN_REMEMBER_STORAGE, JSON.stringify({
          token,
          username: username || '',
          saved_at: new Date().toISOString()
        }));
      };

      const clearRememberToken = () => localStorage.removeItem(ADMIN_REMEMBER_STORAGE);

      const savedUser = localStorage.getItem('zeefeRememberUser');
      if (savedUser) {
        form.username.value = savedUser;
        form.remember.checked = true;
      }

      const tryAutoLogin = async () => {
        const remembered = getRememberToken();
        if (!remembered || !remembered.token) return false;
        try {
          const res = await fetch(`${API_BASE}/admin_auto_login.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ token: remembered.token })
          });
          const data = await res.json();
          if (data.success && data.admin) {
            setAdminContext(data.admin);
            loginDiv.style.display = 'none';
            appDiv.style.display = 'flex';
            loadSection('cockpit');
            return true;
          }
        } catch (err) {
          console.error(err);
        }
        clearRememberToken();
        return false;
      };

      tryAutoLogin();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorDiv.style.display = 'none';
        const username = form.username.value.trim();
        const password = form.password.value.trim();
        if (!username || !password) {
          errorDiv.textContent = 'Preencha usuário e senha.';
          errorDiv.style.display = 'block';
          return;
        }
        if (form.remember.checked) localStorage.setItem('zeefeRememberUser', username);
        else localStorage.removeItem('zeefeRememberUser');
        try {
          const res = await fetch(`${API_BASE}/apilogin.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password, remember: !!form.remember.checked })
          });
          const data = await res.json();
          if (data.success) {
            if (form.remember.checked && data.remember && data.remember.token) {
              saveRememberToken(data.remember.token, username);
            } else {
              clearRememberToken();
            }
            setAdminContext(data.admin || null);
            loginDiv.style.display = 'none';
            appDiv.style.display = 'flex';
            loadSection('cockpit');
          } else {
            errorDiv.textContent = data.error || 'Usuário ou senha inválidos.';
            errorDiv.style.display = 'block';
          }
        } catch (err) {
          console.error(err);
          errorDiv.textContent = 'Erro ao conectar ao servidor.';
          errorDiv.style.display = 'block';
        }
      });
    });

    document.querySelectorAll('#menu li').forEach(li => {
      li.addEventListener('click', () => {
        const section = li.dataset.section;
        if (!section) return; // ignora itens de grupo
        document.querySelectorAll('#menu li').forEach(x => x.classList.remove('active'));
        li.classList.add('active');
        sec = section;
        document.getElementById('content-title').textContent = li.textContent;
        if (sec === 'messages') {
          abrirAdminMessages();
        } else {
          loadSection(sec);
        }
      });
    });

    document.getElementById('logoutBtn').onclick = async () => {
      try {
        localStorage.removeItem(ADMIN_REMEMBER_STORAGE);
        await fetch(`${API_BASE}/apilogout.php`, { credentials: 'include' });
      } catch (e) {
        // ignora falhas de logout remoto
      }
      location.reload();
    };

    if (adminMessagesForm) {
      adminMessagesForm.addEventListener('submit', enviarMensagemAdmin);
    }

    async function loadSection(section) {
      sec = section;
      const filters = document.getElementById('search-filters');
      if (filters) {
        filters.style.display = section === 'cockpit' ? 'none' : 'flex';
      }
      if (section !== 'cockpit' && !can(section, 'read')) {
        const body = document.getElementById('content-body');
        if (body) {
          body.innerHTML = '<div class="box-message">Você não tem permissão para acessar esta seção.</div>';
        }
        return;
      }
      if (section === 'cockpit') {
        renderCockpit();
        return;
      }
      if (section === 'rooms') cachedRooms = null;
      if (section === 'clients') {
        cachedClients = null;
        clientesDetalhadosCache = null;
      }
      filtro = '';
      fecharReservasModal();
      const body = document.getElementById('content-body');
      body.innerHTML = '<div class="box-message">Carregando...</div>';

      let url = `${API_BASE}/apiget.php?table=${section}`;
      if (section === 'reservations') {
        const params = new URLSearchParams();
        if (reservationFilters.room_id) params.set('room_id', reservationFilters.room_id);
        if (reservationFilters.client_id) params.set('client_id', reservationFilters.client_id);
        if (reservationFilters.date_range) params.set('date_range', reservationFilters.date_range);
        if (reservationFilters.date_range === 'custom') {
          if (reservationFilters.date_from) params.set('date_from', reservationFilters.date_from);
          if (reservationFilters.date_to) params.set('date_to', reservationFilters.date_to);
        }
        if (params.toString()) url += `&${params.toString()}`;
      }

      try {
        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        if (!data.success) {
          body.innerHTML = `<div class="box-message">Erro: ${escapeHtml(data.error || 'Falha ao carregar os dados.')}</div>`;
          dadosJSON = [];
        } else {
          dadosJSON = data.data || [];
          renderTable();
        }
      } catch (err) {
        console.error(err);
        body.innerHTML = `<div class="box-message">Erro ao carregar ${escapeHtml(section)}.</div>`;
        dadosJSON = [];
      }

      await renderFilters(section);
    }

    function renderCockpit() {
      const body = document.getElementById('content-body');
      if (!body) return;
      const groups = [
        {
          label: 'Portal de Salas',
          items: [
            { id: 'companies', title: 'Empresas', desc: 'Cadastro e gestão de empresas clientes.' },
            { id: 'clients', title: 'Clientes', desc: 'Usuários finais e dados de contato.' },
            { id: 'reservations', title: 'Reservas', desc: 'Todas as reservas ativas e históricas.' },
            { id: 'visitors', title: 'Visitantes', desc: 'Lista de visitantes associados.' }
          ]
        },
        {
          label: 'Anunciantes & Ofertas',
          items: [
            { id: 'rooms', title: 'Salas', desc: 'Inventário e disponibilidade de salas.' },
            { id: 'advertisers', title: 'Anunciantes', desc: 'Gestão de anunciantes e taxas.' },
            { id: 'workshops', title: 'Workshops', desc: 'Eventos e cursos publicados.' }
          ]
        },
        {
          label: 'Participantes de Workshops',
          items: [
            { id: 'workshop_participants', title: 'Participantes', desc: 'Participantes cadastrados no evento.' },
            { id: 'workshop_enrollments', title: 'Inscrições', desc: 'Inscrições e pagamentos de workshops.' }
          ]
        },
        {
          label: 'Conteúdo',
          items: [
            { id: 'posts', title: 'Matérias', desc: 'Conteúdos do blog e notícias.' }
          ]
        },
        {
          label: 'Configurações',
          items: [
            { id: 'amenities', title: 'Comodidades', desc: 'Itens de comodidade disponíveis.' },
            { id: 'campaigns', title: 'Campanhas', desc: 'Campanhas e promoções.' },
            { id: 'vouchers', title: 'Vouchers', desc: 'Cupons e descontos.' },
            { id: 'messages', title: 'Mensagens', desc: 'Central de mensagens e suporte.' }
          ]
        },
        {
          label: 'Administração',
          items: [
            { id: 'inventory_items', title: 'Inventário', desc: 'Gestão de bens e patrimônio.' },
            { id: 'surveys', title: 'Questionários', desc: 'Criação e coleta de pesquisas.' },
            { id: 'admin_profiles', title: 'Perfis', desc: 'Permissões e acessos por perfil.' },
            { id: 'admins', title: 'Usuários Admin', desc: 'Gestão de usuários administrativos.' }
          ]
        }
      ];
      const visibleGroups = groups.map(group => {
        const items = group.items.filter(item => can(item.id, 'read'));
        return { ...group, items };
      }).filter(group => group.items.length);

      body.innerHTML = `
        <div class="cockpit-columns">
          ${visibleGroups.map(group => `
            <div class="cockpit-group">
              <div class="cockpit-group-title">${escapeHtml(group.label)}</div>
              <div class="cockpit-links">
                ${group.items.map(item => `
                  <div class="cockpit-link">
                    <h4>${escapeHtml(item.title)}</h4>
                    <button class="btn btn-secondary" type="button" data-cockpit="${item.id}">Abrir</button>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      body.querySelectorAll('[data-cockpit]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-cockpit');
          if (!target) return;
          const li = document.querySelector(`#menu li[data-section="${target}"]`);
          if (li) {
            document.querySelectorAll('#menu li').forEach(x => x.classList.remove('active'));
            li.classList.add('active');
            document.getElementById('content-title').textContent = li.textContent;
          }
          if (target === 'messages') {
            abrirAdminMessages();
          } else {
            loadSection(target);
          }
        });
      });
    }

    function buscar(valor) {
      filtro = (valor || '').toLowerCase();
      renderTable();
    }

    function renderTable() {
      let linhas = Array.isArray(dadosJSON) ? [...dadosJSON] : [];
      if (filtro) {
        linhas = linhas.filter(reg => recordToSearchString(reg).toLowerCase().includes(filtro));
      }
      if (sec === 'inventory_items') {
        if (inventoryFilters.categoria) {
          linhas = linhas.filter(item => String(item.categoria || '') === inventoryFilters.categoria);
        }
        if (inventoryFilters.status) {
          linhas = linhas.filter(item => String(item.status || '') === inventoryFilters.status);
        }
        if (inventoryFilters.condicao) {
          linhas = linhas.filter(item => String(item.condicao || '') === inventoryFilters.condicao);
        }
      }
      if (sec === 'vouchers' && voucherFilters.status) {
        const st = voucherFilters.status.toLowerCase();
        linhas = linhas.filter(v => {
          const vs = String(v.status || '').toLowerCase();
          if (st === 'expirado') return isVoucherExpirado(v);
          return vs === st;
        });
      }
      const body = document.getElementById('content-body');
      if (!linhas.length) {
        body.innerHTML = '<div class="box-message">Nenhum registro encontrado</div>';
        return;
      }

      const config = sectionConfigs[sec] || {};
      const allColumns = buildColumnList(sec, linhas);
      let columns = (config.columns && config.columns.length)
        ? config.columns
        : allColumns;
      const storedColumns = getStoredColumns(sec);
      if (storedColumns && storedColumns.length) {
        const mapped = storedColumns.map(key => allColumns.find(col => col.key === key)).filter(Boolean);
        columns = mapped.length ? mapped : columns;
      }

      let resumo = '';
      if (sec === 'vouchers') {
        const tot = linhas.length;
        const ativos = linhas.filter(v => !isVoucherExpirado(v) && String(v.status||'').toLowerCase()==='ativo').length;
        const inativos = linhas.filter(v => String(v.status||'').toLowerCase()==='inativo').length;
        const expirados = linhas.filter(v => isVoucherExpirado(v)).length;
        const usos = linhas.reduce((acc,v)=> acc + (Number(v.used_count)||0), 0);
        resumo = `<div class=\"box-message\" style=\"text-align:left\"><strong>Resumo:</strong> Total: ${tot} · Ativos: ${ativos} · Inativos: ${inativos} · Expirados: ${expirados} · Usos acumulados: ${usos}</div>`;
      }

      let html = resumo + '<div class="table-container"><table><thead><tr>';
      columns.forEach(col => { html += `<th>${escapeHtml(col.label)}</th>`; });
      html += '<th>Ações</th></tr></thead><tbody>';

      linhas.forEach(row => {
        const rowId = Number(row.id) || 0;
        html += '<tr>';
        columns.forEach(col => {
          const raw = row[col.key];
          const formatted = typeof col.formatter === 'function'
            ? col.formatter(raw, row)
            : defaultFormatter(raw, col.key, row);
          html += `<td>${formatted}</td>`;
        });

        const actionButtons = [];
        const canUpdate = can(sec, 'update');
        const canDelete = can(sec, 'delete');
        if (sec === 'rooms' && canUpdate) {
          actionButtons.push(`<button class="btn-ghost" onclick="abrirChamadaReservas(${rowId})">Reservas</button>`);
          actionButtons.push(`<button class="btn-ghost" onclick="abrirAnuncianteSala(${rowId})">Anunciante</button>`);
        }
        if (sec === 'surveys' && canUpdate) {
          actionButtons.push(`<button class="btn-ghost" onclick="abrirSurveyBuilder(${rowId})">Perguntas</button>`);
          actionButtons.push(`<button class="btn-ghost" onclick="abrirSurveyResults(${rowId})">Resultados</button>`);
          actionButtons.push(`<button class="btn-ghost" onclick="abrirSurveyLeads(${rowId})">Leads</button>`);
          const link = row.public_link || '';
          actionButtons.push(`<button class="btn" onclick="copiarLinkSurvey('${escapeHtml(link).replace(/'/g, "\\'")}')">Copiar Link</button>`);
        }
        if (sec === 'companies' && canUpdate) {
          const nomeEmpresa = escapeHtml(row.nome_fantasia || row.razao_social || `Empresa #${rowId}`).replace(/'/g, "\\'");
          actionButtons.push(`<button class="btn-ghost" onclick="listarClientesEmpresa(${rowId}, '${nomeEmpresa}')">Clientes</button>`);
        }
        if (sec === 'reservations' && canUpdate) {
          actionButtons.push(`<button class="btn-ghost" onclick="abrirEmailsModal(${rowId})">E-mails</button>`);
        }
        if (canUpdate) {
          actionButtons.push(`<button class="btn" onclick="abrirModalEdit(${rowId})">Editar</button>`);
        }
        if (sec === 'inventory_items' && canUpdate) {
          const link = row.link_qr || '';
          actionButtons.push(`<button class="btn" onclick="copiarLinkInventario('${escapeHtml(link).replace(/'/g, "\\'")}')">Copiar Link</button>`);
        }
        if (canDelete) {
          const isMasterRow = sec === 'admins' && Number(row.is_master) === 1;
          if (!isMasterRow) {
            actionButtons.push(`<button class="btn" onclick="abrirModalExcluir(${rowId})">Excluir</button>`);
          }
        }
        if (sec === 'clients' && canDelete) {
          actionButtons.push(`<button class="btn danger" onclick="excluirTotalCliente(${rowId})">ETR</button>`);
        }

        let extraControls = '';
        if (sec === 'reservations' && canUpdate) {
          const inline = [];
          const rowRoomId = row.room_id || row.roomId || row.room || null;
          const roomArg = rowRoomId ? rowRoomId : 'null';
          if (row.status === 'pendente') {
            inline.push(`<button class="btn-micro confirm" onclick="alterarStatusReserva(${rowId}, 'confirm', ${roomArg})">Confirmar</button>`);
            inline.push(`<button class="btn-micro deny" onclick="alterarStatusReserva(${rowId}, 'deny', ${roomArg})">Negar</button>`);
          } else if (row.status === 'confirmada') {
            inline.push(`<button class="btn-micro cancel" onclick="alterarStatusReserva(${rowId}, 'cancel', ${roomArg})">Cancelar</button>`);
          }
          if (inline.length) {
            extraControls = `<div class="reservation-inline">${inline.join(' ')}</div>`;
          }
        }

        html += `<td class="actions">${actionButtons.join(' ')}${extraControls}</td></tr>`;
      });

      html += '</tbody></table></div>';
      body.innerHTML = html;
    }

    function isVoucherExpirado(v) {
      const end = v.ends_at || v.valid_to || v.valid_until || v.expires_at;
      if (!end) return false;
      const d = new Date(end);
      if (isNaN(d.getTime())) return false;
      const today = new Date();
      return d < today;
    }

    function exportarCSV() {
      const rows = Array.isArray(dadosJSON) ? [...dadosJSON] : [];
      if (!rows.length) { alert('Nada para exportar'); return; }
      const allColumns = buildColumnList(sec, rows);
      const storedColumns = getStoredColumns(sec);
      let cols = storedColumns && storedColumns.length
        ? storedColumns.filter(key => allColumns.some(col => col.key === key))
        : (sectionConfigs[sec]?.columns || allColumns).map(c => c.key);
      const esc = s => '"' + String(s==null?'':s).replace(/"/g,'""') + '"';
      const header = cols.join(',');
      const lines = rows.map(r => cols.map(k => esc(r[k])).join(','));
      const csv = [header].concat(lines).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${sec}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    async function copiarLinkInventario(link) {
      if (!link) {
        showToast('Link indisponível.');
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(link);
        } else {
          const temp = document.createElement('textarea');
          temp.value = link;
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.focus();
          temp.select();
          document.execCommand('copy');
          document.body.removeChild(temp);
        }
        showToast('Link copiado.');
      } catch (err) {
        showToast('Não foi possível copiar o link.');
      }
    }

    async function copiarLinkSurvey(link) {
      if (!link) {
        showToast('Link indisponível.');
        return;
      }
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(link);
        } else {
          const temp = document.createElement('textarea');
          temp.value = link;
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.focus();
          temp.select();
          document.execCommand('copy');
          document.body.removeChild(temp);
        }
        showToast('Link copiado.');
      } catch (err) {
        showToast('Não foi possível copiar o link.');
      }
    }

    function abrirSurveyBuilder(id) {
      if (!id) {
        alert('Salve o questionário antes de adicionar perguntas.');
        return;
      }
      surveyBuilderSurveyId = id;
      surveyBuilderList.innerHTML = '';
      surveyBuilderEmpty.style.display = 'none';
      document.getElementById('surveyBuilderTitle').textContent = `Perguntas do questionário #${id}`;
      surveyBuilderModal.classList.add('show');
      carregarSurveyBuilder();
    }

    function fecharSurveyBuilder() {
      surveyBuilderModal.classList.remove('show');
      surveyBuilderSurveyId = null;
      surveyBuilderList.innerHTML = '';
      surveyBuilderEmpty.style.display = 'none';
      if (surveyFlowPreview) {
        surveyFlowPreview.innerHTML = '<h4>Fluxo (números)</h4><div class="empty">Sem perguntas para exibir.</div>';
      }
    }

    function abrirSurveyFlowModal() {
      renderSurveyBranchPreview();
      surveyFlowModal.classList.add('show');
    }

    function fecharSurveyFlowModal() {
      surveyFlowModal.classList.remove('show');
    }

    async function carregarSurveyBuilder() {
      if (!surveyBuilderSurveyId) return;
      try {
        const url = `${API_BASE}/survey_builder.php?survey_id=${surveyBuilderSurveyId}&_ts=${Date.now()}`;
        const res = await fetch(url, { credentials: 'include', cache: 'no-store' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Falha ao carregar perguntas.');
        renderSurveyBuilder(data.questions || []);
      } catch (err) {
        console.error(err);
        surveyBuilderList.innerHTML = '<div class="box-message">Erro ao carregar perguntas.</div>';
      }
    }

    function renderSurveyBuilder(questions) {
      surveyBuilderList.innerHTML = '';
      if (!questions.length) {
        surveyBuilderEmpty.style.display = 'block';
        renderSurveyBranchPreview();
        return;
      }
      surveyBuilderEmpty.style.display = 'none';
      surveyBuilderIsHydrating = true;
      try {
        questions.forEach(q => {
          const card = criarSurveyQuestionCard(q);
          surveyBuilderList.appendChild(card);
        });
      } finally {
        surveyBuilderIsHydrating = false;
      }
      atualizarTitulosPerguntas();
      atualizarSurveyBranchUIAll();
      renderSurveyBranchPreview();
    }

    function criarSurveyQuestionCard(question) {
      const q = question || {};
      const card = document.createElement('div');
      card.className = 'survey-question-card';
      if (q.id) card.dataset.id = q.id;

      const header = document.createElement('div');
      header.className = 'survey-question-header';
      header.innerHTML = `<strong class="survey-question-title">Pergunta</strong>`;

      const actions = document.createElement('div');
      actions.className = 'survey-question-actions';
      actions.innerHTML = `
        <button type="button" class="btn-secondary" data-action="up">↑</button>
        <button type="button" class="btn-secondary" data-action="down">↓</button>
        <button type="button" class="btn-warning" data-action="remove">Remover</button>
      `;
      header.appendChild(actions);

      const row = document.createElement('div');
      row.className = 'survey-question-row';

      const questionField = document.createElement('div');
      questionField.className = 'field survey-question-main-field';
      questionField.innerHTML = `<label>Pergunta</label>`;
      const editorToolbar = document.createElement('div');
      editorToolbar.className = 'editor-toolbar';
      editorToolbar.innerHTML = `
        <button type="button" class="editor-btn" data-action="bold"><span>B</span></button>
        <button type="button" class="editor-btn" data-action="italic"><span>I</span></button>
        <button type="button" class="editor-btn" data-action="underline"><span>U</span></button>
        <button type="button" class="editor-btn" data-action="linebreak"><span>A▾</span></button>
        <button type="button" class="editor-btn" data-action="link"><span>Link</span></button>
        <button type="button" class="editor-btn" data-action="image"><span>Img</span></button>
      `;
      const questionEditor = document.createElement('div');
      questionEditor.className = 'rich-editor survey-question-editor';
      questionEditor.contentEditable = 'true';
      questionEditor.innerHTML = sanitizeSurveyQuestionHtml(q.question_text || '');
      const questionHidden = document.createElement('textarea');
      questionHidden.className = 'survey-question-text';
      questionHidden.hidden = true;
      questionHidden.value = sanitizeSurveyQuestionHtml(q.question_text || '');
      const syncQuestionEditor = () => {
        questionHidden.value = sanitizeSurveyQuestionHtml(questionEditor.innerHTML || '');
        questionHidden.dispatchEvent(new Event('input', { bubbles: true }));
      };
      editorToolbar.addEventListener('mousedown', (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action') || '';
        e.preventDefault();
        questionEditor.focus();
        if (action === 'bold') document.execCommand('bold', false, null);
        else if (action === 'italic') document.execCommand('italic', false, null);
        else if (action === 'underline') document.execCommand('underline', false, null);
        else if (action === 'linebreak') document.execCommand('insertLineBreak', false, null);
        else if (action === 'link') {
          const href = window.prompt('URL do link (https://...)');
          if (href) document.execCommand('createLink', false, href.trim());
        } else if (action === 'image') {
          const src = window.prompt('URL da imagem (https://...)');
          if (src) document.execCommand('insertImage', false, src.trim());
        }
        syncQuestionEditor();
      });
      questionEditor.addEventListener('input', syncQuestionEditor);
      questionField.appendChild(editorToolbar);
      questionField.appendChild(questionEditor);
      questionField.appendChild(questionHidden);

      const typeField = document.createElement('div');
      typeField.className = 'field survey-question-type-field';
      typeField.innerHTML = `
        <label>Tipo</label>
        <select class="survey-question-type">
          <option value="short_text">Texto curto</option>
          <option value="number">Número</option>
          <option value="single_choice">Múltipla escolha</option>
          <option value="multiple_choice">Checkbox</option>
          <option value="scale">Escala</option>
        </select>
      `;

      const requiredField = document.createElement('div');
      requiredField.className = 'field';
      requiredField.innerHTML = `
        <label>Obrigatória</label>
        <select class="survey-question-required">
          <option value="0">Não</option>
          <option value="1">Sim</option>
        </select>
      `;

      const branchToggleField = document.createElement('div');
      branchToggleField.className = 'field';
      branchToggleField.innerHTML = `
        <label>Ramificada?</label>
        <select class="survey-question-branch-toggle">
          <option value="0">Não</option>
          <option value="1">Sim</option>
        </select>
      `;

      const defaultModeField = document.createElement('div');
      defaultModeField.className = 'field survey-default-mode-field';
      defaultModeField.innerHTML = `
        <label>Sem ramificação</label>
        <select class="survey-default-next-mode">
          <option value="sequential">Próxima pergunta</option>
          <option value="question">Ir para pergunta</option>
          <option value="end">Encerrar questionário</option>
        </select>
      `;

      const defaultTargetField = document.createElement('div');
      defaultTargetField.className = 'field survey-default-target-field';
      defaultTargetField.innerHTML = `
        <label>Destino padrão</label>
        <select class="survey-default-next-target"></select>
      `;

      const numberField = document.createElement('div');
      numberField.className = 'field survey-number-fields';
      numberField.innerHTML = `
        <label>Número (min / max)</label>
        <div style="display:flex;gap:8px">
          <input type="number" class="survey-number-min" placeholder="Min">
          <input type="number" class="survey-number-max" placeholder="Max">
        </div>
      `;

      const scaleField = document.createElement('div');
      scaleField.className = 'field survey-scale-fields';
      scaleField.innerHTML = `
        <label>Escala (min / max)</label>
        <div style="display:flex;gap:8px">
          <input type="number" class="survey-scale-min" placeholder="Min" value="${q.scale_min || 1}">
          <input type="number" class="survey-scale-max" placeholder="Max" value="${q.scale_max || 5}">
        </div>
      `;

      const optionsField = document.createElement('div');
      optionsField.className = 'field survey-options-fields';
      const optionsText = Array.isArray(q.options) ? q.options.map(opt => String(opt.label || '').trim()).join('\n') : '';
      optionsField.innerHTML = `
        <label>Opções (uma por linha)</label>
        <textarea class="survey-options-area" placeholder="Digite uma opção por linha">${escapeHtml(optionsText)}</textarea>
      `;

      const branchField = document.createElement('div');
      branchField.className = 'field survey-branch-fields';
      branchField.innerHTML = `
        <label>Ramificação</label>
        <div class="survey-inline-note">Salve e reabra para configurar ramificação por opção.</div>
      `;

      row.appendChild(questionField);
      row.appendChild(typeField);
      row.appendChild(requiredField);
      row.appendChild(branchToggleField);
      row.appendChild(defaultModeField);
      row.appendChild(defaultTargetField);
      row.appendChild(numberField);
      row.appendChild(scaleField);
      row.appendChild(optionsField);
      row.appendChild(branchField);

      card.appendChild(header);
      card.appendChild(row);

      const typeSelect = card.querySelector('.survey-question-type');
      if (q.type) typeSelect.value = q.type;
      const requiredSelect = card.querySelector('.survey-question-required');
      requiredSelect.value = String(q.required ? 1 : 0);
      const numMin = card.querySelector('.survey-number-min');
      const numMax = card.querySelector('.survey-number-max');
      if (q.number_min !== null && q.number_min !== undefined) numMin.value = q.number_min;
      if (q.number_max !== null && q.number_max !== undefined) numMax.value = q.number_max;

      if (!card.dataset.tempKey) {
        card.dataset.tempKey = q.id ? `id_${q.id}` : `tmp_${Date.now()}_${Math.random().toString(16).slice(2)}`;
      }
      if (q.flow_x !== null && q.flow_x !== undefined && q.flow_x !== '') card.dataset.flowX = String(q.flow_x);
      if (q.flow_y !== null && q.flow_y !== undefined && q.flow_y !== '') card.dataset.flowY = String(q.flow_y);
      card._surveyOptions = Array.isArray(q.options) ? q.options.map(opt => ({
        id: opt.id,
        label: String(opt.label || '').trim(),
        order_index: opt.order_index || null,
        target_question_id: opt.target_question_id || null,
        end_survey: opt.end_survey ? 1 : 0
      })) : [];

      const branchToggle = card.querySelector('.survey-question-branch-toggle');
      const hasBranch = card._surveyOptions.some(opt => opt.target_question_id || opt.end_survey);
      branchToggle.value = hasBranch ? '1' : '0';
      const defaultMode = card.querySelector('.survey-default-next-mode');
      const defaultTarget = card.querySelector('.survey-default-next-target');
      if (String(q.end_if_no_branch || '0') === '1') defaultMode.value = 'end';
      else if (q.default_next_question_id) defaultMode.value = 'question';
      else defaultMode.value = 'sequential';
      if (q.default_next_question_id) defaultTarget.dataset.selectedId = String(q.default_next_question_id);

      // If branching is enabled but options are empty (common in legacy data),
      // seed defaults so branch selectors can be configured immediately.
      ensureDefaultSurveyOptions(card);

      typeSelect.addEventListener('change', () => {
        ensureDefaultSurveyOptions(card);
        atualizarSurveyQuestionVisibilidade(card);
        atualizarSurveyBranchUIAll();
      });
      branchToggle.addEventListener('change', () => {
        ensureDefaultSurveyOptions(card);
        atualizarSurveyBranchUIAll();
      });
      defaultMode.addEventListener('change', atualizarSurveyBranchUIAll);
      const optionsArea = card.querySelector('.survey-options-area');
      if (optionsArea) {
        optionsArea.addEventListener('input', () => {
          syncSurveyOptionsFromTextarea(card);
          atualizarSurveyBranchUIAll();
        });
      }
      card.querySelector('.survey-question-text')?.addEventListener('input', atualizarSurveyBranchUIAll);
      card.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.getAttribute('data-action');
          if (action === 'remove') {
            card.remove();
            atualizarTitulosPerguntas();
            if (!surveyBuilderList.children.length) surveyBuilderEmpty.style.display = 'block';
            atualizarSurveyBranchUIAll();
            return;
          }
          if (action === 'up') moverSurveyPergunta(card, -1);
          if (action === 'down') moverSurveyPergunta(card, 1);
        });
      });

      atualizarSurveyQuestionVisibilidade(card);
      if (!surveyBuilderIsHydrating) {
        atualizarSurveyBranchUIAll();
      }
      return card;
    }

    function atualizarSurveyQuestionVisibilidade(card) {
      const type = card.querySelector('.survey-question-type').value;
      const optionsBlock = card.querySelector('.survey-options-fields');
      const scaleBlock = card.querySelector('.survey-scale-fields');
      const numberBlock = card.querySelector('.survey-number-fields');
      const branchBlock = card.querySelector('.survey-branch-fields');
      const branchToggle = card.querySelector('.survey-question-branch-toggle');
      optionsBlock.style.display = (type === 'single_choice' || type === 'multiple_choice') ? '' : 'none';
      scaleBlock.style.display = type === 'scale' ? '' : 'none';
      numberBlock.style.display = type === 'number' ? '' : 'none';
      branchBlock.style.display = (type === 'single_choice' || type === 'multiple_choice') ? '' : 'none';
      if (branchToggle) {
        const enabled = (type === 'single_choice' || type === 'multiple_choice');
        branchToggle.disabled = !enabled;
        if (!enabled) branchToggle.value = '0';
      }
    }

    function getSurveyOptionLines(card) {
      const area = card.querySelector('.survey-options-area');
      if (!area) return [];
      return String(area.value || '')
        .split(/\r?\n/)
        .map(v => v.trim())
        .filter(Boolean);
    }

    function ensureDefaultSurveyOptions(card) {
      const type = card.querySelector('.survey-question-type')?.value || '';
      const branchable = (type === 'single_choice' || type === 'multiple_choice');
      if (!branchable) return;
      const branchEnabled = card.querySelector('.survey-question-branch-toggle')?.value === '1';
      if (!branchEnabled) return;
      const area = card.querySelector('.survey-options-area');
      if (!area) return;
      const hasOptions = getSurveyOptionLines(card).length > 0;
      if (hasOptions) return;
      area.value = 'Opção 1\nOpção 2';
      syncSurveyOptionsFromTextarea(card);
    }

    function syncSurveyOptionsFromTextarea(card) {
      const lines = getSurveyOptionLines(card);
      const previous = Array.isArray(card._surveyOptions) ? card._surveyOptions : [];
      const normalizeLabel = (v) => String(v || '').trim();
      const prevByOrderAndLabel = new Map(previous.map(opt => [`${Number(opt.order_index || 0)}::${normalizeLabel(opt.label)}`, opt]));
      const prevByLabel = new Map(previous.map(opt => [normalizeLabel(opt.label), opt]));
      const next = [];
      lines.forEach((label, idx) => {
        const order = idx + 1;
        const normalized = normalizeLabel(label);
        const key = `${order}::${normalized}`;
        const matched = prevByOrderAndLabel.get(key) || prevByLabel.get(normalized) || null;
        next.push({
          id: matched?.id || null,
          label: normalized,
          order_index: order,
          target_question_id: matched?.target_question_id || null,
          end_survey: matched?.end_survey ? 1 : 0
        });
      });
      card._surveyOptions = next;
      return next;
    }

    function atualizarSurveyDefaultTargetField(card) {
      atualizarSurveyDefaultModeVisibility(card);
      const modeEl = card.querySelector('.survey-default-next-mode');
      const modeWrap = card.querySelector('.survey-default-mode-field');
      const targetWrap = card.querySelector('.survey-default-target-field');
      const targetSelect = card.querySelector('.survey-default-next-target');
      if (!modeEl || !modeWrap || !targetWrap || !targetSelect) return;
      if (modeWrap.style.display === 'none') {
        targetWrap.style.display = 'none';
        return;
      }
      const mode = modeEl.value || 'sequential';
      if (mode !== 'question') {
        targetWrap.style.display = 'none';
        return;
      }
      targetWrap.style.display = '';
      const currentTemp = card.dataset.tempKey || null;
      const currentId = card.dataset.id ? Number(card.dataset.id) : 0;
      const targets = Array.from(surveyBuilderList.children).map((c, idx) => ({
        id: c.dataset.id ? Number(c.dataset.id) : 0,
        temp: c.dataset.tempKey || null,
        text: stripHtmlToText(c.querySelector('.survey-question-text')?.value || '') || `Pergunta ${idx + 1}`
      })).filter(t => (t.id || t.temp) && t.id !== currentId && t.temp !== currentTemp);
      const selectedId = targetSelect.dataset.selectedId || '';
      const selectedTemp = targetSelect.dataset.selectedTemp || '';
      const html = ['<option value="">Selecione...</option>']
        .concat(targets.map(t => {
          const value = t.id ? String(t.id) : `temp:${t.temp}`;
          const selected = (selectedId && value === selectedId) || (selectedTemp && value === `temp:${selectedTemp}`);
          return `<option value="${escapeHtml(value)}"${selected ? ' selected' : ''}>${escapeHtml(t.text)}</option>`;
        })).join('');
      targetSelect.innerHTML = html;
      targetSelect.onchange = atualizarSurveyBranchUIAll;
    }

    function atualizarSurveyDefaultModeVisibility(card) {
      const type = card.querySelector('.survey-question-type')?.value || '';
      const branchToggle = card.querySelector('.survey-question-branch-toggle');
      const branchEnabled = branchToggle ? branchToggle.value === '1' : false;
      const modeWrap = card.querySelector('.survey-default-mode-field');
      if (!modeWrap) return;
      if ((type === 'single_choice' || type === 'multiple_choice') && branchEnabled) {
        modeWrap.style.display = 'none';
      } else {
        modeWrap.style.display = '';
      }
    }

    function atualizarSurveyBranchUIAll() {
      // Preserve current branch selections before any re-render of branch blocks.
      Array.from(surveyBuilderList.children).forEach(card => {
        persistSurveyBranchSelection(card);
      });
      Array.from(surveyBuilderList.children).forEach(card => {
        atualizarSurveyDefaultTargetField(card);
        atualizarSurveyBranchFields(card);
      });
      renderSurveyBranchPreview();
    }

    function persistSurveyBranchSelection(card) {
      if (!card || !Array.isArray(card._surveyOptions)) return;
      const rows = Array.from(card.querySelectorAll('.survey-branch-row'));
      if (!rows.length) return;
      const normalizeLabel = (v) => String(v || '').trim();
      rows.forEach(row => {
        const optOrder = Number(row.getAttribute('data-option-order')) || 0;
        const optLabel = normalizeLabel(row.getAttribute('data-option-label') || '');
        const select = row.querySelector('.survey-branch-select');
        if (!select) return;
        const raw = String(select.value || '');
        const target = card._surveyOptions.find(o =>
          (optOrder > 0 && Number(o.order_index || 0) === optOrder) ||
          (optOrder <= 0 && normalizeLabel(o.label) === optLabel)
        );
        if (!target) return;
        if (!raw) {
          target.end_survey = 0;
          target.target_question_id = null;
          return;
        }
        if (raw === '__END__') {
          target.end_survey = 1;
          target.target_question_id = null;
          return;
        }
        target.end_survey = 0;
        if (raw.startsWith('temp:')) {
          target.target_question_id = raw.replace('temp:', '');
          return;
        }
        target.target_question_id = Number(raw) || null;
      });
    }

    function atualizarSurveyBranchFields(card) {
      const branchBlock = card.querySelector('.survey-branch-fields');
      if (!branchBlock) return;
      const type = card.querySelector('.survey-question-type').value;
      const branchToggle = card.querySelector('.survey-question-branch-toggle');
      const branchEnabled = branchToggle ? branchToggle.value === '1' : false;
      if (type !== 'single_choice' && type !== 'multiple_choice') {
        branchBlock.innerHTML = `<label>Ramificação</label><div class="survey-inline-note">Disponível apenas para múltipla escolha/checkbox.</div>`;
        return;
      }
      if (!branchEnabled) {
        branchBlock.innerHTML = `<label>Ramificação</label><div class="survey-inline-note">Defina como \"Sim\" para ativar a ramificação.</div>`;
        return;
      }
      const options = syncSurveyOptionsFromTextarea(card);
      if (!options.length) {
        branchBlock.innerHTML = `<label>Ramificação</label><div class="survey-inline-note">Adicione opções reais no campo acima (uma por linha) para configurar a ramificação.</div>`;
        return;
      }
      const currentTemp = card.dataset.tempKey || null;
      const targets = Array.from(surveyBuilderList.children).map(c => ({
        id: c.dataset.id ? Number(c.dataset.id) : 0,
        temp: c.dataset.tempKey || null,
        label: stripHtmlToText(c.querySelector('.survey-question-text')?.value || '')
      })).filter(t => (t.id || t.temp) && t.temp !== currentTemp);
      const rows = options.map(opt => {
        const selected = opt.end_survey ? '__END__' : (opt.target_question_id ? String(opt.target_question_id) : '');
        const optionsHtml = ['<option value=\"\">Sem ramificação</option>', `<option value="__END__"${selected === '__END__' ? ' selected' : ''}>Encerrar questionário</option>`]
          .concat(targets.map(t => {
            const value = t.id ? String(t.id) : `temp:${t.temp}`;
            const isSelected = selected && (selected === String(t.id) || selected === String(t.temp));
            const label = t.label || (t.id ? `Pergunta #${t.id}` : 'Pergunta nova');
            return `<option value=\"${escapeHtml(value)}\"${isSelected ? ' selected' : ''}>${escapeHtml(label)}</option>`;
          }))
          .join('');
        return `
          <div class=\"survey-branch-row\" data-option-id=\"${opt.id || ''}\" data-option-order=\"${opt.order_index || ''}\" data-option-label=\"${escapeHtml(opt.label)}\">
            <div class=\"survey-inline-note\">${escapeHtml(opt.label)}</div>
            <select class=\"survey-branch-select\">${optionsHtml}</select>
          </div>
        `;
      }).join('');
      branchBlock.innerHTML = `<label>Ramificação (opção → pergunta)</label><div class=\"survey-branch-list\">${rows}</div>`;
      branchBlock.querySelectorAll('.survey-branch-select').forEach(select => {
        select.addEventListener('change', () => {
          persistSurveyBranchSelection(card);
          renderSurveyBranchPreview();
        });
      });
    }

    function atualizarTitulosPerguntas() {
      Array.from(surveyBuilderList.children).forEach((card, index) => {
        const title = card.querySelector('.survey-question-title');
        if (title) title.textContent = `Pergunta ${index + 1}`;
      });
      atualizarSurveyBranchUIAll();
    }

    function moverSurveyPergunta(card, dir) {
      const sibling = dir < 0 ? card.previousElementSibling : card.nextElementSibling;
      if (!sibling) return;
      if (dir < 0) surveyBuilderList.insertBefore(card, sibling);
      else surveyBuilderList.insertBefore(sibling, card);
      atualizarTitulosPerguntas();
    }

    function adicionarSurveyPergunta() {
      surveyBuilderEmpty.style.display = 'none';
      const card = criarSurveyQuestionCard({
        type: 'short_text',
        required: 0,
        scale_min: 1,
        scale_max: 5
      });
      surveyBuilderList.appendChild(card);
      atualizarTitulosPerguntas();
      renderSurveyBranchPreview();
    }

    function renderSurveyBranchPreview() {
      if (!surveyFlowPreview) return;
      const cards = Array.from(surveyBuilderList.children);
      if (!cards.length) {
        surveyFlowPreview.innerHTML = '<h4>Fluxo (números)</h4><div class="empty">Sem perguntas para exibir.</div>';
        return;
      }
      const nodes = cards.map((card, index) => {
        const key = card.dataset.tempKey || (card.dataset.id ? `id_${card.dataset.id}` : `idx_${index + 1}`);
        const saved = surveyFlowPositions[key] || null;
        const x = saved?.x ?? (card.dataset.flowX ? Number(card.dataset.flowX) : (240 + (index % 3) * 120));
        const y = saved?.y ?? (card.dataset.flowY ? Number(card.dataset.flowY) : (70 + Math.floor(index / 3) * 95));
        return { key, card, n: index + 1, x, y };
      });
      const nodeByKey = new Map(nodes.map(n => [n.key, n]));
      const nodeById = new Map(cards.filter(c => c.dataset.id).map(c => [String(c.dataset.id), c.dataset.tempKey || `id_${c.dataset.id}`]));

      const edges = [];
      const labels = [];
      const pushEdge = (fromKey, toKey, label = '') => {
        if (!fromKey || !toKey) return;
        const key = `${fromKey}->${toKey}->${label}`;
        if (labels.includes(key)) return;
        labels.push(key);
        edges.push({ from: fromKey, to: toKey, label });
      };

      nodes.forEach((node, idx) => {
        const card = node.card;
        const mode = card.querySelector('.survey-default-next-mode')?.value || 'sequential';
        if (mode === 'end') {
          pushEdge(node.key, '__END__', 'padrao');
        } else if (mode === 'question') {
          const raw = card.querySelector('.survey-default-next-target')?.value || '';
          let targetKey = null;
          if (raw.startsWith('temp:')) targetKey = raw.replace('temp:', '');
          else if (raw) targetKey = nodeById.get(raw) || null;
          if (targetKey) pushEdge(node.key, targetKey, 'padrao');
          else pushEdge(node.key, (nodes[idx + 1]?.key || '__END__'), 'padrao');
        } else {
          pushEdge(node.key, (nodes[idx + 1]?.key || '__END__'), 'padrao');
        }

        const type = card.querySelector('.survey-question-type')?.value || '';
        const branchEnabled = card.querySelector('.survey-question-branch-toggle')?.value === '1';
        if ((type !== 'single_choice' && type !== 'multiple_choice') || !branchEnabled) return;
        const rows = Array.from(card.querySelectorAll('.survey-branch-row'));
        rows.forEach(row => {
          const select = row.querySelector('.survey-branch-select');
          if (!select || !select.value) return;
          if (select.value === '__END__') {
            pushEdge(node.key, '__END__');
            return;
          }
          let targetKey = null;
          if (select.value.startsWith('temp:')) targetKey = select.value.replace('temp:', '');
          else targetKey = nodeById.get(select.value) || null;
          if (targetKey) pushEdge(node.key, targetKey);
        });
      });

      const branchLines = edges
        .filter(e => e.label !== 'padrao')
        .map(e => `${nodeByKey.get(e.from)?.n || '?'} \u2192 ${e.to === '__END__' ? 'Fim' : (nodeByKey.get(e.to)?.n || '?')}`);
      const uniqueBranchLines = Array.from(new Set(branchLines));
      const branchHtml = uniqueBranchLines.length
        ? uniqueBranchLines.map(line => `<div class="survey-flow-branch-line">${line}</div>`).join('')
        : '<div class="empty">Sem desvio configurado.</div>';

      surveyFlowPreview.innerHTML = `
        <h4>Fluxo (números)</h4>
        <div class="survey-flow-diagram">
          <div class="survey-flow-canvas" id="surveyFlowCanvas"></div>
        </div>
        <h4 style="margin-top:0">Desvios</h4>
        <div class="survey-flow-branches">${branchHtml}</div>
      `;

      const canvas = document.getElementById('surveyFlowCanvas');
      if (!canvas) return;
      canvas.innerHTML = `<svg class="survey-flow-svg" id="surveyFlowSvg"><defs><marker id="surveyArrowHead" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 z" fill="#1D6A92"></path></marker></defs></svg>`;
      const svg = document.getElementById('surveyFlowSvg');

      const gridSize = 24;
      const snap = (v) => Math.round(v / gridSize) * gridSize;
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
      const width = Math.max(canvas.clientWidth, 320);
      const height = Math.max(canvas.clientHeight, 320);
      const endNode = { x: snap(width / 2), y: snap(height - 40) };
      const domNodes = [];
      nodes.forEach(node => {
        const x = snap(clamp(node.x, 24, width - 24));
        const y = snap(clamp(node.y, 24, height - 24));
        node.x = x;
        node.y = y;
        node.card.dataset.flowX = String(x);
        node.card.dataset.flowY = String(y);
        surveyFlowPositions[node.key] = { x, y };
        const el = document.createElement('div');
        el.className = 'survey-flow-node';
        el.dataset.key = node.key;
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        el.innerHTML = `<div class="survey-flow-badge">${node.n}</div>`;
        canvas.appendChild(el);
        domNodes.push({ node, el });
      });
      const endEl = document.createElement('div');
      endEl.className = 'survey-flow-node';
      endEl.style.left = `${endNode.x}px`;
      endEl.style.top = `${endNode.y}px`;
      endEl.innerHTML = '<div class="survey-flow-end">Fim</div>';
      canvas.appendChild(endEl);

      const getCenter = (key) => {
        if (key === '__END__') return endNode;
        const found = domNodes.find(n => n.node.key === key);
        if (!found) return null;
        return { x: parseFloat(found.el.style.left), y: parseFloat(found.el.style.top) };
      };

      const redraw = () => {
        const defs = svg.querySelector('defs');
        svg.innerHTML = '';
        if (defs) svg.appendChild(defs);
        edges.forEach(edge => {
          const from = getCenter(edge.from);
          const to = getCenter(edge.to);
          if (!from || !to) return;
          const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          line.setAttribute('x1', String(from.x));
          line.setAttribute('y1', String(from.y));
          line.setAttribute('x2', String(to.x));
          line.setAttribute('y2', String(to.y));
          line.setAttribute('stroke', edge.label === 'padrao' ? '#8A7A68' : '#1D6A92');
          line.setAttribute('stroke-width', edge.label === 'padrao' ? '1.6' : '2');
          line.setAttribute('marker-end', 'url(#surveyArrowHead)');
          line.setAttribute('opacity', edge.label === 'padrao' ? '0.7' : '1');
          svg.appendChild(line);
        });
      };

      domNodes.forEach(item => {
        let dx = 0;
        let dy = 0;
        item.el.onpointerdown = (ev) => {
          const rect = item.el.getBoundingClientRect();
          dx = ev.clientX - rect.left - rect.width / 2;
          dy = ev.clientY - rect.top - rect.height / 2;
          item.el.setPointerCapture(ev.pointerId);
        };
        item.el.onpointermove = (ev) => {
          if (!item.el.hasPointerCapture(ev.pointerId)) return;
          const rect = canvas.getBoundingClientRect();
          const x = snap(clamp(ev.clientX - rect.left - dx, 24, rect.width - 24));
          const y = snap(clamp(ev.clientY - rect.top - dy, 24, rect.height - 24));
          item.el.style.left = `${x}px`;
          item.el.style.top = `${y}px`;
          item.node.card.dataset.flowX = String(Math.round(x));
          item.node.card.dataset.flowY = String(Math.round(y));
          surveyFlowPositions[item.node.key] = { x: Math.round(x), y: Math.round(y) };
          redraw();
        };
        item.el.onpointerup = (ev) => {
          if (item.el.hasPointerCapture(ev.pointerId)) {
            item.el.releasePointerCapture(ev.pointerId);
          }
        };
      });

      redraw();
    }

    function montarSurveyBuilderPayload() {
      if (!surveyBuilderSurveyId) return;
      atualizarSurveyBranchUIAll();
      Array.from(surveyBuilderList.children).forEach(card => persistSurveyBranchSelection(card));
      const questions = Array.from(surveyBuilderList.children).map((card, index) => {
        const text = sanitizeSurveyQuestionHtml(card.querySelector('.survey-question-text').value || '');
        const type = card.querySelector('.survey-question-type').value;
        const required = card.querySelector('.survey-question-required').value === '1';
        const branchEnabled = card.querySelector('.survey-question-branch-toggle')?.value === '1';
        const defaultNextMode = card.querySelector('.survey-default-next-mode')?.value || 'sequential';
        const defaultTargetRaw = card.querySelector('.survey-default-next-target')?.value || '';
        let defaultNextQuestionId = null;
        let defaultNextTempKey = null;
        if (defaultNextMode === 'question' && defaultTargetRaw) {
          if (defaultTargetRaw.startsWith('temp:')) defaultNextTempKey = defaultTargetRaw.replace('temp:', '');
          else defaultNextQuestionId = Number(defaultTargetRaw) || null;
        }
        const numberMin = card.querySelector('.survey-number-min').value;
        const numberMax = card.querySelector('.survey-number-max').value;
        const scaleMin = card.querySelector('.survey-scale-min').value;
        const scaleMax = card.querySelector('.survey-scale-max').value;
        const optionsText = card.querySelector('.survey-options-area').value || '';
        const options = optionsText.split(/\r?\n/).map(v => v.trim()).filter(Boolean)
          .map((label, idx) => ({ label, value: label, order_index: idx + 1 }));
        return {
          id: card.dataset.id ? Number(card.dataset.id) : null,
          temp_key: card.dataset.tempKey || null,
          question_text: text,
          type,
          required,
          branch_enabled: branchEnabled ? 1 : 0,
          default_next_mode: defaultNextMode,
          default_next_question_id: defaultNextQuestionId,
          default_next_temp_key: defaultNextTempKey,
          order_index: index + 1,
          number_min: numberMin !== '' ? Number(numberMin) : null,
          number_max: numberMax !== '' ? Number(numberMax) : null,
          scale_min: scaleMin !== '' ? Number(scaleMin) : 1,
          scale_max: scaleMax !== '' ? Number(scaleMax) : 5,
          flow_x: card.dataset.flowX ? Number(card.dataset.flowX) : null,
          flow_y: card.dataset.flowY ? Number(card.dataset.flowY) : null,
          options
        };
      });

      const rules = [];
      Array.from(surveyBuilderList.children).forEach(card => {
        atualizarSurveyBranchFields(card);
        const branchEnabled = card.querySelector('.survey-question-branch-toggle')?.value === '1';
        const type = card.querySelector('.survey-question-type')?.value || '';
        if (!branchEnabled || (type !== 'single_choice' && type !== 'multiple_choice')) return;
        const questionId = card.dataset.id ? Number(card.dataset.id) : 0;
        const questionTemp = card.dataset.tempKey || null;
        const optionLines = getSurveyOptionLines(card);
        const rowByOrder = new Map();
        Array.from(card.querySelectorAll('.survey-branch-row')).forEach(row => {
          const order = Number(row.getAttribute('data-option-order')) || 0;
          if (order > 0) rowByOrder.set(order, row);
        });
        optionLines.forEach((label, idx) => {
          const optionOrder = idx + 1;
          const row = rowByOrder.get(optionOrder) || null;
          const select = row?.querySelector('.survey-branch-select') || null;
          const rawSelect = String(select?.value || '').trim();
          if (!rawSelect) return;
          const optionId = Number(row?.getAttribute('data-option-id') || 0) || 0;
          const optionLabel = String(label || '');
          const endSurvey = rawSelect === '__END__';
          const rawTarget = endSurvey ? null : rawSelect;
          let targetId = 0;
          let targetTemp = null;
          if (!endSurvey && rawTarget) {
            if (rawTarget.startsWith('temp:')) {
              targetTemp = rawTarget.replace('temp:', '');
            } else if (!/^\d+$/.test(rawTarget)) {
              targetTemp = rawTarget;
            } else {
              targetId = Number(rawTarget) || 0;
            }
            if (targetId && !targetTemp) {
              const targetCard = Array.from(surveyBuilderList.children).find(c => String(c.dataset.id) === String(targetId));
              targetTemp = targetCard ? (targetCard.dataset.tempKey || null) : null;
            }
          }
          rules.push({
            question_id: questionId || null,
            question_temp_key: questionTemp,
            option_id: optionId || null,
            option_order: optionOrder || null,
            option_label: optionLabel,
            target_question_id: endSurvey ? null : (targetId || null),
            target_temp_key: endSurvey ? null : targetTemp,
            end_survey: endSurvey ? 1 : 0
          });
        });
      });

      if (questions.some(q => !surveyQuestionHasContent(q.question_text))) {
        alert('Preencha o texto de todas as perguntas.');
        return null;
      }
      return { survey_id: surveyBuilderSurveyId, questions, rules };
    }

    function salvarSurveyBuilderLocal() {
      const payload = montarSurveyBuilderPayload();
      if (!payload) return;
      surveyBuilderDraftBySurvey[surveyBuilderSurveyId] = payload;
      showToast('Rascunho salvo na tela.');
    }

    async function atualizarSurveyBuilder() {
      if (!surveyBuilderSurveyId) return;
      if (surveyBuilderDraftBySurvey[surveyBuilderSurveyId]) {
        const ok = window.confirm('Atualizar vai descartar alterações salvas em tela que ainda não foram enviadas ao banco. Continuar?');
        if (!ok) return;
      }
      delete surveyBuilderDraftBySurvey[surveyBuilderSurveyId];
      await carregarSurveyBuilder();
      showToast('Dados atualizados do banco.');
    }

    async function salvarSurveyBuilder(closeAfter = true) {
      const payload = montarSurveyBuilderPayload();
      if (!payload) return;

      try {
        const res = await fetch(`${API_BASE}/survey_builder.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Falha ao salvar perguntas.');
        const requested = Number(data.rules_requested || 0);
        const saved = Number(data.rules_saved || 0);
        const savedPaths = Number(data.paths_saved || 0);
        const skippedNoTarget = Number(data.rules_skipped_no_target || 0);
        if (requested > 0 && savedPaths === 0) {
          alert('As perguntas foram salvas, mas nenhuma ramificação foi persistida. Verifique se cada opção tem um destino válido.');
          return;
        }
        if (requested > 0 && skippedNoTarget > 0) {
          alert(`Algumas ramificações foram ignoradas por destino inválido (${skippedNoTarget}). Salvas: regras=${saved}, caminhos=${savedPaths}.`);
          return;
        }
        delete surveyBuilderDraftBySurvey[surveyBuilderSurveyId];
        if (closeAfter) {
          showToast('Perguntas salvas.');
          fecharSurveyBuilder();
        } else {
          showToast('Perguntas salvas no banco.');
        }
      } catch (err) {
        console.error(err);
        alert(`Erro ao salvar perguntas: ${err.message || 'falha desconhecida'}`);
      }
    }

    async function salvarSurveyBuilderFechar() {
      await salvarSurveyBuilder(true);
    }

    async function salvarSurveyBuilderBanco() {
      await salvarSurveyBuilder(false);
    }

    async function abrirSurveyResults(id) {
      if (!id) return;
      surveyResultsBody.innerHTML = '<div class="box-message">Carregando...</div>';
      surveyResultsModal.classList.add('show');
      try {
        const res = await fetch(`${API_BASE}/survey_results.php?survey_id=${id}`, { credentials: 'include' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Falha ao carregar resultados.');
        surveyResultsCache = data;
        renderSurveyResults(data);
      } catch (err) {
        console.error(err);
        surveyResultsBody.innerHTML = '<div class="box-message">Erro ao carregar resultados.</div>';
      }
    }

    function fecharSurveyResults() {
      surveyResultsModal.classList.remove('show');
      surveyResultsBody.innerHTML = '';
      surveyResultsCache = null;
    }

    function renderSurveyResults(data) {
      const questions = data.questions || [];
      const responses = data.responses || [];
      if (!responses.length) {
        surveyResultsBody.innerHTML = '<div class="box-message">Nenhuma resposta encontrada.</div>';
        return;
      }
      let html = '<div class="table-container"><table><thead><tr><th>Enviado em</th>';
      questions.forEach(q => { html += `<th>${escapeHtml(stripHtmlToText(q.question_text))}</th>`; });
      html += '</tr></thead><tbody>';
      responses.forEach(resp => {
        html += `<tr><td>${escapeHtml(resp.submitted_at || '')}</td>`;
        questions.forEach(q => {
          const ans = resp.answers && resp.answers[q.id] ? resp.answers[q.id] : null;
          const value = ans ? ans.display : '-';
          html += `<td>${escapeHtml(value)}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';
      surveyResultsBody.innerHTML = html;
    }

    function exportarSurveyCSV() {
      if (!surveyResultsCache) return;
      const questions = surveyResultsCache.questions || [];
      const responses = surveyResultsCache.responses || [];
      if (!responses.length) {
        alert('Nada para exportar.');
        return;
      }
      const headers = ['Enviado em'].concat(questions.map(q => stripHtmlToText(q.question_text)));
      const esc = s => '"' + String(s == null ? '' : s).replace(/"/g, '""') + '"';
      const lines = responses.map(resp => {
        const row = [resp.submitted_at || ''];
        questions.forEach(q => {
          const ans = resp.answers && resp.answers[q.id] ? resp.answers[q.id] : null;
          row.push(ans ? ans.display : '');
        });
        return row.map(esc).join(',');
      });
      const csv = [headers.map(esc).join(',')].concat(lines).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `survey_${surveyResultsCache.survey?.id || 'resultados'}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function abrirSurveyLeads(id) {
      if (!id) return;
      surveyLeadsBody.innerHTML = '<div class="box-message">Carregando...</div>';
      surveyLeadsModal.classList.add('show');
      try {
        const res = await fetch(`${API_BASE}/survey_leads.php?survey_id=${id}`, { credentials: 'include' });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Falha ao carregar leads.');
        surveyLeadsCache = data;
        renderSurveyLeads(data);
      } catch (err) {
        console.error(err);
        surveyLeadsBody.innerHTML = '<div class="box-message">Erro ao carregar leads.</div>';
      }
    }

    function fecharSurveyLeads() {
      surveyLeadsModal.classList.remove('show');
      surveyLeadsBody.innerHTML = '';
      surveyLeadsCache = null;
    }

    function renderSurveyLeads(data) {
      const leads = data.leads || [];
      if (!leads.length) {
        surveyLeadsBody.innerHTML = '<div class="box-message">Nenhum lead captado até agora.</div>';
        return;
      }
      let html = '<div class="table-container"><table><thead><tr><th>E-mail</th><th>Origem</th><th>Criado em</th><th>Atualizado em</th></tr></thead><tbody>';
      leads.forEach(lead => {
        html += `<tr>
          <td>${escapeHtml(lead.email || '')}</td>
          <td>${escapeHtml(lead.origin || '')}</td>
          <td>${escapeHtml(lead.created_at || '')}</td>
          <td>${escapeHtml(lead.updated_at || '')}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      surveyLeadsBody.innerHTML = html;
    }

    function exportarSurveyLeadsCSV() {
      if (!surveyLeadsCache) return;
      const leads = surveyLeadsCache.leads || [];
      if (!leads.length) {
        alert('Nada para exportar.');
        return;
      }
      const headers = ['E-mail', 'Origem', 'Criado em', 'Atualizado em'];
      const esc = s => '"' + String(s == null ? '' : s).replace(/"/g, '""') + '"';
      const lines = leads.map(lead => [
        lead.email || '',
        lead.origin || '',
        lead.created_at || '',
        lead.updated_at || ''
      ].map(esc).join(','));
      const csv = [headers.map(esc).join(',')].concat(lines).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `survey_${surveyLeadsCache.survey?.id || 'leads'}_leads.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Modal Anunciante (vínculo de sala) =====
    let advertiserSalaRoomId = null;
    let advertisersCache = null;
    async function abrirAnuncianteSala(roomId){
      advertiserSalaRoomId = roomId;
      const body = document.getElementById('advertiserModalBody');
      const msg = document.getElementById('advertiserModalMsg');
      msg.style.display='none'; msg.textContent='';
      const sala = (dadosJSON || []).find(r => String(r.id) === String(roomId));
      body.innerHTML = '<div class="box-message">Carregando…</div>';
      try {
        if (!advertisersCache) {
          const r = await fetch(`${API_BASE}/apiget.php?table=advertisers`, { credentials:'include' });
          const j = await r.json();
          advertisersCache = j.success ? (j.data || []) : [];
        }
        const options = advertisersCache.map(a => `<option value="${a.id}">${escapeHtml(a.display_name || ('Anunciante #'+a.id))} (ID ${a.id})</option>`).join('');
        const current = sala?.advertiser_id || '';
        body.innerHTML = `
          <div class="form-group" style="grid-column: span 2">
            <label>Sala</label>
            <input class="input-readonly" value="${escapeHtml(sala?.name || ('Sala #'+roomId))}" readonly />
          </div>
          <div class="form-group" style="grid-column: span 2">
            <label>Anunciante</label>
            <select id="advertiserSelect"><option value="">— Selecionar —</option>${options}</select>
          </div>`;
        const sel = document.getElementById('advertiserSelect'); if (current) sel.value = String(current);
        document.getElementById('advertiserModal').classList.add('show');
      } catch (e) {
        body.innerHTML = '<div class="box-message">Falha ao carregar anunciantes.</div>';
      }
    }
    function fecharAdvertiserModal(){ document.getElementById('advertiserModal').classList.remove('show'); advertiserSalaRoomId = null; }
    async function salvarAdvertiserSala(){
      const msg = document.getElementById('advertiserModalMsg'); msg.style.display='none'; msg.textContent='';
      const sel = document.getElementById('advertiserSelect'); const advId = sel ? Number(sel.value)||null : null;
      if (!advertiserSalaRoomId) return;
      try {
        // apiupdate.php espera o id dentro de data
        const payload = { table: 'rooms', data: { id: advertiserSalaRoomId, advertiser_id: advId } };
        const res = await fetch(`${API_BASE}/apiupdate.php`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json(); if (!json.success) throw new Error(json.error||'Falha ao salvar.');
        msg.textContent = 'Vínculo salvo com sucesso.'; msg.style.display='block';
        await loadSection('rooms'); fecharAdvertiserModal();
      } catch (err) {
        msg.textContent = err.message || 'Erro ao salvar.'; msg.style.display='block';
      }
    }

    async function renderFilters(section) {
      const container = document.getElementById('search-filters');
      const canCreate = can(section, 'create');
      if (section === 'reservations') {
        await renderReservationFilters(container);
        return;
      }
      if (section === 'vouchers') {
        container.innerHTML = `
          <input type="text" id="inputBusca" placeholder="Buscar código..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
          <select id="voucherStatusSel" onchange="(function(s){ voucherFilters.status=s.value; renderTable(); })(this)">
            <option value="">Todos</option>
            <option value="ativo">Ativo</option>
            <option value="inativo">Inativo</option>
            <option value="expirado">Expirado</option>
          </select>
          ${canCreate ? `<button class="btn" onclick="abrirModalNovo()">+ Novo</button>` : ''}
          <button class="btn-secondary" onclick="exportarCSV()">Exportar CSV</button>`;
      } else if (section === 'inventory_items') {
        const allColumns = buildColumnList(section, dadosJSON || []);
        const selectedKeys = getStoredColumns(section)
          || (sectionConfigs[section]?.columns || allColumns).map(col => col.key);
        const columnOptions = allColumns.map(col => {
          const checked = selectedKeys.includes(col.key) ? ' checked' : '';
          return `<label class="column-option"><input type="checkbox"${checked} onchange="toggleColumnSelection('${section}', '${col.key}', this.checked)"> ${escapeHtml(col.label)}</label>`;
        }).join('');
        container.innerHTML = `
          <input type="text" id="inputBusca" placeholder="Buscar..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
          <select onchange="(function(s){ inventoryFilters.categoria=s.value; renderTable(); })(this)">
            <option value="">Categoria</option>
            ${inventoryCategoryOptions.map(opt => `<option value="${escapeHtml(opt)}"${inventoryFilters.categoria === opt ? ' selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
          </select>
          <select onchange="(function(s){ inventoryFilters.status=s.value; renderTable(); })(this)">
            <option value="">Status</option>
            ${inventoryStatusOptions.map(opt => `<option value="${escapeHtml(opt)}"${inventoryFilters.status === opt ? ' selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
          </select>
          <select onchange="(function(s){ inventoryFilters.condicao=s.value; renderTable(); })(this)">
            <option value="">Condição</option>
            ${inventoryConditionOptions.map(opt => `<option value="${escapeHtml(opt)}"${inventoryFilters.condicao === opt ? ' selected' : ''}>${escapeHtml(opt)}</option>`).join('')}
          </select>
          <details class="column-selector">
            <summary>Colunas</summary>
            <div class="column-selector-body">
              ${columnOptions}
            </div>
            <div class="column-selector-actions">
              <button class="btn-secondary" type="button" onclick="resetColumnSelection('${section}', 'default')">Padrão</button>
              <button class="btn-secondary" type="button" onclick="resetColumnSelection('${section}', 'all')">Todas</button>
            </div>
          </details>
          ${canCreate ? `<button class="btn" onclick="abrirModalNovo()">+ Novo</button>` : ''}
          <button class="btn-secondary" onclick="exportarCSV()">Exportar CSV</button>`;
      } else {
        container.innerHTML =
          `<input type="text" id="inputBusca" placeholder="Buscar..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
           ${canCreate ? `<button class="btn" onclick="abrirModalNovo()">+ Novo</button>` : ''}`;
      }
    }

    async function renderReservationFilters(container) {
      await ensureReservationOptions();
      const roomOptions = (cachedRooms || []).map(room => {
        const id = Number(room.id) || 0;
        const selected = reservationFilters.room_id == id ? ' selected' : '';
        const label = escapeHtml(room.name || `Sala #${id}`);
        return `<option value="${id}"${selected}>${label}</option>`;
      }).join('');
      const clientOptions = (cachedClients || []).map(client => {
        const id = Number(client.id) || 0;
        const selected = reservationFilters.client_id == id ? ' selected' : '';
        const label = escapeHtml(client.name || `Cliente #${id}`);
        return `<option value="${id}"${selected}>${label}</option>`;
      }).join('');

      const dateRange = reservationFilters.date_range || '';
      const customVisible = dateRange === 'custom' ? '' : 'display:none';

      container.innerHTML = `
        <input type="text" id="inputBusca" placeholder="Buscar..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
        <select onchange="atualizarFiltroReserva('room_id', this.value)">
          <option value="">Todas as salas</option>
          ${roomOptions}
        </select>
        <select onchange="atualizarFiltroReserva('client_id', this.value)">
          <option value="">Todos os clientes</option>
          ${clientOptions}
        </select>
        <select onchange="atualizarFiltroReserva('date_range', this.value)">
          <option value="">Período</option>
          <option value="past_30"${dateRange === 'past_30' ? ' selected' : ''}>Últimos 30 dias</option>
          <option value="past_60"${dateRange === 'past_60' ? ' selected' : ''}>Últimos 60 dias</option>
          <option value="past_90"${dateRange === 'past_90' ? ' selected' : ''}>Últimos 90 dias</option>
          <option value="future"${dateRange === 'future' ? ' selected' : ''}>Futuro</option>
          <option value="custom"${dateRange === 'custom' ? ' selected' : ''}>Entre datas</option>
        </select>
        <span id="filtrosCustom" style="${customVisible}">
          <input type="date" value="${reservationFilters.date_from || ''}" onchange="atualizarFiltroReservaData('date_from', this.value)">
          <input type="date" value="${reservationFilters.date_to || ''}" onchange="atualizarFiltroReservaData('date_to', this.value)">
          <button class="btn" type="button" onclick="aplicarFiltroPersonalizado()">Aplicar</button>
        </span>
        ${can('reservations', 'create') ? `<button class="btn" onclick="abrirModalNovo()">+ Nova</button>` : ''}
      `;
    }

    async function ensureReservationOptions() {
      if (!cachedRooms) {
        try {
          const res = await fetch(`${API_BASE}/apiget.php?table=rooms`, { credentials: 'include' });
          const data = await res.json();
          cachedRooms = data.success ? data.data || [] : [];
        } catch (err) {
          console.error(err);
          cachedRooms = [];
        }
      }
      if (!cachedClients) {
        try {
          const res = await fetch(`${API_BASE}/apiget.php?table=clients`, { credentials: 'include' });
          const data = await res.json();
          cachedClients = data.success ? data.data || [] : [];
        } catch (err) {
          console.error(err);
          cachedClients = [];
        }
      }
    }

    function atualizarFiltroReserva(campo, valor) {
      reservationFilters[campo] = valor;
      if (campo === 'date_range') {
        if (valor !== 'custom') {
          reservationFilters.date_from = '';
          reservationFilters.date_to = '';
          loadSection('reservations');
        } else {
          renderFilters('reservations');
        }
        return;
      }
      loadSection('reservations');
    }

    function atualizarFiltroReservaData(campo, valor) {
      reservationFilters[campo] = valor;
    }

    function aplicarFiltroPersonalizado() {
      loadSection('reservations');
    }

    function abrirModalNovo() {
      if (!can(sec, 'create')) {
        alert('Você não tem permissão para criar registros nesta seção.');
        return;
      }
      itemEdit = null;
      gerarCampos({});
      document.getElementById('modalTitle').textContent = `Nova ${modalEntities[sec] || 'Entrada'}`;
      document.getElementById('modal').classList.add('show');
      if (resetSenhaBtn) {
        resetSenhaBtn.style.display = 'none';
        resetSenhaBtn.onclick = null;
      }
    }

    function abrirModalEdit(id) {
      if (!can(sec, 'update')) {
        alert('Você não tem permissão para editar registros nesta seção.');
        return;
      }
      itemEdit = dadosJSON.find(r => r.id == id);
      if (!itemEdit) return;
      gerarCampos(itemEdit);
      document.getElementById('modalTitle').textContent = `Editar ${modalEntities[sec] || 'Registro'}`;
      document.getElementById('modal').classList.add('show');
      if (resetSenhaBtn) {
        if (sec === 'clients' && itemEdit && itemEdit.id) {
          resetSenhaBtn.style.display = 'inline-block';
          resetSenhaBtn.onclick = () => resetSenhaCliente(itemEdit.id);
        } else if (sec === 'advertisers' && itemEdit && itemEdit.login_email) {
          resetSenhaBtn.style.display = 'inline-block';
          resetSenhaBtn.onclick = () => resetSenhaAnunciante(itemEdit.login_email);
        } else {
          resetSenhaBtn.style.display = 'none';
          resetSenhaBtn.onclick = null;
        }
      }
      const geocodeBtn = document.getElementById('geocodeBtn');
      if (geocodeBtn) {
        if (sec === 'rooms' && itemEdit && itemEdit.id) {
          geocodeBtn.style.display = 'inline-block';
          geocodeBtn.onclick = () => geocodificarSalaAtual(itemEdit.id);
        } else {
          geocodeBtn.style.display = 'none';
          geocodeBtn.onclick = null;
        }
      }
    }

    function abrirModalExcluir(id) {
      if (!can(sec, 'delete')) {
        alert('Você não tem permissão para excluir registros nesta seção.');
        return;
      }
      if (!confirm('Deseja realmente excluir este registro?')) return;
      excluirItem(id);
    }

    function fecharModal() {
      document.getElementById('modal').classList.remove('show');
      if (resetSenhaBtn) {
        resetSenhaBtn.style.display = 'none';
        resetSenhaBtn.onclick = null;
      }
      const geocodeBtn = document.getElementById('geocodeBtn');
      if (geocodeBtn) { geocodeBtn.style.display = 'none'; geocodeBtn.onclick = null; }
    }

    const UF = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'];

    const schemas = {
      companies: [
        { name: 'razao_social', label: 'Razão Social', span: 4 },
        { type: 'break' },
        { name: 'nome_fantasia', label: 'Nome Fantasia', span: 4 },
        { type: 'break' },
        { name: 'cnpj', label: 'CNPJ', span: 2 },
        { name: 'inscricao_estadual', label: 'Inscrição Estadual', span: 2 },
        { type: 'break' },
        { name: 'discount_pct', label: '% de desconto', span: 1, type: 'number', cls: 'sm' },
        { name: 'account_manager_id', label: 'Gerente de Conta', span: 3, type: 'select', source: 'admins' },
        { type: 'break' },
        { name: 'street', label: 'Rua', span: 2 },
        { name: 'number', label: 'Número', span: 1, cls: 'sm' },
        { name: 'complement', label: 'Complemento', span: 1 },
        { type: 'break' },
        { name: 'zip_code', label: 'CEP', span: 1, cls: 'sm' },
        { name: 'state', label: 'Estado', span: 1, type: 'select', options: UF, cls: 'sm' },
        { name: 'city', label: 'Cidade', span: 2 },
        { type: 'break' },
        { name: 'email', label: 'E-mail', span: 2 },
        { name: 'phone', label: 'Telefone', span: 1, cls: 'sm' },
        { name: 'whatsapp', label: 'WhatsApp', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativa' },
          { value: 'inativo', label: 'Inativa' }
        ], cls: 'sm', includeEmpty: false }
      ],
      clients: [
        { name: 'name', label: 'Nome Completo', span: 3 },
        { name: 'email', label: 'E-mail', span: 2 },
        { name: 'login', label: 'Login', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'cpf', label: 'CPF', span: 1, cls: 'sm' },
        { name: 'rg', label: 'RG', span: 1, cls: 'sm' },
        { name: 'phone', label: 'Telefone', span: 1, cls: 'sm' },
        { name: 'whatsapp', label: 'WhatsApp', span: 1, cls: 'sm' },
        { name: 'type', label: 'Tipo', span: 1, type: 'select', options: ['PF', 'PJ'], cls: 'sm', includeEmpty: false },
        { type: 'break' },
        { name: 'company_id', label: 'Empresa', span: 2, type: 'select', source: 'companies' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' },
          { value: 'bloqueado', label: 'Bloqueado' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'password_hash', label: 'Senha (hash)', span: 2, readonly: true },
        { name: 'created_at', label: 'Criado em', span: 1, type: 'date', readonly: true, cls: 'sm' },
        { name: 'updated_at', label: 'Atualizado em', span: 1, type: 'date', readonly: true, cls: 'sm' }
      ],
      advertisers: [
        { name: 'full_name', label: 'Nome completo', span: 2 },
        { name: 'display_name', label: 'Nome público (anúncio)', span: 2 },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [ {value:'ativo',label:'Ativo'}, {value:'inativo',label:'Inativo'}, {value:'suspenso',label:'Suspenso'} ], cls:'sm', includeEmpty:false },
        { type: 'break' },
        { name: 'fee_pct_room', label: 'Fee Locação (%)', span: 1, cls:'sm' },
        { name: 'fee_pct_workshop', label: 'Fee Workshop (%)', span: 1, cls:'sm' },
        { name: 'contact_phone', label: 'Telefone', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'owner_type', label: 'Tipo de dono', span: 1, type: 'select', options: [ {value:'client',label:'Cliente'}, {value:'company',label:'Empresa'} ], cls:'sm', includeEmpty:false },
        { name: 'owner_id', label: 'ID do dono', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'bank_code', label: 'Banco (cód.)', span: 1, cls:'sm' },
        { name: 'bank_name', label: 'Banco (nome)', span: 1 },
        { name: 'account_type', label: 'Tipo de Conta', span: 1, type: 'select', options: [ {value:'corrente',label:'Corrente'}, {value:'poupanca',label:'Poupança'}, {value:'pix',label:'PIX'} ], cls:'sm', includeEmpty:true },
        { name: 'agency_number', label: 'Agência', span: 1, cls:'sm' },
        { name: 'account_number', label: 'Conta', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'pix_key', label: 'Chave PIX', span: 2 },
        { name: 'created_at', label: 'Criado em', span: 1, type: 'date', readonly: true, cls:'sm' },
        { name: 'updated_at', label: 'Atualizado em', span: 1, type: 'date', readonly: true, cls:'sm' }
      ],
      rooms: [
        { name: 'name', label: 'Nome da Sala', span: 4 },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { type: 'break' },
        { name: 'capacity', label: 'Capacidade', span: 1, cls: 'sm' },
        { name: 'daily_rate', label: 'Valor Diário (R$)', span: 1, cls: 'sm' },
        { name: 'facilitated_access', label: 'Acesso Facilitado', span: 1, type: 'select', options: [
          { value: 1, label: 'Sim' },
          { value: 0, label: 'Não' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'portaria_inteligente', label: 'Portaria Inteligente', span: 1, type: 'select', options: [
          { value: 'Sim', label: 'Sim' },
          { value: 'Não', label: 'Não' }
        ], cls: 'sm', includeEmpty: false },
        { type: 'break' },
        { name: 'street', label: 'Rua', span: 3 },
        { name: 'complement', label: 'Complemento', span: 1 },
        { type: 'break' },
        { name: 'cep', label: 'CEP', span: 1, cls: 'sm' },
        { name: 'state', label: 'Estado', span: 1, type: 'select', options: UF, cls: 'sm' },
        { name: 'city', label: 'Cidade', span: 2 },
        { type: 'break' },
        { name: 'responsavel_nome', label: 'Nome do Responsável', span: 2 },
        { name: 'responsavel_telefone', label: 'Telefone do Responsável', span: 1, cls: 'sm' },
        { name: 'responsavel_email', label: 'E-mail do Responsável', span: 1 },
        { type: 'break' },
        { name: 'portaria_telefone', label: 'Telefone Portaria', span: 1, cls: 'sm' },
        { name: 'portaria_email', label: 'E-mail Portaria', span: 1 },
        { type: 'break' },
        { name: 'location', label: 'Localização Interna (andar, bloco, mapa)', span: 4 },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 2, type: 'select', options: [
          { value: 'ativo', label: 'Ativa' },
          { value: 'inativo', label: 'Inativa' },
          { value: 'manutencao', label: 'Em Manutenção' },
          { value: 'desativada', label: 'Desativada' }
        ], cls: 'sm', placeholder: 'Selecione o status', required: true },
        { type: 'break' },
        { name: 'maintenance_start', label: 'Manutenção - De', span: 1, cls: 'sm', type: 'date', showIfStatus: ['manutencao'] },
        { name: 'maintenance_end', label: 'Manutenção - Até', span: 1, cls: 'sm', type: 'date', showIfStatus: ['manutencao'] },
        { name: 'deactivated_from', label: 'Desativada a partir de', span: 1, cls: 'sm', type: 'date', showIfStatus: ['desativada'] },
        { type: 'break' },
        { name: 'photo_path', label: 'Fotos da Sala', span: 4, type: 'file-multiple' },
        { name: 'amenities', label: 'Comodidades Disponíveis', span: 4, type: 'checkbox-grid', optionsSource: 'amenities' }
      ],
      inventory_items: [
        { type: 'break', label: 'Identificação' },
        { name: 'codigo_patrimonio', label: 'Código Patrimônio', span: 1, cls: 'sm' },
        { name: 'descricao', label: 'Descrição', span: 3 },
        { type: 'break' },
        { name: 'categoria', label: 'Categoria', span: 2, type: 'select', includeEmpty: true, options: [
          'Móveis de escritório',
          'Mesas e estações de trabalho',
          'Cadeiras e assentos',
          'Armários e arquivos',
          'Gaveteiros e estantes',
          'Informática',
          'Computadores e notebooks',
          'Monitores',
          'Periféricos (mouse, teclado, webcam)',
          'Impressão e digitalização',
          'Equipamentos audiovisuais',
          'Projetores e telas',
          'Câmeras',
          'Controles remotos e acessórios',
          'Caixas de som e microfones',
          'Equipamentos de videoconferência',
          'Telefonia e comunicação',
          'Equipamentos de rede',
          'Cabos e adaptadores',
          'Eletroeletrônicos',
          'Equipamentos de climatização',
          'Equipamentos de segurança',
          'Decoração e apoio'
        ] },
        { name: 'marca', label: 'Marca', span: 1, cls: 'sm' },
        { name: 'modelo', label: 'Modelo', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'numero_serie', label: 'Número de série', span: 2 },
        { name: 'data_aquisicao', label: 'Data de aquisição', span: 1, cls: 'sm', type: 'date' },
        { name: 'fornecedor', label: 'Fornecedor', span: 1 },
        { type: 'break' },
        { name: 'nota_fiscal', label: 'Nota fiscal', span: 1, cls: 'sm' },
        { name: 'valor_aquisicao', label: 'Valor de aquisição', span: 1, cls: 'sm' },
        { name: 'forma_aquisicao', label: 'Forma de aquisição', span: 2 },
        { type: 'break', label: 'Localização' },
        { name: 'unidade', label: 'Unidade', span: 2 },
        { name: 'setor', label: 'Setor', span: 2 },
        { type: 'break' },
        { name: 'localizacao_endereco', label: 'Endereço', span: 3 },
        { name: 'localizacao_cep', label: 'CEP', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'localizacao_complemento', label: 'Local físico', span: 2 },
        { name: 'responsavel', label: 'Responsável', span: 2 },
        { type: 'break', label: 'Status e inventário' },
        { name: 'status', label: 'Status', span: 1, cls: 'sm', type: 'select', includeEmpty: true, options: [
          'Em Uso',
          'Estoque',
          'Manutenção'
        ] },
        { name: 'condicao', label: 'Condição', span: 1, cls: 'sm', type: 'select', includeEmpty: true, options: [
          'Novo',
          'Bom',
          'Regular',
          'Ruim'
        ] },
        { name: 'data_ultimo_inventario', label: 'Último inventário', span: 1, cls: 'sm', type: 'date' },
        { name: 'vida_util_anos', label: 'Vida útil (anos)', span: 1, cls: 'sm' },
        { type: 'break', label: 'Financeiro' },
        { name: 'taxa_depreciacao', label: 'Taxa de depreciação (%)', span: 1, cls: 'sm' },
        { name: 'valor_contabil', label: 'Valor contábil', span: 1, cls: 'sm' },
        { name: 'centro_custo', label: 'Centro de custo', span: 2 },
        { type: 'break', label: 'Manutenção' },
        { name: 'garantia_ate', label: 'Garantia até', span: 1, cls: 'sm', type: 'date' },
        { name: 'historico_manutencao', label: 'Histórico de manutenção', span: 3, type: 'textarea' },
        { type: 'break', label: 'Baixa' },
        { name: 'custo_manutencao', label: 'Custo manutenção', span: 1, cls: 'sm' },
        { name: 'data_baixa', label: 'Data de baixa', span: 1, cls: 'sm', type: 'date' },
        { name: 'motivo_baixa', label: 'Motivo da baixa', span: 2 },
        { type: 'break' },
        { name: 'valor_baixa', label: 'Valor de baixa', span: 1, cls: 'sm' },
        { name: 'link_qr', label: 'Link QR', span: 3, readonly: true },
        { type: 'break' },
        { name: 'created_at', label: 'Criado em', span: 1, cls: 'sm', type: 'date', readonly: true },
        { name: 'updated_at', label: 'Atualizado em', span: 1, cls: 'sm', type: 'date', readonly: true }
      ],
      surveys: [
        { name: 'title', label: 'Título', span: 3, required: true },
        { name: 'status', label: 'Status', span: 1, cls: 'sm', type: 'select', includeEmpty: false, options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ] },
        { type: 'break' },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { name: 'thank_you_message', label: 'Mensagem de agradecimento', span: 4, type: 'textarea' },
        { type: 'break' },
        { name: 'closing_page_type', label: 'Página de encerramento', span: 2, type: 'select', includeEmpty: false, options: [
          { value: 'simple', label: 'Simples (mensagem)' },
          { value: 'lead_capture', label: 'Ze.EFE com captação de e-mail' }
        ] },
        { name: 'lead_origin', label: 'Origem do lead', span: 2, placeholder: 'Ex.: Pesquisa Satisfação NPS' },
        { type: 'break' },
        { name: 'public_link', label: 'Link público', span: 4, readonly: true }
      ],
      reservations: [
        { name: 'title', label: 'Título', span: 3 },
        { name: 'room_id', label: 'Sala', span: 2, type: 'select', source: 'rooms', includeEmpty: false },
        { name: 'client_id', label: 'Cliente', span: 2, type: 'select', source: 'clients', includeEmpty: false },
        { type: 'break' },
        { name: 'date', label: 'Data', span: 2, type: 'date' },
        { name: 'time_start', label: 'Hora de Início', span: 1, cls: 'sm' },
        { name: 'time_end', label: 'Hora de Término', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'pendente', label: 'Pendente' },
          { value: 'confirmada', label: 'Confirmada' },
          { value: 'cancelada', label: 'Cancelada' },
          { value: 'concluida', label: 'Concluída' }
        ], cls: 'sm', includeEmpty: false }
      ],
      visitors: [
        { name: 'name', label: 'Nome do Visitante', span: 3 },
        { name: 'client_id', label: 'Cliente', span: 2, type: 'select', source: 'clients', includeEmpty: false, required: true },
        { type: 'break' },
        { name: 'company_id', label: 'Empresa', span: 2, type: 'select', source: 'companies' },
        { name: 'rg', label: 'RG', span: 1, cls: 'sm' },
        { name: 'cpf', label: 'CPF', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'email', label: 'E-mail', span: 2 },
        { name: 'phone', label: 'Telefone', span: 1, cls: 'sm' },
        { name: 'whatsapp', label: 'WhatsApp', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'observations', label: 'Observações', span: 4, type: 'textarea' }
      ],
      amenities: [
        { name: 'name', label: 'Comodidade', span: 3 },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false }
      ],
      campaigns: [
        { name: 'name', label: 'Campanha', span: 3 },
        { name: 'type', label: 'Tipo', span: 2 },
        { name: 'start_date', label: 'Início', span: 1, cls: 'sm', type: 'date' },
        { name: 'end_date', label: 'Término', span: 1, cls: 'sm', type: 'date' },
        { type: 'break' },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false }
      ],
      vouchers: [
        { name: 'code', label: 'Código', span: 1, cls:'sm' },
        { name: 'type', label: 'Tipo', span: 1, type: 'select', options: [ {value:'percent',label:'% Desconto'}, {value:'fixed',label:'Valor Fixo'} ], cls:'sm', includeEmpty:false },
        { name: 'value', label: 'Valor', span: 1, cls:'sm' },
        { name: 'max_discount', label: 'Teto máx. (opcional)', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'discount_owner', label: 'Quem assume o desconto?', span: 2, type: 'select', cls:'sm', includeEmpty:false, options: [
          { value: 'platform_only',   label: 'Somente plataforma' },
          { value: 'advertiser_only', label: 'Somente anunciante' },
          { value: 'split_equal',     label: 'Plataforma e anunciante (50/50)' },
          { value: 'platform_first',  label: 'Consome primeiro da plataforma, depois anunciante' },
          { value: 'advertiser_first',label: 'Consome primeiro do anunciante, depois plataforma' }
        ] },
        { type: 'break' },
        { name: 'advertiser_id', label: 'Anunciante (opcional)', span: 2, type: 'select', source: 'advertisers', includeEmpty: true },
        { name: 'room_id', label: 'Sala (opcional)', span: 2, type: 'select', source: 'rooms', includeEmpty: true },
        { type: 'break' },
        { name: 'client_id', label: 'Cliente (opcional)', span: 2, type: 'select', source: 'clients', includeEmpty: true },
        { name: 'max_uses', label: 'Qtd. máxima de usos', span: 1, cls:'sm' },
        { name: 'used_count', label: 'Usos realizados', span: 1, cls:'sm', readonly: true },
        { type: 'break' },
        { name: 'starts_at', label: 'Válido a partir de', span: 1, cls:'sm', type: 'date' },
        { name: 'ends_at', label: 'Válido até', span: 1, cls:'sm', type: 'date' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [ {value:'ativo',label:'Ativo'}, {value:'inativo',label:'Inativo'} ], cls:'sm', includeEmpty:false },
        { name: 'notes', label: 'Observações', span: 4, type: 'textarea' }
      ],
      posts: [
        { type: 'break', label: 'Metadados' },
        { name: 'title', label: 'Título da matéria', span: 4, required: true },
        { type: 'break' },
        { name: 'slug', label: 'Slug (URL amigável)', span: 2, cls:'sm' },
        { name: 'category_id', label: 'Categoria', span: 1, cls:'sm', type: 'select', source: 'post_categories', includeEmpty: false, required: true },
        { name: 'author_name', label: 'Autor (opcional)', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 2, type: 'select', cls:'sm', includeEmpty:false, options: [
          { value: 'rascunho', label: 'Rascunho' },
          { value: 'publicado', label: 'Publicado' },
          { value: 'arquivado', label: 'Arquivado' }
        ]},
        { name: 'published_at', label: 'Publicado em (agendamento)', span: 2, cls:'sm', type: 'datetime-local' },
        { type: 'break', label: 'Resumo' },
        { name: 'summary', label: 'Resumo curto (aparece nos cards)', span: 4, type: 'textarea' },
        { type: 'break', label: 'Conteúdo' },
        { name: 'content', label: 'Texto da matéria', span: 4, type: 'richtext', rows: 10 },
        { type: 'break', label: 'Imagem de capa' },
        { name: 'cover_file', label: 'Upload de capa (JPG/PNG/WEBP)', span: 2, type: 'file' },
        { name: 'cover_path', label: 'Caminho da capa (preenchido automaticamente)', span: 2, readonly: true },
        { name: 'views_count', label: 'Visualizações', span: 1, cls:'sm', readonly: true }
      ],
      admin_profiles: [
        { name: 'name', label: 'Nome do perfil', span: 3, required: true },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false },
        { type: 'break', label: 'Permissões por funcionalidade' },
        { name: 'permissions_json', label: 'Permissões', span: 4, type: 'permissions' }
      ],
      admins: [
        { name: 'name', label: 'Nome', span: 2 },
        { name: 'username', label: 'Usuário', span: 1, cls: 'sm', required: true },
        { name: 'email', label: 'E-mail', span: 2 },
        { type: 'break' },
        { name: 'profile_id', label: 'Perfil', span: 2, type: 'select', source: 'admin_profiles', includeEmpty: true },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'is_master', label: 'Admin master', span: 1, type: 'select', options: [
          { value: 1, label: 'Sim' },
          { value: 0, label: 'Não' }
        ], cls: 'sm', includeEmpty: false },
        { type: 'break' },
        { name: 'password', label: 'Senha (definir/alterar)', span: 2, type: 'password' },
        { name: 'password_hash', label: 'Senha (hash)', span: 2, readonly: true }
      ]
    };

    async function gerarCampos(obj) {
      const container = document.getElementById('modalBody');
      container.innerHTML = '';

      let schema = schemas[sec];
      if (!schema) {
        try {
          const res = await fetch(`${API_BASE}/apidescribe.php?table=${sec}`, { credentials: 'include' });
          const j = await res.json();
          if (j.success) {
            schema = j.columns
              .filter(c => !['id', 'created_at', 'updated_at'].includes(c.Field))
              .map(c => ({ name: c.Field, label: friendlyLabel(c.Field), span: 2 }));
          } else {
            container.innerHTML = '<div class="box-message">Erro ao descrever a tabela.</div>';
            return;
          }
        } catch (err) {
          console.error(err);
          container.innerHTML = '<div class="box-message">Erro ao gerar formulário.</div>';
          return;
        }
      }

      const fragment = document.createDocumentFragment();

      for (const field of schema) {
        if (field.type === 'break') {
          const div = document.createElement('div');
          div.className = 'form-break';
          div.style.gridColumn = '1 / -1';
          if (field.label) {
            div.innerHTML = `<h4 style="margin:16px 0 8px 0;color:#1D413A;font-size:15px">${escapeHtml(field.label)}</h4>`;
          } else {
            div.innerHTML = '&nbsp;';
          }
          fragment.appendChild(div);
          continue;
        }

        const wrap = document.createElement('div');
        wrap.className = `form-group col-${field.span || 1} ${field.cls || ''}`;

        const labelEl = document.createElement('label');
        labelEl.textContent = field.label || friendlyLabel(field.name);
        wrap.appendChild(labelEl);

       if (field.showIfStatus && field.showIfStatus.length > 0) {
         wrap.dataset.showIfStatus = field.showIfStatus.join(',');
          wrap.style.display = 'none';
        }

        const currentValue = (obj || {})[field.name];

        if (field.type === 'select' && field.source) {
          const sel = document.createElement('select');
          sel.name = field.name;
          if (field.includeEmpty !== false) {
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = field.placeholder || '-- Selecione --';
            sel.appendChild(emptyOpt);
          }

          try {
            const res = await fetch(`${API_BASE}/apiget.php?table=${field.source}`, { credentials: 'include' });
            const data = await res.json();
            (data.data || []).forEach(item => {
              const option = document.createElement('option');
              option.value = item.id;
              option.textContent = item.nome_fantasia || item.razao_social || item.name || item.username || item.email || `#${item.id}`;
              if (currentValue && String(currentValue) == String(item.id)) option.selected = true;
              sel.appendChild(option);
            });
          } catch (err) {
            console.error(err);
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'Erro ao carregar lista';
            sel.appendChild(errorOption);
          }

          if (field.required) sel.required = true;
          wrap.appendChild(sel);
        } else if (field.type === 'select') {
          const sel = document.createElement('select');
          sel.name = field.name;
          if (field.includeEmpty !== false) {
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = field.placeholder || '-- Selecione --';
            sel.appendChild(emptyOpt);
          }
          (field.options || []).forEach(opt => {
            const value = typeof opt === 'object' ? opt.value : opt;
            const text = typeof opt === 'object' ? opt.label : opt;
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            if (currentValue !== undefined && String(currentValue) === String(value)) option.selected = true;
            sel.appendChild(option);
          });
          if (field.required) sel.required = true;
          wrap.appendChild(sel);
        } else if (field.type === 'textarea') {
          const ta = document.createElement('textarea');
          ta.name = field.name;
          ta.rows = field.rows || 3;
          ta.value = currentValue ?? '';
          if (field.required) ta.required = true;
          if (field.readonly) {
            ta.readOnly = true;
            ta.classList.add('input-readonly');
          }
          wrap.appendChild(ta);
        } else if (field.type === 'file-multiple') {
          const div = document.createElement('div');
          div.className = 'photo-grid';
          div.innerHTML = `
            <div class="photo-preview existing-photos"></div>
            <input type="file" id="uploadFotos" multiple accept="image/*" style="margin:6px 0;">
            <div class="photo-preview new-photos"></div>
          `;
          wrap.appendChild(div);

          const existingContainer = div.querySelector('.existing-photos');
          const newPreview = div.querySelector('.new-photos');
          const fileInput = div.querySelector('#uploadFotos');

          const fotosExistentes = (obj.photo_path || '')
            .split(',')
            .map(f => f.trim())
            .filter(Boolean);

          if (fotosExistentes.length) {
            existingContainer.innerHTML = '';
            fotosExistentes.forEach(src => {
              const thumb = document.createElement('div');
              thumb.className = 'photo-thumb';
              const img = document.createElement('img');
              img.src = src;
              thumb.appendChild(img);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.innerHTML = '&times;';
              btn.addEventListener('click', () => removerFotoSala(src, thumb, existingContainer));
              thumb.appendChild(btn);
              existingContainer.appendChild(thumb);
            });
          } else {
            existingContainer.innerHTML = '<div class="photo-empty">Nenhuma foto cadastrada.</div>';
          }

          fileInput.addEventListener('change', () => {
            newPreview.innerHTML = '';
            Array.from(fileInput.files).forEach(file => {
              const reader = new FileReader();
              reader.onload = e => {
                const thumb = document.createElement('div');
                thumb.className = 'photo-thumb';
                const img = document.createElement('img');
                img.src = e.target.result;
                thumb.appendChild(img);
                newPreview.appendChild(thumb);
              };
              reader.readAsDataURL(file);
            });
          });
        } else if (field.type === 'checkbox-grid' && field.optionsSource === 'amenities') {
          const grid = document.createElement('div');
          grid.className = 'amenities-grid';
          const selecionadas = Array.isArray(obj.amenities)
            ? obj.amenities.map(String)
            : (obj.amenities ? String(obj.amenities).split(',') : []).map(s => s.trim());

          try {
            const res = await fetch(`${API_BASE}/apiget.php?table=amenities`, { credentials: 'include' });
            const data = await res.json();
            (data.data || []).forEach(am => {
              const label = document.createElement('label');
              label.className = 'checkbox-item';
              const chk = document.createElement('input');
              chk.type = 'checkbox';
              chk.name = 'amenities[]';
              chk.value = am.id;
              if (selecionadas.includes(String(am.id))) chk.checked = true;
              label.appendChild(chk);
              label.append(` ${am.name}`);
              grid.appendChild(label);
            });
          } catch (err) {
            console.error(err);
            grid.innerHTML = '<div style="color:#B00">Erro ao carregar comodidades</div>';
          }

          wrap.appendChild(grid);
        } else if (field.type === 'datetime-local') {
          const input = document.createElement('input');
          input.type = 'datetime-local';
          input.name = field.name;
          if (currentValue) {
            const d = new Date(currentValue);
            if (!Number.isNaN(d.getTime())) {
              const iso = d.toISOString().slice(0,16);
              input.value = iso;
            }
          }
          if (field.required) input.required = true;
          if (field.readonly) {
            input.readOnly = true;
            input.classList.add('input-readonly');
          }
          wrap.appendChild(input);
        } else if (field.type === 'richtext') {
          const toolbar = document.createElement('div');
          toolbar.className = 'editor-toolbar';
          toolbar.innerHTML = `
            <button type="button" class="editor-btn" data-tag="b"><span>B</span></button>
            <button type="button" class="editor-btn" data-tag="i"><span>I</span></button>
            <button type="button" class="editor-btn" data-tag="u"><span>U</span></button>
            <button type="button" class="editor-btn" data-tag="br"><span>A▾</span></button>
          `;
          const editor = document.createElement('div');
          editor.className = 'rich-editor';
          editor.contentEditable = 'true';
          editor.innerHTML = currentValue || '';
          const hidden = document.createElement('textarea');
          hidden.name = field.name;
          hidden.hidden = true;
          hidden.value = currentValue || '';

          toolbar.addEventListener('mousedown', (e) => {
            const btn = e.target.closest('[data-tag]');
            if (!btn) return;
            const tag = btn.getAttribute('data-tag');
            if (!tag) return;
            e.preventDefault();
            editor.focus();
            const sel = window.getSelection();
            if (!sel || !sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            if (!editor.contains(range.commonAncestorContainer)) {
              const node = editor;
              const lastChild = node.lastChild;
              const newRange = document.createRange();
              if (lastChild && lastChild.nodeType === Node.TEXT_NODE) {
                newRange.setStart(lastChild, lastChild.textContent.length);
              } else {
                newRange.selectNodeContents(node);
                newRange.collapse(false);
              }
              sel.removeAllRanges();
              sel.addRange(newRange);
            }
            if (tag === 'b') document.execCommand('bold', false, null);
            else if (tag === 'i') document.execCommand('italic', false, null);
            else if (tag === 'u') document.execCommand('underline', false, null);
            else if (tag === 'br') document.execCommand('insertLineBreak', false, null);
            hidden.value = editor.innerHTML || '';
          });

          editor.addEventListener('input', () => {
            hidden.value = editor.innerHTML || '';
          });

          wrap.appendChild(toolbar);
          wrap.appendChild(editor);
          wrap.appendChild(hidden);
        } else if (field.type === 'permissions') {
          const hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.name = field.name;
          const current = currentValue ? (typeof currentValue === 'string' ? (() => {
            try { return JSON.parse(currentValue); } catch { return {}; }
          })() : currentValue) : {};
          const normalized = normalizePermissions(current);
          hidden.value = JSON.stringify(normalized || {});
          wrap.appendChild(hidden);

          const grid = document.createElement('div');
          grid.className = 'permissions-grid';
          permissionCatalog.forEach(item => {
            const card = document.createElement('div');
            card.className = 'permissions-card';
            card.innerHTML = `
              <h5>${escapeHtml(item.label)}</h5>
              <div class="permissions-row">
                <label><input type="checkbox" data-perm="read">Leitura</label>
                <label><input type="checkbox" data-perm="create">Criação</label>
                <label><input type="checkbox" data-perm="update">Edição</label>
                <label><input type="checkbox" data-perm="delete">Exclusão</label>
              </div>
            `;
            const rowPerms = normalized[item.key] || {};
            card.querySelectorAll('input[type="checkbox"]').forEach(cb => {
              const permKey = cb.dataset.perm;
              cb.checked = !!rowPerms[permKey];
              cb.addEventListener('change', () => {
                const updated = JSON.parse(hidden.value || '{}');
                if (!updated[item.key]) updated[item.key] = {};
                updated[item.key][permKey] = cb.checked;
                hidden.value = JSON.stringify(updated);
              });
            });
            grid.appendChild(card);
          });
          wrap.appendChild(grid);

          const note = document.createElement('div');
          note.className = 'field-note';
          note.textContent = 'Dica: se marcar apenas leitura, o usuário verá a seção sem criar/editar/excluir.';
          wrap.appendChild(note);
        } else {
          const input = document.createElement('input');
          input.type = field.type || 'text';
          input.name = field.name;
          if (currentValue !== undefined && currentValue !== null) {
            input.value = currentValue;
          } else {
            input.value = '';
          }
          if (field.required) input.required = true;
          if (field.readonly) {
            input.readOnly = true;
            input.classList.add('input-readonly');
          }
          wrap.appendChild(input);
        }

        fragment.appendChild(wrap);
      }

      container.appendChild(fragment);

      // Ajustes específicos por seção
      if (sec === 'vouchers') {
        const codeWrap = container.querySelector('input[name="code"]')?.parentElement;
        const codeInput = container.querySelector('input[name="code"]');
        if (codeWrap && codeInput) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-secondary btn-sm';
          btn.textContent = 'Gerar código';
          btn.style.marginTop = '6px';
          btn.addEventListener('click', () => {
            codeInput.value = gerarCodigoVoucher();
          });
          codeWrap.appendChild(btn);
          codeInput.placeholder = 'Ex.: ZE-' + gerarCodigoVoucher().slice(0,6);
        }
      } else if (sec === 'advertisers') {
        const feeRoomInput = container.querySelector('input[name="fee_pct_room"]');
        const feeWorkshopInput = container.querySelector('input[name="fee_pct_workshop"]');
        const legacyFeeInput = container.querySelector('input[name="fee_pct"]');
        const defaultFee = legacyFeeInput?.value || '15.00';
        if (feeRoomInput && (!feeRoomInput.value || feeRoomInput.value === '0')) feeRoomInput.value = defaultFee;
        if (feeWorkshopInput && (!feeWorkshopInput.value || feeWorkshopInput.value === '0')) feeWorkshopInput.value = defaultFee;

        // Autocomplete de bancos (BACEN) nos campos bank_code/bank_name
        (async () => {
          const banks = await loadBanksCSV();
          const codeInput = container.querySelector('input[name="bank_code"]');
          const nameInput = container.querySelector('input[name="bank_name"]');
          if (!codeInput || !nameInput) return;

          const wrap = codeInput.parentElement;
          const label = wrap && wrap.querySelector('label');
          if (label) label.textContent = 'Banco';

          const codeListId = 'adminBankCodeList';
          const nameListId = 'adminBankNameList';
          codeInput.setAttribute('list', codeListId);
          nameInput.setAttribute('list', nameListId);

          const codeList = document.createElement('datalist');
          codeList.id = codeListId;
          const nameList = document.createElement('datalist');
          nameList.id = nameListId;

          banks.forEach(b => {
            if (!b.code || !b.name) return;
            const codeOpt = document.createElement('option');
            codeOpt.value = b.code;
            codeOpt.label = b.name;
            codeList.appendChild(codeOpt);
            const nameOpt = document.createElement('option');
            nameOpt.value = b.name;
            nameList.appendChild(nameOpt);
          });

          wrap.appendChild(codeList);
          wrap.appendChild(nameList);

          const bankNameByCode = new Map(banks.map(b => [String(b.code), b.name]));
          const normalizeKey = (value) => (value || '').toLowerCase().replace(/[^a-z0-9]/g, '');
          const bankCodeByName = new Map(banks.map(b => [normalizeKey(b.name), String(b.code)]));

          codeInput.addEventListener('input', () => {
            const code = codeInput.value.trim();
            const name = bankNameByCode.get(code);
            if (name) nameInput.value = name;
          });
          nameInput.addEventListener('input', () => {
            const code = bankCodeByName.get(normalizeKey(nameInput.value));
            if (code) codeInput.value = code;
          });
        })();
      }

      aplicarMascarasPadrao(container);

      if (sec === 'visitors') {
        await configurarVisitanteEmpresa(container);
      }

      const statusField = container.querySelector('select[name="status"]');
      if (statusField) {
        const toggleConditional = () => {
          const val = statusField.value;
          container.querySelectorAll('[data-show-if-status]').forEach(divEl => {
            const allowed = val && divEl.dataset.showIfStatus.split(',').includes(val);
            if (allowed) {
              divEl.classList.remove('field-hidden');
            } else {
              divEl.classList.add('field-hidden');
            }
            divEl.querySelectorAll('input').forEach(inp => {
              if (allowed) {
                inp.removeAttribute('disabled');
              } else {
                inp.value = '';
                inp.setAttribute('disabled', 'disabled');
              }
            });
          });
        };
        statusField.addEventListener('change', toggleConditional);
        toggleConditional();
      }
    }

    function gerarCodigoVoucher() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s = '';
      for (let i = 0; i < 10; i++) s += chars[Math.floor(Math.random()*chars.length)];
      return 'ZEF-' + s;
    }

    async function salvarItem(e) {
      e.preventDefault();
      const form = document.getElementById('modalForm');
      const inputs = form.querySelectorAll('input, textarea, select');
      const record = {};

      inputs.forEach(input => {
        if (!input.name) return;
        if (input.name.endsWith('[]')) {
          const base = input.name.slice(0, -2);
          if (!record[base]) record[base] = [];
          if (input.checked) record[base].push(input.value);
        } else if (input.type === 'checkbox') {
          record[input.name] = input.checked ? input.value : '';
        } else {
          record[input.name] = input.value;
        }
      });

      if (itemEdit && itemEdit.id) record.id = itemEdit.id;
      if (Array.isArray(record.amenities)) {
        record.amenities = record.amenities.map(v => parseInt(v, 10)).filter(Boolean);
      }
      if (sec === 'rooms' && record.facilitated_access !== undefined) {
        record.facilitated_access = parseInt(record.facilitated_access, 10) || 0;
      }
      if (sec === 'admins') {
        if (!record.password) delete record.password;
        if (record.is_master !== undefined) record.is_master = Number(record.is_master) ? 1 : 0;
        if (record.profile_id === '') record.profile_id = null;
      }

      Object.keys(record).forEach(chave => {
        if (/cpf/i.test(chave) && record[chave]) {
          record[chave] = somenteDigitos(record[chave]).slice(0, 11);
        }
        if (/(phone|telefone|whatsapp)/i.test(chave) && record[chave]) {
          record[chave] = somenteDigitos(record[chave]).slice(0, 11);
        }
      });

      let postCoverFile = null;
      if (sec === 'posts') {
        postCoverFile = form.querySelector('input[name="cover_file"]') || null;
        if (postCoverFile) {
          delete record.cover_file;
        }
      }

      try {
        const res = await fetch(`${API_BASE}/apisave.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ table: sec, record })
        });
        const resp = await res.json();
        if (resp.success) {
          const recordId = resp.insertId || record.id;
          if (sec === 'rooms') {
            await uploadFotosSala(recordId);
          } else if (sec === 'posts' && postCoverFile && postCoverFile.files && postCoverFile.files[0]) {
            await uploadPostCover(recordId, postCoverFile.files[0]);
          }
          fecharModal();
          loadSection(sec);
        } else {
          alert(resp.error || resp.message || 'Erro ao salvar registro.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao conectar com o servidor.');
      }
    }

    async function uploadFotosSala(id) {
      const fileInput = document.getElementById('uploadFotos');
      if (!fileInput || !fileInput.files.length) return;

      const formData = new FormData();
      formData.append('id', id);
      Array.from(fileInput.files).forEach(file => formData.append('files[]', file));

      try {
        const res = await fetch(`${API_BASE}/apiuploadroomphoto.php`, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const json = await res.json();
        if (json.success) {
          fileInput.value = '';
          const modalBody = document.getElementById('modalBody');
          const newPreview = modalBody.querySelector('.new-photos');
          if (newPreview) newPreview.innerHTML = '';
          const existingContainer = modalBody.querySelector('.existing-photos');
          if (existingContainer) {
            if (existingContainer.querySelector('.photo-empty')) {
              existingContainer.innerHTML = '';
            }
            (json.uploaded || []).forEach(src => {
              const thumb = document.createElement('div');
              thumb.className = 'photo-thumb';
              const img = document.createElement('img');
              img.src = src;
              thumb.appendChild(img);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.innerHTML = '&times;';
              btn.addEventListener('click', () => removerFotoSala(src, thumb, existingContainer));
              thumb.appendChild(btn);
              existingContainer.appendChild(thumb);
            });
          }
          if (itemEdit && itemEdit.id == id) {
            itemEdit.photo_path = json.photo_path || '';
          }
          const idx = dadosJSON.findIndex(r => r.id == id);
          if (idx !== -1) dadosJSON[idx].photo_path = json.photo_path || '';
        } else {
          console.warn('Falha no upload:', json.error || json.message);
        }
      } catch (err) {
        console.error('Erro ao enviar fotos:', err);
      }
    }

    async function uploadPostCover(id, file) {
      if (!id || !file) return;
      const formData = new FormData();
      formData.append('id', id);
      formData.append('file', file);
      try {
        const res = await fetch(`${API_BASE}/upload_post_cover.php`, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const json = await res.json();
        if (!json.success) {
          console.error('Falha ao enviar capa do post:', json.error || json.message);
        }
      } catch (e) {
        console.error('Erro ao enviar capa do post', e);
      }
    }

    async function removerFotoSala(photoPath, thumbEl, container) {
      if (!itemEdit || !itemEdit.id) {
        alert('Selecione uma sala antes de remover fotos.');
        return;
      }
      if (!confirm('Deseja remover esta foto?')) return;

      try {
        const res = await fetch(`${API_BASE}/apidelete_room_photo.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ roomId: itemEdit.id, photo: photoPath })
        });
        const json = await res.json();
        if (json.success) {
          if (thumbEl && thumbEl.parentElement) thumbEl.remove();
          if (container && !container.querySelector('.photo-thumb')) {
            container.innerHTML = '<div class="photo-empty">Nenhuma foto cadastrada.</div>';
          }
          itemEdit.photo_path = json.photo_path || '';
          const idx = dadosJSON.findIndex(r => r.id == itemEdit.id);
          if (idx !== -1) dadosJSON[idx].photo_path = itemEdit.photo_path;
        } else {
          alert(json.error || 'Não foi possível remover a foto.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao remover foto.');
      }
    }

    async function excluirItem(id) {
      try {
        const res = await fetch(`${API_BASE}/apidelete.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ table: sec, id })
        });
        const json = await res.json();
        if (json.success) {
          loadSection(sec);
        } else {
          alert(json.error || 'Erro ao excluir registro.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao excluir registro.');
      }
    }

    async function excluirTotalCliente(id) {
      if (!id) return;
      const ok = confirm('ETR: excluir COMPLETAMENTE este cliente e todos os registros vinculados? Esta ação é irreversível e apenas para testes.');
      if (!ok) return;
      try {
        const res = await fetch(`${API_BASE}/admin_delete_client_cascade.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ client_id: id })
        });
        const json = await res.json();
        if (json.success) {
          alert('Cliente e registros vinculados excluídos.');
          loadSection('clients');
        } else {
          throw new Error(json.error || 'Erro ao excluir cliente.');
        }
      } catch (err) {
        console.error(err);
        alert(err.message || 'Erro ao excluir cliente.');
      }
    }

    let reservasModalSalaId = null;
    const reservasModalEl = document.getElementById('reservasModal');
    const reservasListaEl = document.getElementById('reservasLista');
    const reservasModalTitle = document.getElementById('reservasModalTitle');

    function abrirChamadaReservas(roomId) {
      const roomData = dadosJSON.find(r => r.id == roomId) || {};
      reservasModalSalaId = roomId;
      reservasModalEl.classList.add('show');
      reservasModalTitle.textContent = `Reservas da sala ${roomData.name || `#${roomId}`}`;
      reservasListaEl.innerHTML = '<div class="reservations-empty">Carregando reservas...</div>';
      carregarReservasSala(roomId, reservasListaEl);
    }

    function fecharReservasModal() {
      reservasModalSalaId = null;
      reservasModalEl.classList.remove('show');
      if (reservasListaEl) {
        reservasListaEl.innerHTML = '<div class="reservations-empty">Selecione uma sala para visualizar as reservas.</div>';
      }
    }

    async function carregarReservasSala(roomId, targetList) {
      const list = targetList || reservasListaEl;
      if (!list) return;
      try {
        const res = await fetch(`${API_BASE}/room_reservations.php?room_id=${roomId}`, { credentials: 'include' });
        const json = await res.json();
        if (json.success) {
          renderReservasSala(json.data || [], list, roomId);
        } else {
          list.innerHTML = `<div class="reservations-empty">${escapeHtml(json.error || 'Não foi possível carregar as reservas.')}</div>`;
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="reservations-empty">Erro ao carregar reservas.</div>';
      }
    }

    function renderReservasSala(reservas, targetList, roomId) {
      if (!targetList) return;
      if (!reservas.length) {
        targetList.innerHTML = '<div class="reservations-empty">Nenhuma reserva encontrada.</div>';
        return;
      }
      targetList.innerHTML = '';
      reservas.forEach(reserva => {
        const item = document.createElement('div');
        item.className = 'reservation-item';

        const periodo = `${formatDate(reserva.date) || '-'}${reserva.time_start ? ' • ' + formatTime(reserva.time_start) : ''}${reserva.time_end ? ' - ' + formatTime(reserva.time_end) : ''}`;
        item.innerHTML = `
          <div><strong>${escapeHtml(periodo)}</strong></div>
          <div>Cliente: ${escapeHtml(reserva.client_name || '---')}</div>
          <div>Status: ${escapeHtml(statusLabels[reserva.status] || reserva.status || '-')}</div>
          ${reserva.title ? `<div>Título: ${escapeHtml(reserva.title)}</div>` : ''}
          ${reserva.description ? `<div>${escapeHtml(reserva.description)}</div>` : ''}
          ${reserva.notes ? `<div>Notas: ${escapeHtml(reserva.notes)}</div>` : ''}
        `;

        const actions = document.createElement('div');
        actions.className = 'reservation-actions';

        if (reserva.status === 'pendente') {
          const confirmar = document.createElement('button');
          confirmar.className = 'btn-res';
          confirmar.type = 'button';
          confirmar.textContent = 'Confirmar';
          confirmar.onclick = () => alterarStatusReserva(reserva.id, 'confirm', roomId || reserva.room_id);
          actions.appendChild(confirmar);

          const negar = document.createElement('button');
          negar.className = 'btn-res secondary';
          negar.type = 'button';
          negar.textContent = 'Negar';
          negar.onclick = () => alterarStatusReserva(reserva.id, 'deny', roomId || reserva.room_id);
          actions.appendChild(negar);
        } else if (reserva.status === 'confirmada') {
          const cancelar = document.createElement('button');
          cancelar.className = 'btn-res warning';
          cancelar.type = 'button';
          cancelar.textContent = 'Cancelar';
          cancelar.onclick = () => alterarStatusReserva(reserva.id, 'cancel', roomId || reserva.room_id);
          actions.appendChild(cancelar);
        }

        if (actions.children.length) {
          item.appendChild(actions);
        }

        targetList.appendChild(item);
      });
    }

    async function alterarStatusReserva(id, action, roomId) {
      if (!id) return;
      if (action === 'deny' && !confirm('Deseja negar esta reserva?')) return;
      if (action === 'cancel' && !confirm('Deseja cancelar esta reserva?')) return;
      try {
        const res = await fetch(`${API_BASE}/update_reservation_status.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ id, action })
        });
        const json = await res.json();
        if (json.success) {
          if (sec === 'reservations') {
            loadSection('reservations');
          }
          const alvo = roomId || reservasModalSalaId;
          if (alvo) {
            carregarReservasSala(alvo, reservasListaEl);
          }
        } else {
          alert(json.error || 'Não foi possível atualizar o status.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao atualizar status.');
      }
    }

    async function resetSenhaCliente(id) {
      if (!id) return;
      if (!confirm('Gerar uma nova senha temporária para este cliente?')) return;
      try {
        const res = await fetch(`${API_BASE}/admin_reset_client_password.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ client_id: id })
        });
        const json = await res.json();
        if (json.success) {
          alert(`Senha temporária gerada: ${json.newPassword}\nO cliente será avisado por e-mail.`);
        } else {
          alert(json.error || 'Não foi possível resetar a senha.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao resetar a senha.');
      }
    }

    async function geocodificarSalaAtual(roomId) {
      if (!roomId) return;
      if (!confirm('Tentar localizar esta sala no mapa usando o endereço?')) return;
      try {
        const res = await fetch(`${API_BASE}/geocode_room.php`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room_id: roomId }) });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao geocodificar.');
        alert('Localização atualizada com sucesso.');
      } catch (e) { alert(e.message || 'Erro ao geocodificar.'); }
    }

    async function listarClientesEmpresa(id, nome) {
      companyClientsCompanyId = id;
      companyClientsTitle.textContent = `Clientes de ${nome}`;
      companyClientsList.innerHTML = '<div class="reservations-empty">Carregando...</div>';
      companyClientsModal.classList.add('show');
      try {
        const [cRes, iRes] = await Promise.all([
          fetch(`${API_BASE}/apiget.php?table=clients&company_id=${id}`, { credentials:'include' }),
          fetch(`${API_BASE}/apiget.php?table=company_invitations&company_id=${id}`, { credentials:'include' })
        ]);
        const cJson = await cRes.json();
        const iJson = await iRes.json();
        const clients = cJson.success ? (cJson.data || []) : [];
        const invites = iJson.success ? (iJson.data || []) : [];
        renderCompanyClients(clients, invites);
      } catch (err) {
        console.error(err);
        companyClientsList.innerHTML = `<div class="reservations-empty">${escapeHtml(err.message)}</div>`;
      }
    }

    function renderCompanyClients(lista, invites) {
      const rows = (lista || []).map(client => {
        const statusHtml = statusFormatter(client.status);
        const role = client.company_role || '-';
        return `
          <tr>
            <td>${escapeHtml(client.name || '--')}</td>
            <td>${escapeHtml(client.email || '--')}</td>
            <td>${escapeHtml(client.login || '--')}</td>
            <td>${escapeHtml(role)}</td>
            <td>${statusHtml}</td>
            <td>
              <button class=\"btn-micro confirm\" onclick=\"definirMasterEmpresa(${companyClientsCompanyId},${client.id})\">Master</button>
              <button class=\"btn-micro cancel\" onclick=\"removerUsuarioEmpresa(${companyClientsCompanyId},${client.id})\">Remover</button>
            </td>
          </tr>
        `;
      }).join('');

      const invRows = (invites || []).map(i => {
        const created = i.created_at ? String(i.created_at).slice(0,10).split('-').reverse().join('/') : '-';
        const statusLower = String(i.status||'').toLowerCase();
        const canCancel = statusLower === 'pendente';
        const canResend = statusLower === 'pendente' || statusLower === 'expirado';
        const actions = `
          ${canResend ? `<button class=\"btn-micro confirm\" onclick=\"adminReenviarConvite(${i.id}, ${companyClientsCompanyId})\">Reenviar</button>` : ''}
          ${canCancel ? `<button class=\"btn-micro cancel\" onclick=\"adminCancelarConvite(${i.id}, ${companyClientsCompanyId})\">Cancelar</button>` : ''}
        `;
        const email = i.invite_email || '';
        return `<tr><td>${escapeHtml(i.cpf || '')}</td><td>${escapeHtml(email)}</td><td>${escapeHtml(i.role || 'membro')}</td><td>${escapeHtml(i.status || 'pendente')}</td><td>${created}</td><td>${actions}</td></tr>`;
      }).join('');

      companyClientsList.innerHTML = `
        <div style=\"margin-bottom:12px;display:flex;gap:8px;align-items:center\">
          <input id=\"cpfAddEmpresa\" type=\"text\" placeholder=\"CPF do cliente\" oninput=\"this.value=this.value.replace(/[^0-9.\-]/g,'')\" style=\"padding:8px 10px;border:1px solid #ccc;border-radius:6px\" />
          <select id=\"roleAddEmpresa\" style=\"padding:8px 10px;border:1px solid #ccc;border-radius:6px\">
            <option value=\"membro\">Membro</option>
            <option value=\"gestor\">Gestor</option>
            <option value=\"leitor\">Leitor</option>
            <option value=\"admin\">Admin</option>
          </select>
          <button class=\"btn-ghost\" onclick=\"convidarUsuarioEmpresa()\">Convidar por CPF</button>
        </div>
        ${rows ? `
        <table>
          <thead>
            <tr><th>Nome</th><th>E-mail</th><th>Login</th><th>Papel</th><th>Status</th><th>Ações</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>` : '<div class=\\"reservations-empty\\">Nenhum cliente vinculado.</div>'}
        <h4 style=\"margin:14px 0 6px\">Convites</h4>
        ${invRows ? `
        <table>
          <thead><tr><th>CPF</th><th>E-mail</th><th>Papel</th><th>Status</th><th>Enviado em</th><th>Ações</th></tr></thead>
          <tbody>${invRows}</tbody>
        </table>` : '<div class=\\"reservations-empty\\">Nenhum convite emitido.</div>'}
      `;
    }

    async function definirMasterEmpresa(companyId, clientId) {
      if (!companyId || !clientId) return;
      if (!confirm('Definir este cliente como usuário master da empresa?')) return;
      try {
        const res = await fetch(`${API_BASE}/company_set_master.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ company_id: companyId, client_id: clientId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao definir master');
        alert(json.message || 'Usuário master definido.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ', ''));
      } catch (e) {
        console.error(e);
        alert(e.message || 'Erro ao definir master');
      }
    }

    function fecharCompanyModal() {
      companyClientsModal.classList.remove('show');
    }

    companyClientsModal.addEventListener('click', (event) => {
      if (event.target === companyClientsModal) fecharCompanyModal();
    });
    reservationEmailsModal.addEventListener('click', (event) => {
      if (event.target === reservationEmailsModal) fecharEmailsModal();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      const modalPrincipal = document.getElementById('modal');
      if (reservasModalEl.classList.contains('show')) {
        fecharReservasModal();
      } else if (reservationEmailsModal.classList.contains('show')) {
        fecharEmailsModal();
      } else if (companyClientsModal.classList.contains('show')) {
        fecharCompanyModal();
      } else if (modalPrincipal.classList.contains('show')) {
        fecharModal();
      }
    });

    async function convidarUsuarioEmpresa(){
      const cpfEl = document.getElementById('cpfAddEmpresa');
      const roleEl = document.getElementById('roleAddEmpresa');
      const cpf = (cpfEl?.value || '').replace(/\D/g,'');
      const role = roleEl?.value || 'membro';
      if (!companyClientsCompanyId) { alert('Empresa não definida.'); return; }
      if (cpf.length !== 11) { alert('Informe um CPF válido.'); return; }
      try {
        const res = await fetch(`${API_BASE}/company_invite_user.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ company_id: companyClientsCompanyId, cpf, role })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Não foi possível enviar o convite.');
        alert(json.message || 'Convite enviado.');
      } catch (e) {
        console.error(e); alert(e.message || 'Falha ao convidar.');
      }
    }

    function abrirEmailsModal(reservationId) {
      reservationEmailTarget = reservationId;
      reservationEmailsTitle.textContent = `Disparar e-mails (Reserva #${reservationId})`;
      emailModalStatus.style.display = 'none';
      reservationEmailsModal.classList.add('show');
    }

    function fecharEmailsModal() {
      reservationEmailTarget = null;
      reservationEmailsModal.classList.remove('show');
    }

    async function dispararEmailReserva(tipo) {
      if (!reservationEmailTarget) return;
      emailModalStatus.style.display = 'block';
      emailModalStatus.style.color = '#1D413A';
      emailModalStatus.textContent = 'Enviando...';
      try {
        const res = await fetch(`${API_BASE}/admin_send_reservation_email.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reservation_id: reservationEmailTarget, type: tipo })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao enviar e-mail.');
        emailModalStatus.textContent = json.message || 'E-mail enviado.';
        showToast('E-mail disparado.');
      } catch (err) {
        emailModalStatus.style.color = '#B54A3A';
        emailModalStatus.textContent = err.message || 'Erro ao enviar e-mail.';
      }
    }

    async function removerUsuarioEmpresa(companyId, clientId){
      if (!confirm('Remover o vínculo deste usuário com a empresa?')) return;
      try {
        const res = await fetch(`${API_BASE}/company_remove_user.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ company_id: companyId, client_id: clientId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Não foi possível remover.');
        alert(json.message || 'Removido.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ',''));
      } catch (e) {
        console.error(e); alert(e.message || 'Erro ao remover.');
      }
    }

    async function adminCancelarConvite(inviteId, companyId){
      if (!confirm('Cancelar este convite?')) return;
      try {
        const res = await fetch(`${API_BASE}/company_cancel_invite.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ id: inviteId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao cancelar.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ',''));
      } catch (e) {
        alert(e.message || 'Erro ao cancelar convite.');
      }
    }

    async function adminReenviarConvite(inviteId, companyId){
      try {
        const res = await fetch(`${API_BASE}/company_resend_invite.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ id: inviteId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao reenviar.');
        alert(json.message || 'Convite reenviado.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ',''));
      } catch (e) {
        alert(e.message || 'Erro ao reenviar convite.');
      }
    }

  </script>
</body>
</html>
