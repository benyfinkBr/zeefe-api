<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Ze.EFE Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style-admin.css">

  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; background:#F5F0E9; font-family:'Inter',system-ui,sans-serif; color:#1D413A; }

    /* LOGIN */
    #login{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#F5F0E9 0%,#EDE7DF 100%);z-index:9999}
    .login-card{background:#FFF;border-radius:18px;padding:48px 56px;box-shadow:0 6px 24px rgba(0,0,0,.08);max-width:400px;width:90%;text-align:center}
    .login-card img{width:140px;margin-bottom:28px}
    .login-card h2{font-weight:600;color:#1D413A;margin-bottom:28px;font-size:1.25rem}
    .login-card input{width:100%;padding:10px 12px;margin:6px 0 16px;border:1px solid #CCC;border-radius:8px;font-size:14px;background:#F9F9F8;color:#1D413A}
    .login-card button{width:100%;padding:12px 0;background:#1D413A;color:#F5F0E9;font-weight:600;border:none;border-radius:8px;cursor:pointer}
    .error-message{color:#B00;font-size:14px;margin-top:10px;display:none}
    .remember-line{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#1D413A;margin:-8px 0 16px}
    .remember input[type="checkbox"]{accent-color:#1D413A;width:16px;height:16px;cursor:pointer}
    .remember span{margin-left:6px;cursor:pointer}

    /* APP */
    #app{display:none;height:100vh;width:100vw;overflow:hidden}
    .sidebar{width:240px;background:#1D413A;color:#F5F0E9;display:flex;flex-direction:column;padding:24px 0}
    .sidebar img{width:130px;margin:0 auto 20px}
    .sidebar ul{list-style:none;padding:0;margin:0;flex-grow:1}
    .sidebar ul li{padding:12px 28px;cursor:pointer;font-size:15px}
    .sidebar ul li:hover,.sidebar ul li.active{background:#16332E}
    .logout-link{padding:12px 28px;border-top:1px solid rgba(255,255,255,.1);cursor:pointer}

    main.content{flex:1;display:flex;flex-direction:column;background:#F5F0E9;overflow-y:auto}
    .section-header{background:#FFF;padding:16px 24px;border-bottom:1px solid #E0DAD1;display:flex;align-items:center;justify-content:space-between}
    .section-header h2{margin:0;font-size:20px;font-weight:600}
    .search-filters{background:#FFF;padding:12px 24px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #E0DAD1}
    .search-filters input{flex:1;border:1px solid #CCC;border-radius:8px;padding:8px 10px;font-size:14px}
.btn{background:#1D413A;color:#F5F0E9;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:14px}
.btn-warning{background:#B54A3A;color:#F5F0E9;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:14px}
.btn-warning:hover{background:#9c3f32}
.btn-secondary{background:#F5F0E9;color:#1D413A;border:1px solid #1D413A;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:14px}
.btn-secondary:hover{background:#E6DED4}
    .table-container{padding:24px}
    table{width:100%;border-collapse:collapse;background:#FFF;border-radius:8px;overflow:hidden}
    thead{background:#EDE7DF;color:#1D413A;font-weight:600}
    th,td{padding:15px 17px;text-align:left;border-bottom:1px solid #EEE}
    .box-message{text-align:center;padding:48px;color:#1D413A}

    /* MODAL */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);justify-content:center;align-items:center;z-index:10000}
    .modal.show{display:flex}
    .modal-content{background:#FFF;border-radius:14px;width:96%;max-width:1180px;max-height:93vh;overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.15);display:flex;flex-direction:column}
    .modal-header{position:sticky;top:0;z-index:10;background:#FFF;display:flex;justify-content:space-between;align-items:center;padding:16px 28px;border-bottom:1px solid #eee}
    .modal-header h3{margin:0;font-size:18px;color:#1D413A}
    .modal-close{border:none;background:none;font-size:26px;color:#666;cursor:pointer}
    .modal-body{flex:1;overflow-y:auto;background:#FAF8F5;padding:28px 36px;border-radius:10px}

/* GRID FORM — espaçamento reduzido real */
/* GRID FORM — versão forçada compacta */
.form-grid {
  display: grid !important;
  grid-template-columns: repeat(4, 1fr) !important;
  row-gap: 4px !important;       /* distância vertical mínima */
  column-gap: 10px !important;   /* distância horizontal menor */
  align-items: start !important;
}

.input-readonly {
  background: #EFECE5 !important;
  color: #6d6d6d !important;
}

.form-group {
  display: flex !important;
  flex-direction: column !important;
  margin: 0 !important;
  padding: 0 !important;
}

label {
  font-size: 13px !important;
  font-weight: 500 !important;
  color: #1D413A !important;
  margin-bottom: 2px !important;
}

input, select {
  width: 100% !important;
  padding: 10px 12px !important;   /* altura maior */
  border-radius: 6px !important;
  border: 1px solid #d3d3d3 !important;
  font-size: 15px !important;      /* texto ligeiramente maior */
  background: #fff !important;
  box-sizing: border-box !important;
  line-height: 1.4 !important;
}

/* Pequenos continuam menores */
.sm input, .sm select {
  max-width: 130px !important;
  padding: 8px 10px !important;
  font-size: 14px !important;
}

/* campos pequenos */
.sm input, .sm select {
  max-width: 120px !important;
}

/* ajusta área interna do modal */
.modal-body {
  flex: 1 !important;
  overflow-y: auto !important;
  background: #FAF8F5 !important;
  padding: 16px 26px !important;
}
/* Reduz espaço visual dos breaks entre linhas */
.form-break {
  grid-column: 1 / -1 !important;
  height: 6px !important;    /* antes ficava em ~20px */
}

/* campos pequenos */
.sm input,.sm select{max-width:140px}

  /* Corrige largura dos campos de span 4 — linha inteira */
.col-4 {
  grid-column: 1 / -1 !important; /* força ocupar 100% da largura */
}

.col-3 {
  grid-column: span 3 !important;
}

.col-2 {
  grid-column: span 2 !important;
}

.col-1 {
  grid-column: span 1 !important;
}
 
.photo-grid { display:flex; flex-direction:column; gap:8px; }
.photo-preview { display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:8px; }
.photo-preview img { width:100%; height:90px; object-fit:cover; border-radius:6px; border:1px solid #ccc; }
.photo-thumb { position:relative; border-radius:6px; overflow:hidden; }
.photo-thumb button { position:absolute; top:4px; right:4px; border:none; background:rgba(12,12,12,0.6); color:#fff; width:24px; height:24px; border-radius:50%; cursor:pointer; font-size:16px; line-height:20px; padding:0; display:flex; align-items:center; justify-content:center; }
.photo-thumb button:hover { background:rgba(12,12,12,0.85); }
.photo-empty { font-size:13px; color:#666; padding:12px; border:1px dashed #c4c4c4; border-radius:6px; text-align:center; }
.existing-photos { margin-bottom:6px; }
.new-photos { margin-top:6px; }
.field-hidden { display:none !important; }

.modal-reservas .modal-content { max-width: 720px; }
.reservation-list { display:flex; flex-direction:column; gap:10px; }
.reservation-item { padding:12px; border:1px solid #e0d8cd; border-radius:8px; background:#F9F6F1; }
.reservation-item strong { color:#1D413A; }
.reservation-actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
.reservation-actions button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; }
.btn-res { background:#1D413A; color:#F5F0E9; }
.btn-res.secondary { background:#b84a3a; }
.btn-res.warning { background:#d97a1c; }
.reservations-empty { padding:12px; color:#666; font-size:14px; border:1px dashed #d0c7bc; border-radius:8px; text-align:center; }

.btn-ghost {
  background: #fff;
  border: 1px solid #1D413A;
  color: #1D413A;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: background 0.2s;
}
.btn-ghost:hover { background: #E6DED4; }

.btn-micro {
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 5px;
  border: none;
  cursor: pointer;
  color: #fff;
}
.btn-micro.confirm { background: #2F6F55; }
.btn-micro.deny { background: #B54A3A; }
.btn-micro.cancel { background: #D97A1C; }
.reservation-inline {
  display: inline-flex;
  gap: 6px;
  margin-left: 10px;
  vertical-align: middle;
}

.amenities-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:8px; margin-top:4px; }
.checkbox-item { display:flex; align-items:center; font-size:13px; color:#1D413A; }
.checkbox-item input { margin-right:6px; }

  
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="login">
    <div class="login-card">
      <img src="img/logo.jpg" alt="Ze.EFE Logo">
      <h2>Painel Administrativo<br><span>Ze.EFE</span></h2>
      <form id="loginForm">
        <input type="text" name="username" placeholder="Usuário ou E-mail" required autocomplete="username">
        <input type="password" name="password" placeholder="Senha" required autocomplete="current-password">
        <div class="remember-line">
          <label class="remember">
            <input type="checkbox" name="remember"><span>Lembrar login neste computador</span>
          </label>
        </div>
        <button type="submit">Entrar</button>
        <div id="loginError" class="error-message"></div>
      </form>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <div style="display:flex;height:100%">
      <nav class="sidebar">
        <img src="img/logo.jpg" alt="Ze.EFE">
        <ul id="menu">
          <li class="menu-group">Portal de Salas</li>
          <li data-section="companies" class="active">Empresas</li>
          <li data-section="clients">Clientes</li>
          <li data-section="rooms">Salas</li>
          <li data-section="reservations">Reservas</li>
          <li data-section="visitors">Visitantes</li>
          <li data-section="vouchers">Vouchers</li>
          <li class="menu-group">Anunciantes & Ofertas</li>
          <li data-section="advertisers">Anunciantes</li>
          <li data-section="workshops">Workshops</li>
          <li class="menu-group">Participantes de Workshops</li>
          <li data-section="workshop_participants">Participantes</li>
          <li data-section="workshop_enrollments">Inscrições</li>
          <li class="menu-group">Conteúdo</li>
          <li data-section="posts">Matérias</li>
          <li class="menu-group">Configurações</li>
          <li data-section="amenities">Comodidades</li>
          <li data-section="campaigns">Campanhas</li>
          <li data-section="messages">Mensagens</li>
        </ul>
        <div class="logout-link" id="logoutBtn">Sair</div>
      </nav>

      <main class="content">
        <div class="section-header"><h2 id="content-title">Empresas</h2></div>
        <div class="search-filters" id="search-filters"></div>
        <section id="content-body"></section>
      </main>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle"></h3>
        <button class="modal-close" onclick="fecharModal()">&times;</button>
      </div>
      <form id="modalForm" onsubmit="salvarItem(event)">
        <div class="modal-body">
          <div id="modalBody" class="form-grid"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-warning" id="resetSenhaBtn" style="display:none">Resetar senha</button>
          <button type="button" class="btn-secondary" id="geocodeBtn" style="display:none">Geocodificar</button>
          <button type="button" class="btn-secondary" onclick="fecharModal()">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal modal-reservas" id="reservasModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="reservasModalTitle">Reservas da sala</h3>
        <button class="modal-close" onclick="fecharReservasModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="reservasLista" class="reservation-list">
          <div class="reservations-empty">Selecione uma sala para visualizar as reservas.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharReservasModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="companyClientsModal">
    <div class="modal-content" style="max-width:720px">
      <div class="modal-header">
        <h3 id="companyClientsTitle">Clientes da empresa</h3>
        <button class="modal-close" onclick="fecharCompanyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="companyClientsList" class="reservation-list">
          <div class="reservations-empty">Carregando...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharCompanyModal()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Mensagens (Admin) -->
  <div class="modal" id="adminMessagesModal">
    <div class="modal-content" style="max-width:1180px">
      <div class="modal-header">
        <h3>Mensagens</h3>
        <button class="modal-close" onclick="fecharAdminMessagesModal()">&times;</button>
      </div>
      <div class="modal-body" style="display:flex; gap:16px;">
        <aside style="width:260px; border-right:1px solid #DDD; padding-right:12px; display:flex; flex-direction:column; gap:12px;">
          <div>
            <h4 style="margin:0 0 4px;">Clientes</h4>
            <div id="adminClientThreads" style="max-height:60vh; overflow:auto;"></div>
          </div>
          <div>
            <h4 style="margin:12px 0 4px;">Anunciantes</h4>
            <div id="adminAdvertiserThreads" style="max-height:60vh; overflow:auto;"></div>
          </div>
        </aside>
        <section style="flex:1; display:flex; flex-direction:column; gap:8px;">
          <div id="adminMessagesHeader" class="box-message" style="padding:8px 12px; text-align:left;">Selecione uma conversa à esquerda.</div>
          <div id="adminMessagesList" class="chat-messages" style="flex:1; min-height:280px;"></div>
          <form id="adminMessagesForm" class="chat-form" style="margin-top:8px; display:none;">
            <input type="text" id="adminMessageInput" placeholder="Digite uma mensagem como admin" />
            <button type="submit" class="btn">Enviar</button>
          </form>
        </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharAdminMessagesModal()">Fechar</button>
      </div>
    </div>
  </div>
  <!-- Modal: Anunciante da Sala -->
  <div class="modal" id="advertiserModal">
    <div class="modal-content" style="max-width:720px">
      <div class="modal-header">
        <h3 id="advertiserModalTitle">Anunciante da sala</h3>
        <button class="modal-close" onclick="fecharAdvertiserModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div id="advertiserModalBody" class="form-grid"></div>
        <div id="advertiserModalMsg" class="box-message" style="display:none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="fecharAdvertiserModal()">Cancelar</button>
        <button type="button" class="btn" onclick="salvarAdvertiserSala()">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '../api';
    let sec = 'companies';
    let dadosJSON = [];
    let itemEdit = null;
    let filtro = '';
    const resetSenhaBtn = document.getElementById('resetSenhaBtn');
    const companyClientsModal = document.getElementById('companyClientsModal');
    const companyClientsTitle = document.getElementById('companyClientsTitle');
    const companyClientsList = document.getElementById('companyClientsList');
    let companyClientsCompanyId = null;

    const statusLabels = {
      ativo: 'Ativo',
      inativo: 'Inativo',
      manutencao: 'Manutenção',
      'manutenção': 'Manutenção',
      desativada: 'Desativada',
      bloqueado: 'Bloqueado',
      pendente: 'Pendente',
      confirmada: 'Confirmada',
      cancelada: 'Cancelada',
      concluida: 'Concluída'
    };

    const modalEntities = {
      companies: 'Empresa',
      clients: 'Cliente',
      advertisers: 'Anunciante',
      rooms: 'Sala',
      reservations: 'Reserva',
      visitors: 'Visitante',
      amenities: 'Comodidade',
      vouchers: 'Voucher',
      campaigns: 'Campanha',
      workshops: 'Workshop',
      workshop_participants: 'Participante de Workshop',
      workshop_enrollments: 'Inscrição de Workshop'
    };

    const reservationFilters = {
      room_id: '',
      client_id: '',
      date_range: '',
      date_from: '',
      date_to: ''
    };

    const voucherFilters = {
      status: ''
    };

    let cachedRooms = null;
    let cachedClients = null;
    let cachedBanks = null;
    let adminThreadsCache = [];
    let adminActiveThreadId = null;
    const adminMessagesModal = document.getElementById('adminMessagesModal');
    const adminClientThreads = document.getElementById('adminClientThreads');
    const adminAdvertiserThreads = document.getElementById('adminAdvertiserThreads');
    const adminMessagesHeader = document.getElementById('adminMessagesHeader');
    const adminMessagesList = document.getElementById('adminMessagesList');
    const adminMessagesForm = document.getElementById('adminMessagesForm');
    const adminMessageInput = document.getElementById('adminMessageInput');

    function escapeHtml(value) {
      return String(value ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function loadBanksCSV() {
      if (cachedBanks) return cachedBanks;
      try {
        const res = await fetch('img/Bancos.csv', { cache: 'no-store' });
        const text = await res.text();
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        if (!lines.length) { cachedBanks = []; return cachedBanks; }
        // Detect delimiter ; or ,
        const delim = (lines[0].includes(';') ? ';' : ',');
        const rows = lines.map(l => l.split(delim).map(s => s.trim()));
        // Try to detect header
        let start = 0;
        if (/cod|código|codigo|code/i.test(rows[0][0])) start = 1;
        cachedBanks = rows.slice(start).map(cols => ({ code: (cols[0]||'').replace(/\D/g,''), name: cols[1]||'' }))
          .filter(b => b.code && b.name);
      } catch (_) { cachedBanks = []; }
      return cachedBanks;
    }

    async function abrirAdminMessages() {
      const modal = adminMessagesModal;
      if (!modal) return;
      adminMessagesHeader.textContent = 'Selecione uma conversa à esquerda.';
      adminMessagesList.innerHTML = '';
      adminMessagesForm.style.display = 'none';
      adminActiveThreadId = null;
      await carregarAdminThreads();
      modal.classList.add('show');
    }

    function fecharAdminMessagesModal() {
      if (!adminMessagesModal) return;
      adminMessagesModal.classList.remove('show');
    }

    async function carregarAdminThreads() {
      try {
        const res = await fetch(API_BASE + '/messages_list_threads.php');
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao carregar conversas.');
        adminThreadsCache = json.data || [];
      } catch (e) {
        adminThreadsCache = [];
      }
      renderAdminThreads();
    }

    function renderAdminThreads() {
      if (!adminClientThreads || !adminAdvertiserThreads) return;
      adminClientThreads.innerHTML = '';
      adminAdvertiserThreads.innerHTML = '';
      const clients = adminThreadsCache.filter(t => t.client_id && !t.advertiser_id);
      const advs = adminThreadsCache.filter(t => t.advertiser_id);

      function criarItem(thread) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chat-thread-item';
        btn.textContent = `Thread #${thread.id} ${thread.reservation_id ? '· Reserva ' + thread.reservation_id : ''}`;
        btn.onclick = () => abrirConversaAdmin(thread.id);
        return btn;
      }
      clients.forEach(t => adminClientThreads.appendChild(criarItem(t)));
      advs.forEach(t => adminAdvertiserThreads.appendChild(criarItem(t)));
    }

    async function abrirConversaAdmin(id) {
      adminActiveThreadId = id;
      adminMessagesHeader.textContent = 'Carregando mensagens...';
      adminMessagesForm.style.display = 'none';
      adminMessagesList.innerHTML = '';
      try {
        const res = await fetch(API_BASE + '/messages_list_messages.php?thread_id=' + encodeURIComponent(id));
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao carregar mensagens.');
        const list = json.data || [];
        if (!list.length) {
          adminMessagesList.innerHTML = '<div class=\"box-message\">Nenhuma mensagem nesta conversa.</div>';
        } else {
          adminMessagesList.innerHTML = list.map(m => {
            const me = (m.sender_type || '') === 'admin';
            return '<div class=\"chat-bubble '+(me?'me':'them')+'\"><div class=\"chat-text\">'+escapeHtml(m.body)+'</div><div class=\"chat-time\">'+escapeHtml((m.created_at||'').toString().slice(0,16).replace('T',' '))+'</div></div>';
          }).join('');
        }
        adminMessagesHeader.textContent = 'Conversa #' + id;
        adminMessagesForm.style.display = 'flex';
      } catch (e) {
        adminMessagesHeader.textContent = e.message || 'Erro ao carregar conversa.';
      }
    }

    async function enviarMensagemAdmin(e) {
      e.preventDefault();
      const txt = (adminMessageInput.value || '').trim();
      if (!txt || !adminActiveThreadId) return;
      try {
        const res = await fetch(API_BASE + '/messages_send.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread_id: adminActiveThreadId, sender_type: 'admin', body: txt })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao enviar.');
        adminMessageInput.value = '';
        await abrirConversaAdmin(adminActiveThreadId);
      } catch (e) {
        alert(e.message || 'Erro ao enviar mensagem.');
      }
    }

    function formatDate(value) {
      if (!value || !/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
      const [y, m, d] = value.split('-');
      return `${d}/${m}/${y}`;
    }

    function formatTime(value) {
      if (!value) return value;
      return value.toString().slice(0, 5);
    }

    function somenteDigitos(value) {
      return (value || '').toString().replace(/\D/g, '');
    }

    function maskCPF(value) {
      const digits = somenteDigitos(value).slice(0, 11);
      if (!digits) return '';
      let masked = digits;
      if (digits.length > 3) masked = `${digits.slice(0, 3)}.${digits.slice(3)}`;
      if (digits.length > 6) masked = `${masked.slice(0, 7)}.${masked.slice(7)}`;
      if (digits.length > 9) masked = `${masked.slice(0, 11)}-${masked.slice(11)}`;
      return masked;
    }

    function formatCPF(value) {
      const digits = somenteDigitos(value);
      if (digits.length !== 11) return value ? maskCPF(value) : '-';
      return `${digits.slice(0, 3)}.${digits.slice(3, 6)}.${digits.slice(6, 9)}-${digits.slice(9)}`;
    }

    function maskPhone(value) {
      const digits = somenteDigitos(value).slice(0, 11);
      if (!digits) return '';
      const ddd = digits.slice(0, 2);
      const corpo = digits.length > 10 ? digits.slice(2, 7) : digits.slice(2, 6);
      const sufixo = digits.length > 10 ? digits.slice(7) : digits.slice(6);
      return digits.length <= 2
        ? `(${digits}`
        : `(${ddd}) ${corpo}${sufixo ? '-' + sufixo : ''}`;
    }

    function formatPhone(value) {
      const digits = somenteDigitos(value);
      if (!digits) return '-';
      if (digits.length < 10) return maskPhone(value);
      const ddd = digits.slice(0, 2);
      if (digits.length === 10) {
        return `(${ddd}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
      }
      return `(${ddd}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
    }

    function aplicarMascarasPadrao(container) {
      if (!container) return;
      container.querySelectorAll('input[name*="cpf"]').forEach(input => {
        if (input.dataset.maskCpfAttached) return;
        const handler = () => {
          input.value = maskCPF(input.value);
        };
        handler();
        input.addEventListener('input', handler);
        input.dataset.maskCpfAttached = '1';
      });
      container.querySelectorAll('input[name*="phone"], input[name*="telefone"], input[name*="whatsapp"]').forEach(input => {
        if (input.dataset.maskPhoneAttached) return;
        const handler = () => {
          input.value = maskPhone(input.value);
        };
        handler();
        input.addEventListener('input', handler);
        input.dataset.maskPhoneAttached = '1';
      });
    }

    async function resetSenhaAnunciante(email) {
      if (!email) { alert('E-mail do anunciante não encontrado.'); return; }
      if (!confirm(`Gerar e enviar nova senha temporária para ${email}?`)) return;
      try {
        const res = await fetch(`${API_BASE}/advertiser_reset_password.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao resetar.');
        alert(json.message || 'Senha temporária enviada por e-mail.');
      } catch (e) { alert(e.message || 'Erro ao resetar senha.'); }
    }

    let clientesDetalhadosCache = null;

    async function obterClientesDetalhados() {
      if (clientesDetalhadosCache) return clientesDetalhadosCache;
      try {
        const res = await fetch(`${API_BASE}/apiget.php?table=clients`, { credentials: 'include' });
        const json = await res.json();
        clientesDetalhadosCache = json.success ? (json.data || []) : [];
      } catch (err) {
        console.error(err);
        clientesDetalhadosCache = [];
      }
      return clientesDetalhadosCache;
    }

    async function configurarVisitanteEmpresa(container) {
      const clientSelect = container.querySelector('select[name="client_id"]');
      const companySelect = container.querySelector('select[name="company_id"]');
      if (!clientSelect || !companySelect) return;
      companySelect.title = 'Empresa vinculada ao cliente selecionado (definição automática).';

      const clientes = await obterClientesDetalhados();

      const aplicar = () => {
        const selecionado = clientes.find(c => String(c.id) === clientSelect.value);
        if (selecionado && selecionado.company_id) {
          companySelect.value = selecionado.company_id;
          companySelect.disabled = true;
        } else {
          companySelect.value = '';
          companySelect.disabled = true;
        }
      };

      aplicar();
      clientSelect.addEventListener('change', aplicar);
    }

    function recordToSearchString(record) {
      if (!record || typeof record !== 'object') return String(record ?? '');
      return Object.values(record).map(v => {
        if (Array.isArray(v)) return v.join(' ');
        if (v && typeof v === 'object') return recordToSearchString(v);
        return v ?? '';
      }).join(' ');
    }

    function statusFormatter(value) {
      if (!value && value !== 0) return '-';
      return escapeHtml(statusLabels[value] || value);
    }

    function dateFormatter(value) {
      if (!value) return '-';
      return escapeHtml(formatDate(value));
    }

    function timeFormatter(value) {
      if (!value) return '-';
      return escapeHtml(formatTime(value));
    }

    function defaultFormatter(value, key) {
      if (value === null || value === undefined || value === '') return '-';
      if (Array.isArray(value)) return escapeHtml(value.join(', '));
      if (typeof value === 'object') return escapeHtml(recordToSearchString(value));
      if ((key === 'status' || key.endsWith('_status')) && statusLabels[value]) {
        return escapeHtml(statusLabels[value]);
      }
      if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value) && key.toLowerCase().includes('date')) {
        return escapeHtml(formatDate(value));
      }
      if (typeof value === 'string' && key.toLowerCase().includes('time')) {
        return escapeHtml(formatTime(value));
      }
      if (/cpf/i.test(key)) {
        return escapeHtml(formatCPF(value));
      }
      if (/(phone|telefone|whatsapp)/i.test(key)) {
        return escapeHtml(formatPhone(value));
      }
      if (key === 'facilitated_access') {
        return escapeHtml(Number(value) ? 'Sim' : 'Não');
      }
      return escapeHtml(value);
    }

    function friendlyLabel(key) {
      if (!key) return '';
      return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function dateTimeFormatter(value) {
      if (!value) return '';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return escapeHtml(String(value));
      return d.toLocaleString('pt-BR');
    }

    const sectionConfigs = {
      companies: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'razao_social', label: 'Razão Social' },
          { key: 'nome_fantasia', label: 'Nome Fantasia' },
          { key: 'cnpj', label: 'CNPJ' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      clients: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Nome' },
          { key: 'email', label: 'E-mail' },
          { key: 'cpf', label: 'CPF' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      advertisers: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'display_name', label: 'Nome Público' },
          { key: 'owner_type', label: 'Tipo' },
          { key: 'owner_id', label: 'Dono (ID)' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      rooms: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Sala' },
          { key: 'location', label: 'Localização' },
          { key: 'responsavel_nome', label: 'Responsável' },
          { key: 'capacity', label: 'Capacidade' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      reservations: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'room_name', label: 'Sala' },
          { key: 'client_name', label: 'Cliente' },
          { key: 'date', label: 'Data', formatter: dateFormatter },
          { key: 'time_start', label: 'Hora Início', formatter: timeFormatter },
          { key: 'time_end', label: 'Hora Fim', formatter: timeFormatter },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      visitors: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Visitante' },
          { key: 'client_name', label: 'Cliente' },
          { key: 'company_name', label: 'Empresa' },
          { key: 'cpf', label: 'CPF' },
          { key: 'phone', label: 'Telefone' },
          { key: 'whatsapp', label: 'WhatsApp' },
          { key: 'email', label: 'E-mail' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      amenities: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Comodidade' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      campaigns: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Campanha' },
          { key: 'type', label: 'Tipo' },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      vouchers: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'code', label: 'Código' },
          { key: 'type', label: 'Tipo' },
          { key: 'value', label: 'Valor' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'used_count', label: 'Usos' },
          { key: 'starts_at', label: 'Início', formatter: dateFormatter },
          { key: 'ends_at', label: 'Fim', formatter: dateFormatter }
        ]
      },
      workshops: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'advertiser_id', label: 'Anunciante (ID)' },
          { key: 'room_id', label: 'Sala (ID)' },
          { key: 'date', label: 'Data inicial', formatter: dateFormatter },
          { key: 'end_date', label: 'Data final', formatter: dateFormatter },
          { key: 'status', label: 'Status', formatter: statusFormatter }
        ]
      },
      workshop_participants: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'name', label: 'Nome' },
          { key: 'email', label: 'E-mail' },
          { key: 'cpf', label: 'CPF' },
          { key: 'phone', label: 'Telefone' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'created_at', label: 'Criado em', formatter: dateFormatter }
        ]
      },
      workshop_enrollments: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'workshop_id', label: 'Workshop (ID)' },
          { key: 'participant_id', label: 'Participante (ID)' },
          { key: 'payment_status', label: 'Pagamento', formatter: statusFormatter },
          { key: 'checkin_status', label: 'Check-in', formatter: statusFormatter },
          { key: 'public_code', label: 'Código público' },
          { key: 'created_at', label: 'Criado em', formatter: dateFormatter }
        ]
      },
      posts: {
        columns: [
          { key: 'id', label: 'ID' },
          { key: 'title', label: 'Título' },
          { key: 'category', label: 'Categoria' },
          { key: 'status', label: 'Status', formatter: statusFormatter },
          { key: 'published_at', label: 'Publicado em', formatter: dateTimeFormatter }
        ]
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
      const loginDiv = document.getElementById('login');
      const appDiv = document.getElementById('app');
      const errorDiv = document.getElementById('loginError');

      const savedUser = localStorage.getItem('zeefeRememberUser');
      if (savedUser) {
        form.username.value = savedUser;
        form.remember.checked = true;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorDiv.style.display = 'none';
        const username = form.username.value.trim();
        const password = form.password.value.trim();
        if (!username || !password) {
          errorDiv.textContent = 'Preencha usuário e senha.';
          errorDiv.style.display = 'block';
          return;
        }
        if (form.remember.checked) localStorage.setItem('zeefeRememberUser', username);
        else localStorage.removeItem('zeefeRememberUser');
        try {
          const res = await fetch(`${API_BASE}/apilogin.php`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username, password })
          });
          const data = await res.json();
          if (data.success) {
            loginDiv.style.display = 'none';
            appDiv.style.display = 'flex';
            loadSection('companies');
          } else {
            errorDiv.textContent = data.error || 'Usuário ou senha inválidos.';
            errorDiv.style.display = 'block';
          }
        } catch (err) {
          console.error(err);
          errorDiv.textContent = 'Erro ao conectar ao servidor.';
          errorDiv.style.display = 'block';
        }
      });
    });

    document.querySelectorAll('#menu li').forEach(li => {
      li.addEventListener('click', () => {
        document.querySelectorAll('#menu li').forEach(x => x.classList.remove('active'));
        li.classList.add('active');
        sec = li.dataset.section;
        document.getElementById('content-title').textContent = li.textContent;
        if (sec === 'messages') {
          abrirAdminMessages();
        } else {
          loadSection(sec);
        }
      });
    });

    document.getElementById('logoutBtn').onclick = () => location.reload();

    if (adminMessagesForm) {
      adminMessagesForm.addEventListener('submit', enviarMensagemAdmin);
    }

    async function loadSection(section) {
      sec = section;
      if (section === 'rooms') cachedRooms = null;
      if (section === 'clients') {
        cachedClients = null;
        clientesDetalhadosCache = null;
      }
      filtro = '';
      fecharReservasModal();
      const body = document.getElementById('content-body');
      body.innerHTML = '<div class="box-message">Carregando...</div>';

      let url = `${API_BASE}/apiget.php?table=${section}`;
      if (section === 'reservations') {
        const params = new URLSearchParams();
        if (reservationFilters.room_id) params.set('room_id', reservationFilters.room_id);
        if (reservationFilters.client_id) params.set('client_id', reservationFilters.client_id);
        if (reservationFilters.date_range) params.set('date_range', reservationFilters.date_range);
        if (reservationFilters.date_range === 'custom') {
          if (reservationFilters.date_from) params.set('date_from', reservationFilters.date_from);
          if (reservationFilters.date_to) params.set('date_to', reservationFilters.date_to);
        }
        if (params.toString()) url += `&${params.toString()}`;
      }

      try {
        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        if (!data.success) {
          body.innerHTML = `<div class="box-message">Erro: ${escapeHtml(data.error || 'Falha ao carregar os dados.')}</div>`;
          dadosJSON = [];
        } else {
          dadosJSON = data.data || [];
          renderTable();
        }
      } catch (err) {
        console.error(err);
        body.innerHTML = `<div class="box-message">Erro ao carregar ${escapeHtml(section)}.</div>`;
        dadosJSON = [];
      }

      await renderFilters(section);
    }

    function buscar(valor) {
      filtro = (valor || '').toLowerCase();
      renderTable();
    }

    function renderTable() {
      let linhas = Array.isArray(dadosJSON) ? [...dadosJSON] : [];
      if (filtro) {
        linhas = linhas.filter(reg => recordToSearchString(reg).toLowerCase().includes(filtro));
      }
      if (sec === 'vouchers' && voucherFilters.status) {
        const st = voucherFilters.status.toLowerCase();
        linhas = linhas.filter(v => {
          const vs = String(v.status || '').toLowerCase();
          if (st === 'expirado') return isVoucherExpirado(v);
          return vs === st;
        });
      }
      const body = document.getElementById('content-body');
      if (!linhas.length) {
        body.innerHTML = '<div class="box-message">Nenhum registro encontrado</div>';
        return;
      }

      const config = sectionConfigs[sec] || {};
      const columns = config.columns || Object.keys(linhas[0]).map(key => ({ key, label: friendlyLabel(key) }));

      let resumo = '';
      if (sec === 'vouchers') {
        const tot = linhas.length;
        const ativos = linhas.filter(v => !isVoucherExpirado(v) && String(v.status||'').toLowerCase()==='ativo').length;
        const inativos = linhas.filter(v => String(v.status||'').toLowerCase()==='inativo').length;
        const expirados = linhas.filter(v => isVoucherExpirado(v)).length;
        const usos = linhas.reduce((acc,v)=> acc + (Number(v.used_count)||0), 0);
        resumo = `<div class=\"box-message\" style=\"text-align:left\"><strong>Resumo:</strong> Total: ${tot} · Ativos: ${ativos} · Inativos: ${inativos} · Expirados: ${expirados} · Usos acumulados: ${usos}</div>`;
      }

      let html = resumo + '<div class="table-container"><table><thead><tr>';
      columns.forEach(col => { html += `<th>${escapeHtml(col.label)}</th>`; });
      html += '<th>Ações</th></tr></thead><tbody>';

      linhas.forEach(row => {
        const rowId = Number(row.id) || 0;
        html += '<tr>';
        columns.forEach(col => {
          const raw = row[col.key];
          const formatted = typeof col.formatter === 'function'
            ? col.formatter(raw, row)
            : defaultFormatter(raw, col.key, row);
          html += `<td>${formatted}</td>`;
        });

        const actionButtons = [];
        if (sec === 'rooms') {
          actionButtons.push(`<button class="btn-ghost" onclick="abrirChamadaReservas(${rowId})">Reservas</button>`);
          actionButtons.push(`<button class="btn-ghost" onclick="abrirAnuncianteSala(${rowId})">Anunciante</button>`);
        }
        if (sec === 'companies') {
          const nomeEmpresa = escapeHtml(row.nome_fantasia || row.razao_social || `Empresa #${rowId}`).replace(/'/g, "\\'");
          actionButtons.push(`<button class="btn-ghost" onclick="listarClientesEmpresa(${rowId}, '${nomeEmpresa}')">Clientes</button>`);
        }
        actionButtons.push(`<button class="btn" onclick="abrirModalEdit(${rowId})">Editar</button>`);
        actionButtons.push(`<button class="btn" onclick="abrirModalExcluir(${rowId})">Excluir</button>`);

        let extraControls = '';
        if (sec === 'reservations') {
          const inline = [];
          const rowRoomId = row.room_id || row.roomId || row.room || null;
          const roomArg = rowRoomId ? rowRoomId : 'null';
          if (row.status === 'pendente') {
            inline.push(`<button class="btn-micro confirm" onclick="alterarStatusReserva(${rowId}, 'confirm', ${roomArg})">Confirmar</button>`);
            inline.push(`<button class="btn-micro deny" onclick="alterarStatusReserva(${rowId}, 'deny', ${roomArg})">Negar</button>`);
          } else if (row.status === 'confirmada') {
            inline.push(`<button class="btn-micro cancel" onclick="alterarStatusReserva(${rowId}, 'cancel', ${roomArg})">Cancelar</button>`);
          }
          if (inline.length) {
            extraControls = `<div class="reservation-inline">${inline.join(' ')}</div>`;
          }
        }

        html += `<td class="actions">${actionButtons.join(' ')}${extraControls}</td></tr>`;
      });

      html += '</tbody></table></div>';
      body.innerHTML = html;
    }

    function isVoucherExpirado(v) {
      const end = v.ends_at || v.valid_to || v.valid_until || v.expires_at;
      if (!end) return false;
      const d = new Date(end);
      if (isNaN(d.getTime())) return false;
      const today = new Date();
      return d < today;
    }

    function exportarCSV() {
      const rows = Array.isArray(dadosJSON) ? [...dadosJSON] : [];
      if (!rows.length) { alert('Nada para exportar'); return; }
      const colsDef = sectionConfigs[sec]?.columns;
      const cols = colsDef ? colsDef.map(c=>c.key) : Object.keys(rows[0]);
      const esc = s => '"' + String(s==null?'':s).replace(/"/g,'""') + '"';
      const header = cols.join(',');
      const lines = rows.map(r => cols.map(k => esc(r[k])).join(','));
      const csv = [header].concat(lines).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${sec}.csv`; a.click(); URL.revokeObjectURL(url);
    }

    // ===== Modal Anunciante (vínculo de sala) =====
    let advertiserSalaRoomId = null;
    let advertisersCache = null;
    async function abrirAnuncianteSala(roomId){
      advertiserSalaRoomId = roomId;
      const body = document.getElementById('advertiserModalBody');
      const msg = document.getElementById('advertiserModalMsg');
      msg.style.display='none'; msg.textContent='';
      const sala = (dadosJSON || []).find(r => String(r.id) === String(roomId));
      body.innerHTML = '<div class="box-message">Carregando…</div>';
      try {
        if (!advertisersCache) {
          const r = await fetch(`${API_BASE}/apiget.php?table=advertisers`, { credentials:'include' });
          const j = await r.json();
          advertisersCache = j.success ? (j.data || []) : [];
        }
        const options = advertisersCache.map(a => `<option value="${a.id}">${escapeHtml(a.display_name || ('Anunciante #'+a.id))} (ID ${a.id})</option>`).join('');
        const current = sala?.advertiser_id || '';
        body.innerHTML = `
          <div class="form-group" style="grid-column: span 2">
            <label>Sala</label>
            <input class="input-readonly" value="${escapeHtml(sala?.name || ('Sala #'+roomId))}" readonly />
          </div>
          <div class="form-group" style="grid-column: span 2">
            <label>Anunciante</label>
            <select id="advertiserSelect"><option value="">— Selecionar —</option>${options}</select>
          </div>`;
        const sel = document.getElementById('advertiserSelect'); if (current) sel.value = String(current);
        document.getElementById('advertiserModal').classList.add('show');
      } catch (e) {
        body.innerHTML = '<div class="box-message">Falha ao carregar anunciantes.</div>';
      }
    }
    function fecharAdvertiserModal(){ document.getElementById('advertiserModal').classList.remove('show'); advertiserSalaRoomId = null; }
    async function salvarAdvertiserSala(){
      const msg = document.getElementById('advertiserModalMsg'); msg.style.display='none'; msg.textContent='';
      const sel = document.getElementById('advertiserSelect'); const advId = sel ? Number(sel.value)||null : null;
      if (!advertiserSalaRoomId) return;
      try {
        // apiupdate.php espera o id dentro de data
        const payload = { table: 'rooms', data: { id: advertiserSalaRoomId, advertiser_id: advId } };
        const res = await fetch(`${API_BASE}/apiupdate.php`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json(); if (!json.success) throw new Error(json.error||'Falha ao salvar.');
        msg.textContent = 'Vínculo salvo com sucesso.'; msg.style.display='block';
        await loadSection('rooms'); fecharAdvertiserModal();
      } catch (err) {
        msg.textContent = err.message || 'Erro ao salvar.'; msg.style.display='block';
      }
    }

    async function renderFilters(section) {
      const container = document.getElementById('search-filters');
      if (section === 'reservations') {
        await renderReservationFilters(container);
        return;
      }
      if (section === 'vouchers') {
        container.innerHTML = `
          <input type="text" id="inputBusca" placeholder="Buscar código..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
          <select id="voucherStatusSel" onchange="(function(s){ voucherFilters.status=s.value; renderTable(); })(this)">
            <option value="">Todos</option>
            <option value="ativo">Ativo</option>
            <option value="inativo">Inativo</option>
            <option value="expirado">Expirado</option>
          </select>
          <button class="btn" onclick="abrirModalNovo()">+ Novo</button>
          <button class="btn-secondary" onclick="exportarCSV()">Exportar CSV</button>`;
      } else {
        container.innerHTML =
          `<input type="text" id="inputBusca" placeholder="Buscar..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
           <button class="btn" onclick="abrirModalNovo()">+ Novo</button>`;
      }
    }

    async function renderReservationFilters(container) {
      await ensureReservationOptions();
      const roomOptions = (cachedRooms || []).map(room => {
        const id = Number(room.id) || 0;
        const selected = reservationFilters.room_id == id ? ' selected' : '';
        const label = escapeHtml(room.name || `Sala #${id}`);
        return `<option value="${id}"${selected}>${label}</option>`;
      }).join('');
      const clientOptions = (cachedClients || []).map(client => {
        const id = Number(client.id) || 0;
        const selected = reservationFilters.client_id == id ? ' selected' : '';
        const label = escapeHtml(client.name || `Cliente #${id}`);
        return `<option value="${id}"${selected}>${label}</option>`;
      }).join('');

      const dateRange = reservationFilters.date_range || '';
      const customVisible = dateRange === 'custom' ? '' : 'display:none';

      container.innerHTML = `
        <input type="text" id="inputBusca" placeholder="Buscar..." value="${escapeHtml(filtro)}" oninput="buscar(this.value)">
        <select onchange="atualizarFiltroReserva('room_id', this.value)">
          <option value="">Todas as salas</option>
          ${roomOptions}
        </select>
        <select onchange="atualizarFiltroReserva('client_id', this.value)">
          <option value="">Todos os clientes</option>
          ${clientOptions}
        </select>
        <select onchange="atualizarFiltroReserva('date_range', this.value)">
          <option value="">Período</option>
          <option value="past_30"${dateRange === 'past_30' ? ' selected' : ''}>Últimos 30 dias</option>
          <option value="past_60"${dateRange === 'past_60' ? ' selected' : ''}>Últimos 60 dias</option>
          <option value="past_90"${dateRange === 'past_90' ? ' selected' : ''}>Últimos 90 dias</option>
          <option value="future"${dateRange === 'future' ? ' selected' : ''}>Futuro</option>
          <option value="custom"${dateRange === 'custom' ? ' selected' : ''}>Entre datas</option>
        </select>
        <span id="filtrosCustom" style="${customVisible}">
          <input type="date" value="${reservationFilters.date_from || ''}" onchange="atualizarFiltroReservaData('date_from', this.value)">
          <input type="date" value="${reservationFilters.date_to || ''}" onchange="atualizarFiltroReservaData('date_to', this.value)">
          <button class="btn" type="button" onclick="aplicarFiltroPersonalizado()">Aplicar</button>
        </span>
        <button class="btn" onclick="abrirModalNovo()">+ Nova</button>
      `;
    }

    async function ensureReservationOptions() {
      if (!cachedRooms) {
        try {
          const res = await fetch(`${API_BASE}/apiget.php?table=rooms`, { credentials: 'include' });
          const data = await res.json();
          cachedRooms = data.success ? data.data || [] : [];
        } catch (err) {
          console.error(err);
          cachedRooms = [];
        }
      }
      if (!cachedClients) {
        try {
          const res = await fetch(`${API_BASE}/apiget.php?table=clients`, { credentials: 'include' });
          const data = await res.json();
          cachedClients = data.success ? data.data || [] : [];
        } catch (err) {
          console.error(err);
          cachedClients = [];
        }
      }
    }

    function atualizarFiltroReserva(campo, valor) {
      reservationFilters[campo] = valor;
      if (campo === 'date_range') {
        if (valor !== 'custom') {
          reservationFilters.date_from = '';
          reservationFilters.date_to = '';
          loadSection('reservations');
        } else {
          renderFilters('reservations');
        }
        return;
      }
      loadSection('reservations');
    }

    function atualizarFiltroReservaData(campo, valor) {
      reservationFilters[campo] = valor;
    }

    function aplicarFiltroPersonalizado() {
      loadSection('reservations');
    }

    function abrirModalNovo() {
      itemEdit = null;
      gerarCampos({});
      document.getElementById('modalTitle').textContent = `Nova ${modalEntities[sec] || 'Entrada'}`;
      document.getElementById('modal').classList.add('show');
      if (resetSenhaBtn) {
        resetSenhaBtn.style.display = 'none';
        resetSenhaBtn.onclick = null;
      }
    }

    function abrirModalEdit(id) {
      itemEdit = dadosJSON.find(r => r.id == id);
      if (!itemEdit) return;
      gerarCampos(itemEdit);
      document.getElementById('modalTitle').textContent = `Editar ${modalEntities[sec] || 'Registro'}`;
      document.getElementById('modal').classList.add('show');
      if (resetSenhaBtn) {
        if (sec === 'clients' && itemEdit && itemEdit.id) {
          resetSenhaBtn.style.display = 'inline-block';
          resetSenhaBtn.onclick = () => resetSenhaCliente(itemEdit.id);
        } else if (sec === 'advertisers' && itemEdit && itemEdit.login_email) {
          resetSenhaBtn.style.display = 'inline-block';
          resetSenhaBtn.onclick = () => resetSenhaAnunciante(itemEdit.login_email);
        } else {
          resetSenhaBtn.style.display = 'none';
          resetSenhaBtn.onclick = null;
        }
      }
      const geocodeBtn = document.getElementById('geocodeBtn');
      if (geocodeBtn) {
        if (sec === 'rooms' && itemEdit && itemEdit.id) {
          geocodeBtn.style.display = 'inline-block';
          geocodeBtn.onclick = () => geocodificarSalaAtual(itemEdit.id);
        } else {
          geocodeBtn.style.display = 'none';
          geocodeBtn.onclick = null;
        }
      }
    }

    function abrirModalExcluir(id) {
      if (!confirm('Deseja realmente excluir este registro?')) return;
      excluirItem(id);
    }

    function fecharModal() {
      document.getElementById('modal').classList.remove('show');
      if (resetSenhaBtn) {
        resetSenhaBtn.style.display = 'none';
        resetSenhaBtn.onclick = null;
      }
      const geocodeBtn = document.getElementById('geocodeBtn');
      if (geocodeBtn) { geocodeBtn.style.display = 'none'; geocodeBtn.onclick = null; }
    }

    const UF = ['AC','AL','AM','AP','BA','CE','DF','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO'];

    const schemas = {
      companies: [
        { name: 'razao_social', label: 'Razão Social', span: 4 },
        { type: 'break' },
        { name: 'nome_fantasia', label: 'Nome Fantasia', span: 4 },
        { type: 'break' },
        { name: 'cnpj', label: 'CNPJ', span: 2 },
        { name: 'inscricao_estadual', label: 'Inscrição Estadual', span: 2 },
        { type: 'break' },
        { name: 'street', label: 'Rua', span: 2 },
        { name: 'number', label: 'Número', span: 1, cls: 'sm' },
        { name: 'complement', label: 'Complemento', span: 1 },
        { type: 'break' },
        { name: 'zip_code', label: 'CEP', span: 1, cls: 'sm' },
        { name: 'state', label: 'Estado', span: 1, type: 'select', options: UF, cls: 'sm' },
        { name: 'city', label: 'Cidade', span: 2 },
        { type: 'break' },
        { name: 'email', label: 'E-mail', span: 2 },
        { name: 'phone', label: 'Telefone', span: 1, cls: 'sm' },
        { name: 'whatsapp', label: 'WhatsApp', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativa' },
          { value: 'inativo', label: 'Inativa' }
        ], cls: 'sm', includeEmpty: false }
      ],
      clients: [
        { name: 'name', label: 'Nome Completo', span: 3 },
        { name: 'email', label: 'E-mail', span: 2 },
        { name: 'login', label: 'Login', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'cpf', label: 'CPF', span: 1, cls: 'sm' },
        { name: 'rg', label: 'RG', span: 1, cls: 'sm' },
        { name: 'phone', label: 'Telefone', span: 1, cls: 'sm' },
        { name: 'whatsapp', label: 'WhatsApp', span: 1, cls: 'sm' },
        { name: 'type', label: 'Tipo', span: 1, type: 'select', options: ['PF', 'PJ'], cls: 'sm', includeEmpty: false },
        { type: 'break' },
        { name: 'company_id', label: 'Empresa', span: 2, type: 'select', source: 'companies' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' },
          { value: 'bloqueado', label: 'Bloqueado' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'password_hash', label: 'Senha (hash)', span: 2, readonly: true },
        { name: 'created_at', label: 'Criado em', span: 1, type: 'date', readonly: true, cls: 'sm' },
        { name: 'updated_at', label: 'Atualizado em', span: 1, type: 'date', readonly: true, cls: 'sm' }
      ],
      advertisers: [
        { name: 'full_name', label: 'Nome completo', span: 2 },
        { name: 'display_name', label: 'Nome público (anúncio)', span: 2 },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [ {value:'ativo',label:'Ativo'}, {value:'inativo',label:'Inativo'}, {value:'suspenso',label:'Suspenso'} ], cls:'sm', includeEmpty:false },
        { type: 'break' },
        { name: 'fee_pct', label: 'Fee (%)', span: 1, cls:'sm' },
        { name: 'contact_phone', label: 'Telefone', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'owner_type', label: 'Tipo de dono', span: 1, type: 'select', options: [ {value:'client',label:'Cliente'}, {value:'company',label:'Empresa'} ], cls:'sm', includeEmpty:false },
        { name: 'owner_id', label: 'ID do dono', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'bank_code', label: 'Banco (cód.)', span: 1, cls:'sm' },
        { name: 'bank_name', label: 'Banco (nome)', span: 1 },
        { name: 'account_type', label: 'Tipo de Conta', span: 1, type: 'select', options: [ {value:'corrente',label:'Corrente'}, {value:'poupanca',label:'Poupança'}, {value:'pix',label:'PIX'} ], cls:'sm', includeEmpty:true },
        { name: 'agency_number', label: 'Agência', span: 1, cls:'sm' },
        { name: 'account_number', label: 'Conta', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'pix_key', label: 'Chave PIX', span: 2 },
        { name: 'created_at', label: 'Criado em', span: 1, type: 'date', readonly: true, cls:'sm' },
        { name: 'updated_at', label: 'Atualizado em', span: 1, type: 'date', readonly: true, cls:'sm' }
      ],
      rooms: [
        { name: 'name', label: 'Nome da Sala', span: 4 },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { type: 'break' },
        { name: 'capacity', label: 'Capacidade', span: 1, cls: 'sm' },
        { name: 'daily_rate', label: 'Valor Diário (R$)', span: 1, cls: 'sm' },
        { name: 'facilitated_access', label: 'Acesso Facilitado', span: 1, type: 'select', options: [
          { value: 1, label: 'Sim' },
          { value: 0, label: 'Não' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'portaria_inteligente', label: 'Portaria Inteligente', span: 1, type: 'select', options: [
          { value: 'Sim', label: 'Sim' },
          { value: 'Não', label: 'Não' }
        ], cls: 'sm', includeEmpty: false },
        { type: 'break' },
        { name: 'street', label: 'Rua', span: 3 },
        { name: 'complement', label: 'Complemento', span: 1 },
        { type: 'break' },
        { name: 'cep', label: 'CEP', span: 1, cls: 'sm' },
        { name: 'state', label: 'Estado', span: 1, type: 'select', options: UF, cls: 'sm' },
        { name: 'city', label: 'Cidade', span: 2 },
        { type: 'break' },
        { name: 'responsavel_nome', label: 'Nome do Responsável', span: 2 },
        { name: 'responsavel_telefone', label: 'Telefone do Responsável', span: 1, cls: 'sm' },
        { name: 'responsavel_email', label: 'E-mail do Responsável', span: 1 },
        { type: 'break' },
        { name: 'portaria_telefone', label: 'Telefone Portaria', span: 1, cls: 'sm' },
        { name: 'portaria_email', label: 'E-mail Portaria', span: 1 },
        { type: 'break' },
        { name: 'location', label: 'Localização Interna (andar, bloco, mapa)', span: 4 },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 2, type: 'select', options: [
          { value: 'ativo', label: 'Ativa' },
          { value: 'inativo', label: 'Inativa' },
          { value: 'manutencao', label: 'Em Manutenção' },
          { value: 'desativada', label: 'Desativada' }
        ], cls: 'sm', placeholder: 'Selecione o status', required: true },
        { type: 'break' },
        { name: 'maintenance_start', label: 'Manutenção - De', span: 1, cls: 'sm', type: 'date', showIfStatus: ['manutencao'] },
        { name: 'maintenance_end', label: 'Manutenção - Até', span: 1, cls: 'sm', type: 'date', showIfStatus: ['manutencao'] },
        { name: 'deactivated_from', label: 'Desativada a partir de', span: 1, cls: 'sm', type: 'date', showIfStatus: ['desativada'] },
        { type: 'break' },
        { name: 'photo_path', label: 'Fotos da Sala', span: 4, type: 'file-multiple' },
        { name: 'amenities', label: 'Comodidades Disponíveis', span: 4, type: 'checkbox-grid', optionsSource: 'amenities' }
      ],
      reservations: [
        { name: 'title', label: 'Título', span: 3 },
        { name: 'room_id', label: 'Sala', span: 2, type: 'select', source: 'rooms', includeEmpty: false },
        { name: 'client_id', label: 'Cliente', span: 2, type: 'select', source: 'clients', includeEmpty: false },
        { type: 'break' },
        { name: 'date', label: 'Data', span: 2, type: 'date' },
        { name: 'time_start', label: 'Hora de Início', span: 1, cls: 'sm' },
        { name: 'time_end', label: 'Hora de Término', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'pendente', label: 'Pendente' },
          { value: 'confirmada', label: 'Confirmada' },
          { value: 'cancelada', label: 'Cancelada' },
          { value: 'concluida', label: 'Concluída' }
        ], cls: 'sm', includeEmpty: false }
      ],
      visitors: [
        { name: 'name', label: 'Nome do Visitante', span: 3 },
        { name: 'client_id', label: 'Cliente', span: 2, type: 'select', source: 'clients', includeEmpty: false, required: true },
        { type: 'break' },
        { name: 'company_id', label: 'Empresa', span: 2, type: 'select', source: 'companies' },
        { name: 'rg', label: 'RG', span: 1, cls: 'sm' },
        { name: 'cpf', label: 'CPF', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'email', label: 'E-mail', span: 2 },
        { name: 'phone', label: 'Telefone', span: 1, cls: 'sm' },
        { name: 'whatsapp', label: 'WhatsApp', span: 1, cls: 'sm' },
        { type: 'break' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false },
        { name: 'observations', label: 'Observações', span: 4, type: 'textarea' }
      ],
      amenities: [
        { name: 'name', label: 'Comodidade', span: 3 },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false }
      ],
      campaigns: [
        { name: 'name', label: 'Campanha', span: 3 },
        { name: 'type', label: 'Tipo', span: 2 },
        { name: 'start_date', label: 'Início', span: 1, cls: 'sm', type: 'date' },
        { name: 'end_date', label: 'Término', span: 1, cls: 'sm', type: 'date' },
        { type: 'break' },
        { name: 'description', label: 'Descrição', span: 4, type: 'textarea' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [
          { value: 'ativo', label: 'Ativo' },
          { value: 'inativo', label: 'Inativo' }
        ], cls: 'sm', includeEmpty: false }
      ],
      vouchers: [
        { name: 'code', label: 'Código', span: 1, cls:'sm' },
        { name: 'type', label: 'Tipo', span: 1, type: 'select', options: [ {value:'percent',label:'% Desconto'}, {value:'fixed',label:'Valor Fixo'} ], cls:'sm', includeEmpty:false },
        { name: 'value', label: 'Valor', span: 1, cls:'sm' },
        { name: 'max_discount', label: 'Teto máx. (opcional)', span: 1, cls:'sm' },
        { type: 'break' },
        { name: 'discount_owner', label: 'Quem assume o desconto?', span: 2, type: 'select', cls:'sm', includeEmpty:false, options: [
          { value: 'platform_only',   label: 'Somente plataforma' },
          { value: 'advertiser_only', label: 'Somente anunciante' },
          { value: 'split_equal',     label: 'Plataforma e anunciante (50/50)' },
          { value: 'platform_first',  label: 'Consome primeiro da plataforma, depois anunciante' },
          { value: 'advertiser_first',label: 'Consome primeiro do anunciante, depois plataforma' }
        ] },
        { type: 'break' },
        { name: 'advertiser_id', label: 'Anunciante (opcional)', span: 2, type: 'select', source: 'advertisers', includeEmpty: true },
        { name: 'room_id', label: 'Sala (opcional)', span: 2, type: 'select', source: 'rooms', includeEmpty: true },
        { type: 'break' },
        { name: 'client_id', label: 'Cliente (opcional)', span: 2, type: 'select', source: 'clients', includeEmpty: true },
        { name: 'max_uses', label: 'Qtd. máxima de usos', span: 1, cls:'sm' },
        { name: 'used_count', label: 'Usos realizados', span: 1, cls:'sm', readonly: true },
        { type: 'break' },
        { name: 'starts_at', label: 'Válido a partir de', span: 1, cls:'sm', type: 'date' },
        { name: 'ends_at', label: 'Válido até', span: 1, cls:'sm', type: 'date' },
        { name: 'status', label: 'Status', span: 1, type: 'select', options: [ {value:'ativo',label:'Ativo'}, {value:'inativo',label:'Inativo'} ], cls:'sm', includeEmpty:false },
        { name: 'notes', label: 'Observações', span: 4, type: 'textarea' }
      ]
    };

    async function gerarCampos(obj) {
      const container = document.getElementById('modalBody');
      container.innerHTML = '';

      let schema = schemas[sec];
      if (!schema) {
        try {
          const res = await fetch(`${API_BASE}/apidescribe.php?table=${sec}`, { credentials: 'include' });
          const j = await res.json();
          if (j.success) {
            schema = j.columns
              .filter(c => !['id', 'created_at', 'updated_at'].includes(c.Field))
              .map(c => ({ name: c.Field, label: friendlyLabel(c.Field), span: 2 }));
          } else {
            container.innerHTML = '<div class="box-message">Erro ao descrever a tabela.</div>';
            return;
          }
        } catch (err) {
          console.error(err);
          container.innerHTML = '<div class="box-message">Erro ao gerar formulário.</div>';
          return;
        }
      }

      const fragment = document.createDocumentFragment();

      for (const field of schema) {
        if (field.type === 'break') {
          const div = document.createElement('div');
          div.className = 'form-break';
          div.style.gridColumn = '1 / -1';
          if (field.label) {
            div.innerHTML = `<h4 style="margin:10px 0 4px 0;color:#1D413A;font-size:15px">${escapeHtml(field.label)}</h4>`;
          } else {
            div.innerHTML = '&nbsp;';
          }
          fragment.appendChild(div);
          continue;
        }

        const wrap = document.createElement('div');
        wrap.className = `form-group col-${field.span || 1} ${field.cls || ''}`;

        const labelEl = document.createElement('label');
        labelEl.textContent = field.label || friendlyLabel(field.name);
        wrap.appendChild(labelEl);

       if (field.showIfStatus && field.showIfStatus.length > 0) {
         wrap.dataset.showIfStatus = field.showIfStatus.join(',');
          wrap.style.display = 'none';
        }

        const currentValue = (obj || {})[field.name];

        if (field.type === 'select' && field.source) {
          const sel = document.createElement('select');
          sel.name = field.name;
          if (field.includeEmpty !== false) {
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = field.placeholder || '-- Selecione --';
            sel.appendChild(emptyOpt);
          }

          try {
            const res = await fetch(`${API_BASE}/apiget.php?table=${field.source}`, { credentials: 'include' });
            const data = await res.json();
            (data.data || []).forEach(item => {
              const option = document.createElement('option');
              option.value = item.id;
              option.textContent = item.nome_fantasia || item.razao_social || item.name || `#${item.id}`;
              if (currentValue && String(currentValue) == String(item.id)) option.selected = true;
              sel.appendChild(option);
            });
          } catch (err) {
            console.error(err);
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = 'Erro ao carregar lista';
            sel.appendChild(errorOption);
          }

          if (field.required) sel.required = true;
          wrap.appendChild(sel);
        } else if (field.type === 'select') {
          const sel = document.createElement('select');
          sel.name = field.name;
          if (field.includeEmpty !== false) {
            const emptyOpt = document.createElement('option');
            emptyOpt.value = '';
            emptyOpt.textContent = field.placeholder || '-- Selecione --';
            sel.appendChild(emptyOpt);
          }
          (field.options || []).forEach(opt => {
            const value = typeof opt === 'object' ? opt.value : opt;
            const text = typeof opt === 'object' ? opt.label : opt;
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            if (currentValue !== undefined && String(currentValue) === String(value)) option.selected = true;
            sel.appendChild(option);
          });
          if (field.required) sel.required = true;
          wrap.appendChild(sel);
        } else if (field.type === 'textarea') {
          const ta = document.createElement('textarea');
          ta.name = field.name;
          ta.rows = field.rows || 3;
          ta.value = currentValue ?? '';
          if (field.required) ta.required = true;
          if (field.readonly) {
            ta.readOnly = true;
            ta.classList.add('input-readonly');
          }
          wrap.appendChild(ta);
        } else if (field.type === 'file-multiple') {
          const div = document.createElement('div');
          div.className = 'photo-grid';
          div.innerHTML = `
            <div class="photo-preview existing-photos"></div>
            <input type="file" id="uploadFotos" multiple accept="image/*" style="margin:6px 0;">
            <div class="photo-preview new-photos"></div>
          `;
          wrap.appendChild(div);

          const existingContainer = div.querySelector('.existing-photos');
          const newPreview = div.querySelector('.new-photos');
          const fileInput = div.querySelector('#uploadFotos');

          const fotosExistentes = (obj.photo_path || '')
            .split(',')
            .map(f => f.trim())
            .filter(Boolean);

          if (fotosExistentes.length) {
            existingContainer.innerHTML = '';
            fotosExistentes.forEach(src => {
              const thumb = document.createElement('div');
              thumb.className = 'photo-thumb';
              const img = document.createElement('img');
              img.src = src;
              thumb.appendChild(img);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.innerHTML = '&times;';
              btn.addEventListener('click', () => removerFotoSala(src, thumb, existingContainer));
              thumb.appendChild(btn);
              existingContainer.appendChild(thumb);
            });
          } else {
            existingContainer.innerHTML = '<div class="photo-empty">Nenhuma foto cadastrada.</div>';
          }

          fileInput.addEventListener('change', () => {
            newPreview.innerHTML = '';
            Array.from(fileInput.files).forEach(file => {
              const reader = new FileReader();
              reader.onload = e => {
                const thumb = document.createElement('div');
                thumb.className = 'photo-thumb';
                const img = document.createElement('img');
                img.src = e.target.result;
                thumb.appendChild(img);
                newPreview.appendChild(thumb);
              };
              reader.readAsDataURL(file);
            });
          });
        } else if (field.type === 'checkbox-grid' && field.optionsSource === 'amenities') {
          const grid = document.createElement('div');
          grid.className = 'amenities-grid';
          const selecionadas = Array.isArray(obj.amenities)
            ? obj.amenities.map(String)
            : (obj.amenities ? String(obj.amenities).split(',') : []).map(s => s.trim());

          try {
            const res = await fetch(`${API_BASE}/apiget.php?table=amenities`, { credentials: 'include' });
            const data = await res.json();
            (data.data || []).forEach(am => {
              const label = document.createElement('label');
              label.className = 'checkbox-item';
              const chk = document.createElement('input');
              chk.type = 'checkbox';
              chk.name = 'amenities[]';
              chk.value = am.id;
              if (selecionadas.includes(String(am.id))) chk.checked = true;
              label.appendChild(chk);
              label.append(` ${am.name}`);
              grid.appendChild(label);
            });
          } catch (err) {
            console.error(err);
            grid.innerHTML = '<div style="color:#B00">Erro ao carregar comodidades</div>';
          }

          wrap.appendChild(grid);
        } else {
          const input = document.createElement('input');
          input.type = field.type || 'text';
          input.name = field.name;
          if (currentValue !== undefined && currentValue !== null) {
            input.value = currentValue;
          } else {
            input.value = '';
          }
          if (field.required) input.required = true;
          if (field.readonly) {
            input.readOnly = true;
            input.classList.add('input-readonly');
          }
          wrap.appendChild(input);
        }

        fragment.appendChild(wrap);
      }

      container.appendChild(fragment);

      // Ajustes específicos por seção
      if (sec === 'vouchers') {
        const codeWrap = container.querySelector('input[name="code"]')?.parentElement;
        const codeInput = container.querySelector('input[name="code"]');
        if (codeWrap && codeInput) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-secondary btn-sm';
          btn.textContent = 'Gerar código';
          btn.style.marginTop = '6px';
          btn.addEventListener('click', () => {
            codeInput.value = gerarCodigoVoucher();
          });
          codeWrap.appendChild(btn);
          codeInput.placeholder = 'Ex.: ZE-' + gerarCodigoVoucher().slice(0,6);
        }
      } else if (sec === 'advertisers') {
        const feeInput = container.querySelector('input[name="fee_pct"]');
        if (feeInput && (!feeInput.value || feeInput.value === '0')) feeInput.value = '15.00';

        // Conectar seleção de bancos (CSV) aos campos bank_code/bank_name
        (async () => {
          const banks = await loadBanksCSV();
          const codeInput = container.querySelector('input[name="bank_code"]');
          const nameInput = container.querySelector('input[name="bank_name"]');
          if (!codeInput || !nameInput) return;

          const wrap = codeInput.parentElement;
          const label = wrap && wrap.querySelector('label');
          if (label) label.textContent = 'Banco';

          const sel = document.createElement('select');
          sel.className = 'form-select';
          sel.style.marginTop = '4px';
          const optEmpty = document.createElement('option');
          optEmpty.value = '';
          optEmpty.textContent = '-- Selecione --';
          sel.appendChild(optEmpty);
          banks.forEach(b => {
            const o = document.createElement('option');
            o.value = b.code;
            o.textContent = `${b.code} - ${b.name}`;
            sel.appendChild(o);
          });
          // Preselect
          const currentCode = (codeInput.value || '').trim();
          if (currentCode) sel.value = currentCode;
          // Keep inputs as real fields to save; make them readonly to avoid conflito
          codeInput.readOnly = true; nameInput.readOnly = true;

          sel.addEventListener('change', () => {
            const code = sel.value;
            const found = banks.find(b => b.code === code);
            codeInput.value = found ? found.code : '';
            nameInput.value = found ? found.name : '';
          });

          wrap.appendChild(sel);
        })();
      }

      aplicarMascarasPadrao(container);

      if (sec === 'visitors') {
        await configurarVisitanteEmpresa(container);
      }

      const statusField = container.querySelector('select[name="status"]');
      if (statusField) {
        const toggleConditional = () => {
          const val = statusField.value;
          container.querySelectorAll('[data-show-if-status]').forEach(divEl => {
            const allowed = val && divEl.dataset.showIfStatus.split(',').includes(val);
            if (allowed) {
              divEl.classList.remove('field-hidden');
            } else {
              divEl.classList.add('field-hidden');
            }
            divEl.querySelectorAll('input').forEach(inp => {
              if (allowed) {
                inp.removeAttribute('disabled');
              } else {
                inp.value = '';
                inp.setAttribute('disabled', 'disabled');
              }
            });
          });
        };
        statusField.addEventListener('change', toggleConditional);
        toggleConditional();
      }
    }

    function gerarCodigoVoucher() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s = '';
      for (let i = 0; i < 10; i++) s += chars[Math.floor(Math.random()*chars.length)];
      return 'ZEF-' + s;
    }

    async function salvarItem(e) {
      e.preventDefault();
      const form = document.getElementById('modalForm');
      const inputs = form.querySelectorAll('input, textarea, select');
      const record = {};

      inputs.forEach(input => {
        if (!input.name) return;
        if (input.name.endsWith('[]')) {
          const base = input.name.slice(0, -2);
          if (!record[base]) record[base] = [];
          if (input.checked) record[base].push(input.value);
        } else if (input.type === 'checkbox') {
          record[input.name] = input.checked ? input.value : '';
        } else {
          record[input.name] = input.value;
        }
      });

      if (itemEdit && itemEdit.id) record.id = itemEdit.id;
      if (Array.isArray(record.amenities)) {
        record.amenities = record.amenities.map(v => parseInt(v, 10)).filter(Boolean);
      }
      if (sec === 'rooms' && record.facilitated_access !== undefined) {
        record.facilitated_access = parseInt(record.facilitated_access, 10) || 0;
      }

      Object.keys(record).forEach(chave => {
        if (/cpf/i.test(chave) && record[chave]) {
          record[chave] = somenteDigitos(record[chave]).slice(0, 11);
        }
        if (/(phone|telefone|whatsapp)/i.test(chave) && record[chave]) {
          record[chave] = somenteDigitos(record[chave]).slice(0, 11);
        }
      });

      try {
        const res = await fetch(`${API_BASE}/apisave.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ table: sec, record })
        });
        const resp = await res.json();
        if (resp.success) {
          const recordId = resp.insertId || record.id;
          if (sec === 'rooms') {
            await uploadFotosSala(recordId);
          }
          fecharModal();
          loadSection(sec);
        } else {
          alert(resp.error || resp.message || 'Erro ao salvar registro.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao conectar com o servidor.');
      }
    }

    async function uploadFotosSala(id) {
      const fileInput = document.getElementById('uploadFotos');
      if (!fileInput || !fileInput.files.length) return;

      const formData = new FormData();
      formData.append('id', id);
      Array.from(fileInput.files).forEach(file => formData.append('files[]', file));

      try {
        const res = await fetch(`${API_BASE}/apiuploadroomphoto.php`, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const json = await res.json();
        if (json.success) {
          fileInput.value = '';
          const modalBody = document.getElementById('modalBody');
          const newPreview = modalBody.querySelector('.new-photos');
          if (newPreview) newPreview.innerHTML = '';
          const existingContainer = modalBody.querySelector('.existing-photos');
          if (existingContainer) {
            if (existingContainer.querySelector('.photo-empty')) {
              existingContainer.innerHTML = '';
            }
            (json.uploaded || []).forEach(src => {
              const thumb = document.createElement('div');
              thumb.className = 'photo-thumb';
              const img = document.createElement('img');
              img.src = src;
              thumb.appendChild(img);
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.innerHTML = '&times;';
              btn.addEventListener('click', () => removerFotoSala(src, thumb, existingContainer));
              thumb.appendChild(btn);
              existingContainer.appendChild(thumb);
            });
          }
          if (itemEdit && itemEdit.id == id) {
            itemEdit.photo_path = json.photo_path || '';
          }
          const idx = dadosJSON.findIndex(r => r.id == id);
          if (idx !== -1) dadosJSON[idx].photo_path = json.photo_path || '';
        } else {
          console.warn('Falha no upload:', json.error || json.message);
        }
      } catch (err) {
        console.error('Erro ao enviar fotos:', err);
      }
    }

    async function removerFotoSala(photoPath, thumbEl, container) {
      if (!itemEdit || !itemEdit.id) {
        alert('Selecione uma sala antes de remover fotos.');
        return;
      }
      if (!confirm('Deseja remover esta foto?')) return;

      try {
        const res = await fetch(`${API_BASE}/apidelete_room_photo.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ roomId: itemEdit.id, photo: photoPath })
        });
        const json = await res.json();
        if (json.success) {
          if (thumbEl && thumbEl.parentElement) thumbEl.remove();
          if (container && !container.querySelector('.photo-thumb')) {
            container.innerHTML = '<div class="photo-empty">Nenhuma foto cadastrada.</div>';
          }
          itemEdit.photo_path = json.photo_path || '';
          const idx = dadosJSON.findIndex(r => r.id == itemEdit.id);
          if (idx !== -1) dadosJSON[idx].photo_path = itemEdit.photo_path;
        } else {
          alert(json.error || 'Não foi possível remover a foto.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao remover foto.');
      }
    }

    async function excluirItem(id) {
      try {
        const res = await fetch(`${API_BASE}/apidelete.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ table: sec, id })
        });
        const json = await res.json();
        if (json.success) {
          loadSection(sec);
        } else {
          alert(json.error || 'Erro ao excluir registro.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao excluir registro.');
      }
    }

    let reservasModalSalaId = null;
    const reservasModalEl = document.getElementById('reservasModal');
    const reservasListaEl = document.getElementById('reservasLista');
    const reservasModalTitle = document.getElementById('reservasModalTitle');

    function abrirChamadaReservas(roomId) {
      const roomData = dadosJSON.find(r => r.id == roomId) || {};
      reservasModalSalaId = roomId;
      reservasModalEl.classList.add('show');
      reservasModalTitle.textContent = `Reservas da sala ${roomData.name || `#${roomId}`}`;
      reservasListaEl.innerHTML = '<div class="reservations-empty">Carregando reservas...</div>';
      carregarReservasSala(roomId, reservasListaEl);
    }

    function fecharReservasModal() {
      reservasModalSalaId = null;
      reservasModalEl.classList.remove('show');
      if (reservasListaEl) {
        reservasListaEl.innerHTML = '<div class="reservations-empty">Selecione uma sala para visualizar as reservas.</div>';
      }
    }

    async function carregarReservasSala(roomId, targetList) {
      const list = targetList || reservasListaEl;
      if (!list) return;
      try {
        const res = await fetch(`${API_BASE}/room_reservations.php?room_id=${roomId}`, { credentials: 'include' });
        const json = await res.json();
        if (json.success) {
          renderReservasSala(json.data || [], list, roomId);
        } else {
          list.innerHTML = `<div class="reservations-empty">${escapeHtml(json.error || 'Não foi possível carregar as reservas.')}</div>`;
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = '<div class="reservations-empty">Erro ao carregar reservas.</div>';
      }
    }

    function renderReservasSala(reservas, targetList, roomId) {
      if (!targetList) return;
      if (!reservas.length) {
        targetList.innerHTML = '<div class="reservations-empty">Nenhuma reserva encontrada.</div>';
        return;
      }
      targetList.innerHTML = '';
      reservas.forEach(reserva => {
        const item = document.createElement('div');
        item.className = 'reservation-item';

        const periodo = `${formatDate(reserva.date) || '-'}${reserva.time_start ? ' • ' + formatTime(reserva.time_start) : ''}${reserva.time_end ? ' - ' + formatTime(reserva.time_end) : ''}`;
        item.innerHTML = `
          <div><strong>${escapeHtml(periodo)}</strong></div>
          <div>Cliente: ${escapeHtml(reserva.client_name || '---')}</div>
          <div>Status: ${escapeHtml(statusLabels[reserva.status] || reserva.status || '-')}</div>
          ${reserva.title ? `<div>Título: ${escapeHtml(reserva.title)}</div>` : ''}
          ${reserva.description ? `<div>${escapeHtml(reserva.description)}</div>` : ''}
          ${reserva.notes ? `<div>Notas: ${escapeHtml(reserva.notes)}</div>` : ''}
        `;

        const actions = document.createElement('div');
        actions.className = 'reservation-actions';

        if (reserva.status === 'pendente') {
          const confirmar = document.createElement('button');
          confirmar.className = 'btn-res';
          confirmar.type = 'button';
          confirmar.textContent = 'Confirmar';
          confirmar.onclick = () => alterarStatusReserva(reserva.id, 'confirm', roomId || reserva.room_id);
          actions.appendChild(confirmar);

          const negar = document.createElement('button');
          negar.className = 'btn-res secondary';
          negar.type = 'button';
          negar.textContent = 'Negar';
          negar.onclick = () => alterarStatusReserva(reserva.id, 'deny', roomId || reserva.room_id);
          actions.appendChild(negar);
        } else if (reserva.status === 'confirmada') {
          const cancelar = document.createElement('button');
          cancelar.className = 'btn-res warning';
          cancelar.type = 'button';
          cancelar.textContent = 'Cancelar';
          cancelar.onclick = () => alterarStatusReserva(reserva.id, 'cancel', roomId || reserva.room_id);
          actions.appendChild(cancelar);
        }

        if (actions.children.length) {
          item.appendChild(actions);
        }

        targetList.appendChild(item);
      });
    }

    async function alterarStatusReserva(id, action, roomId) {
      if (!id) return;
      if (action === 'deny' && !confirm('Deseja negar esta reserva?')) return;
      if (action === 'cancel' && !confirm('Deseja cancelar esta reserva?')) return;
      try {
        const res = await fetch(`${API_BASE}/update_reservation_status.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ id, action })
        });
        const json = await res.json();
        if (json.success) {
          if (sec === 'reservations') {
            loadSection('reservations');
          }
          const alvo = roomId || reservasModalSalaId;
          if (alvo) {
            carregarReservasSala(alvo, reservasListaEl);
          }
        } else {
          alert(json.error || 'Não foi possível atualizar o status.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao atualizar status.');
      }
    }

    async function resetSenhaCliente(id) {
      if (!id) return;
      if (!confirm('Gerar uma nova senha temporária para este cliente?')) return;
      try {
        const res = await fetch(`${API_BASE}/admin_reset_client_password.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ client_id: id })
        });
        const json = await res.json();
        if (json.success) {
          alert(`Senha temporária gerada: ${json.newPassword}\nO cliente será avisado por e-mail.`);
        } else {
          alert(json.error || 'Não foi possível resetar a senha.');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao resetar a senha.');
      }
    }

    async function geocodificarSalaAtual(roomId) {
      if (!roomId) return;
      if (!confirm('Tentar localizar esta sala no mapa usando o endereço?')) return;
      try {
        const res = await fetch(`${API_BASE}/geocode_room.php`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room_id: roomId }) });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao geocodificar.');
        alert('Localização atualizada com sucesso.');
      } catch (e) { alert(e.message || 'Erro ao geocodificar.'); }
    }

    async function listarClientesEmpresa(id, nome) {
      companyClientsCompanyId = id;
      companyClientsTitle.textContent = `Clientes de ${nome}`;
      companyClientsList.innerHTML = '<div class="reservations-empty">Carregando...</div>';
      companyClientsModal.classList.add('show');
      try {
        const [cRes, iRes] = await Promise.all([
          fetch(`${API_BASE}/apiget.php?table=clients&company_id=${id}`, { credentials:'include' }),
          fetch(`${API_BASE}/apiget.php?table=company_invitations&company_id=${id}`, { credentials:'include' })
        ]);
        const cJson = await cRes.json();
        const iJson = await iRes.json();
        const clients = cJson.success ? (cJson.data || []) : [];
        const invites = iJson.success ? (iJson.data || []) : [];
        renderCompanyClients(clients, invites);
      } catch (err) {
        console.error(err);
        companyClientsList.innerHTML = `<div class="reservations-empty">${escapeHtml(err.message)}</div>`;
      }
    }

    function renderCompanyClients(lista, invites) {
      const rows = (lista || []).map(client => {
        const statusHtml = statusFormatter(client.status);
        const role = client.company_role || '-';
        return `
          <tr>
            <td>${escapeHtml(client.name || '--')}</td>
            <td>${escapeHtml(client.email || '--')}</td>
            <td>${escapeHtml(client.login || '--')}</td>
            <td>${escapeHtml(role)}</td>
            <td>${statusHtml}</td>
            <td>
              <button class=\"btn-micro confirm\" onclick=\"definirMasterEmpresa(${companyClientsCompanyId},${client.id})\">Master</button>
              <button class=\"btn-micro cancel\" onclick=\"removerUsuarioEmpresa(${companyClientsCompanyId},${client.id})\">Remover</button>
            </td>
          </tr>
        `;
      }).join('');

      const invRows = (invites || []).map(i => {
        const created = i.created_at ? String(i.created_at).slice(0,10).split('-').reverse().join('/') : '-';
        const statusLower = String(i.status||'').toLowerCase();
        const canCancel = statusLower === 'pendente';
        const canResend = statusLower === 'pendente' || statusLower === 'expirado';
        const actions = `
          ${canResend ? `<button class=\"btn-micro confirm\" onclick=\"adminReenviarConvite(${i.id}, ${companyClientsCompanyId})\">Reenviar</button>` : ''}
          ${canCancel ? `<button class=\"btn-micro cancel\" onclick=\"adminCancelarConvite(${i.id}, ${companyClientsCompanyId})\">Cancelar</button>` : ''}
        `;
        const email = i.invite_email || '';
        return `<tr><td>${escapeHtml(i.cpf || '')}</td><td>${escapeHtml(email)}</td><td>${escapeHtml(i.role || 'membro')}</td><td>${escapeHtml(i.status || 'pendente')}</td><td>${created}</td><td>${actions}</td></tr>`;
      }).join('');

      companyClientsList.innerHTML = `
        <div style=\"margin-bottom:12px;display:flex;gap:8px;align-items:center\">
          <input id=\"cpfAddEmpresa\" type=\"text\" placeholder=\"CPF do cliente\" oninput=\"this.value=this.value.replace(/[^0-9.\-]/g,'')\" style=\"padding:8px 10px;border:1px solid #ccc;border-radius:6px\" />
          <select id=\"roleAddEmpresa\" style=\"padding:8px 10px;border:1px solid #ccc;border-radius:6px\">
            <option value=\"membro\">Membro</option>
            <option value=\"gestor\">Gestor</option>
            <option value=\"leitor\">Leitor</option>
            <option value=\"admin\">Admin</option>
          </select>
          <button class=\"btn-ghost\" onclick=\"convidarUsuarioEmpresa()\">Convidar por CPF</button>
        </div>
        ${rows ? `
        <table>
          <thead>
            <tr><th>Nome</th><th>E-mail</th><th>Login</th><th>Papel</th><th>Status</th><th>Ações</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>` : '<div class=\\"reservations-empty\\">Nenhum cliente vinculado.</div>'}
        <h4 style=\"margin:14px 0 6px\">Convites</h4>
        ${invRows ? `
        <table>
          <thead><tr><th>CPF</th><th>E-mail</th><th>Papel</th><th>Status</th><th>Enviado em</th><th>Ações</th></tr></thead>
          <tbody>${invRows}</tbody>
        </table>` : '<div class=\\"reservations-empty\\">Nenhum convite emitido.</div>'}
      `;
    }

    async function definirMasterEmpresa(companyId, clientId) {
      if (!companyId || !clientId) return;
      if (!confirm('Definir este cliente como usuário master da empresa?')) return;
      try {
        const res = await fetch(`${API_BASE}/company_set_master.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ company_id: companyId, client_id: clientId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao definir master');
        alert(json.message || 'Usuário master definido.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ', ''));
      } catch (e) {
        console.error(e);
        alert(e.message || 'Erro ao definir master');
      }
    }

    function fecharCompanyModal() {
      companyClientsModal.classList.remove('show');
    }

    companyClientsModal.addEventListener('click', (event) => {
      if (event.target === companyClientsModal) fecharCompanyModal();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      const modalPrincipal = document.getElementById('modal');
      if (reservasModalEl.classList.contains('show')) {
        fecharReservasModal();
      } else if (companyClientsModal.classList.contains('show')) {
        fecharCompanyModal();
      } else if (modalPrincipal.classList.contains('show')) {
        fecharModal();
      }
    });

    async function convidarUsuarioEmpresa(){
      const cpfEl = document.getElementById('cpfAddEmpresa');
      const roleEl = document.getElementById('roleAddEmpresa');
      const cpf = (cpfEl?.value || '').replace(/\D/g,'');
      const role = roleEl?.value || 'membro';
      if (!companyClientsCompanyId) { alert('Empresa não definida.'); return; }
      if (cpf.length !== 11) { alert('Informe um CPF válido.'); return; }
      try {
        const res = await fetch(`${API_BASE}/company_invite_user.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ company_id: companyClientsCompanyId, cpf, role })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Não foi possível enviar o convite.');
        alert(json.message || 'Convite enviado.');
      } catch (e) {
        console.error(e); alert(e.message || 'Falha ao convidar.');
      }
    }

    async function removerUsuarioEmpresa(companyId, clientId){
      if (!confirm('Remover o vínculo deste usuário com a empresa?')) return;
      try {
        const res = await fetch(`${API_BASE}/company_remove_user.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ company_id: companyId, client_id: clientId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Não foi possível remover.');
        alert(json.message || 'Removido.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ',''));
      } catch (e) {
        console.error(e); alert(e.message || 'Erro ao remover.');
      }
    }

    async function adminCancelarConvite(inviteId, companyId){
      if (!confirm('Cancelar este convite?')) return;
      try {
        const res = await fetch(`${API_BASE}/company_cancel_invite.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ id: inviteId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao cancelar.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ',''));
      } catch (e) {
        alert(e.message || 'Erro ao cancelar convite.');
      }
    }

    async function adminReenviarConvite(inviteId, companyId){
      try {
        const res = await fetch(`${API_BASE}/company_resend_invite.php`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
          body: JSON.stringify({ id: inviteId })
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Falha ao reenviar.');
        alert(json.message || 'Convite reenviado.');
        listarClientesEmpresa(companyId, companyClientsTitle.textContent.replace('Clientes de ',''));
      } catch (e) {
        alert(e.message || 'Erro ao reenviar convite.');
      }
    }

  </script>
</body>
</html>
